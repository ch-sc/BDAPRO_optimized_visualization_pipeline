!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.vl={})}(this,function(e){"use strict";function t(e,t,n){return e.fields=t||[],e.fname=n,e}function c(e){throw Error(e)}function a(e){var t,n,r,i=[],o=null,a=0,u=e.length,s="";function l(){i.push(s+e.substring(t,n)),s="",t=n+1}for(e+="",t=n=0;n<u;++n)if("\\"===(r=e[n]))s+=e.substring(t,n),t=++n;else if(r===o)l(),o=null,a=-1;else{if(o)continue;t===a&&'"'===r?(t=n+1,o=r):t===a&&"'"===r?(t=n+1,o=r):"."!==r||a?"["===r?(t<n&&l(),a=t=n+1):"]"===r&&(a||c("Access path missing open bracket: "+e),0<a&&l(),a=0,t=n+1):t<n?l():t=n+1}return a&&c("Access path missing closing bracket: "+e),o&&c("Access path missing closing quote: "+e),t<n&&(n++,l()),i}var w=Array.isArray;function ee(e){return e===Object(e)}function m(e){return"string"==typeof e}function v(e){return w(e)?"["+e.map(v)+"]":ee(e)||m(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e}var n,r,i,o,u=[];i=a(n="id"),o="return _["+i.map(v).join("][")+"];",t(Function("_",o),[n=1===i.length?i[0]:n],r||n),t(function(e){return e},u,"identity"),t(function(){return 0},u,"zero"),t(function(){return 1},u,"one"),t(function(){return!0},u,"true"),t(function(){return!1},u,"false");function s(e,t,n){var r=[t].concat([].slice.call(n));console[e].apply(console,r)}function l(e){return"boolean"==typeof e}function te(e){return"number"==typeof e}function f(e){for(var t={},n=0,r=e.length;n<r;++n)t[e[n]]=!0;return t}var d=function(e,t){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function h(e,t){function n(){this.constructor=e}d(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var ne=function(){return(ne=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function re(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&(n[r[i]]=e[r[i]])}return n}var p,g,y,b,x=Array.isArray,S=Object.keys,E=Object.prototype.hasOwnProperty,k={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},C=function(e){throw{name:"SyntaxError",message:e,at:p,text:y}},N=function(e){return e&&e!==g&&C("Expected '"+e+"' instead of '"+g+"'"),g=y.charAt(p),p+=1,g},O=function(){var e,t="";for("-"===g&&N(t="-");"0"<=g&&g<="9";)t+=g,N();if("."===g)for(t+=".";N()&&"0"<=g&&g<="9";)t+=g;if("e"===g||"E"===g)for(t+=g,N(),"-"!==g&&"+"!==g||(t+=g,N());"0"<=g&&g<="9";)t+=g,N();if(e=+t,isFinite(e))return e;C("Bad number")},A=function(){var e,t,n,r="";if('"'===g)for(;N();){if('"'===g)return N(),r;if("\\"===g)if(N(),"u"===g){for(t=n=0;t<4&&(e=parseInt(N(),16),isFinite(e));t+=1)n=16*n+e;r+=String.fromCharCode(n)}else{if("string"!=typeof k[g])break;r+=k[g]}else r+=g}C("Bad string")},_=function(){for(;g&&g<=" ";)N()};b=function(){switch(_(),g){case"{":return function(){var e,t={};if("{"===g){if(N("{"),_(),"}"===g)return N("}"),t;for(;g;){if(e=A(),_(),N(":"),Object.hasOwnProperty.call(t,e)&&C('Duplicate key "'+e+'"'),t[e]=b(),_(),"}"===g)return N("}"),t;N(","),_()}}C("Bad object")}();case"[":return function(){var e=[];if("["===g){if(N("["),_(),"]"===g)return N("]"),e;for(;g;){if(e.push(b()),_(),"]"===g)return N("]"),e;N(","),_()}}C("Bad array")}();case'"':return A();case"-":return O();default:return"0"<=g&&g<="9"?O():function(){switch(g){case"t":return N("t"),N("r"),N("u"),N("e"),!0;case"f":return N("f"),N("a"),N("l"),N("s"),N("e"),!1;case"n":return N("n"),N("u"),N("l"),N("l"),null}C("Unexpected '"+g+"'")}()}};var T,D,z,F=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,I={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function R(e){return F.lastIndex=0,F.test(e)?'"'+e.replace(F,function(e){var t=I[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}var L="undefined"!=typeof JSON?JSON:{parse:function(e,a){var t;return y=e,p=0,g=" ",t=b(),_(),g&&C("Syntax error"),"function"==typeof a?function e(t,n){var r,i,o=t[n];if(o&&"object"==typeof o)for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(void 0!==(i=e(o,r))?o[r]=i:delete o[r]);return a.call(t,n,o)}({"":t},""):t},stringify:function(e,t,n){var r;if(D=T="","number"==typeof n)for(r=0;r<n;r+=1)D+=" ";else"string"==typeof n&&(D=n);if((z=t)&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return function e(t,n){var r,i,o,a,u,s=T,l=n[t];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(t)),"function"==typeof z&&(l=z.call(n,t,l)),typeof l){case"string":return R(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(T+=D,u=[],"[object Array]"===Object.prototype.toString.apply(l)){for(a=l.length,r=0;r<a;r+=1)u[r]=e(r,l)||"null";return o=0===u.length?"[]":T?"[\n"+T+u.join(",\n"+T)+"\n"+s+"]":"["+u.join(",")+"]",T=s,o}if(z&&"object"==typeof z)for(a=z.length,r=0;r<a;r+=1)"string"==typeof(i=z[r])&&(o=e(i,l))&&u.push(R(i)+(T?": ":":")+o);else for(i in l)Object.prototype.hasOwnProperty.call(l,i)&&(o=e(i,l))&&u.push(R(i)+(T?": ":":")+o);return o=0===u.length?"{}":T?"{\n"+T+u.join(",\n"+T)+"\n"+s+"}":"{"+u.join(",")+"}",T=s,o}}("",{"":e})}},j=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var p=t.space||"";"number"==typeof p&&(p=Array(p+1).join(" "));var o,h="boolean"==typeof t.cycles&&t.cycles,m=t.replacer||function(e,t){return t},g=t.cmp&&(o=t.cmp,function(i){return function(e,t){var n={key:e,value:i[e]},r={key:t,value:i[t]};return o(n,r)}}),v=[];return function e(t,n,r,i){var o=p?"\n"+new Array(i+1).join(p):"",a=p?": ":":";if(r&&r.toJSON&&"function"==typeof r.toJSON&&(r=r.toJSON()),void 0!==(r=m.call(t,n,r))){if("object"!=typeof r||null===r)return L.stringify(r);if(U(r)){for(var u=[],s=0;s<r.length;s++){var l=e(r,s,r[s],i+1)||L.stringify(null);u.push(o+p+l)}return"["+u.join(",")+o+"]"}if(-1!==v.indexOf(r)){if(h)return L.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}v.push(r);var c=P(r).sort(g&&g(r));for(u=[],s=0;s<c.length;s++){var f=e(r,n=c[s],r[n],i+1);if(f){var d=L.stringify(n)+a+f;u.push(o+p+d)}}return v.splice(v.indexOf(r),1),"{"+u.join(",")+o+"}"}}({"":e},"",e,0)},U=Array.isArray||function(e){return"[object Array]"==={}.toString.call(e)},P=Object.keys||function(e){var t=Object.prototype.hasOwnProperty||function(){return!0},n=[];for(var r in e)t.call(e,r)&&n.push(r);return n};function M(e){return!!e.or}function q(e){return!!e.and}function H(e){return!!e.not}var W=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var r,i,o,a=x(t),u=x(n);if(a&&u){if((i=t.length)!=n.length)return!1;for(r=i;0!=r--;)if(!e(t[r],n[r]))return!1;return!0}if(a!=u)return!1;var s=t instanceof Date,l=n instanceof Date;if(s!=l)return!1;if(s&&l)return t.getTime()==n.getTime();var c=t instanceof RegExp,f=n instanceof RegExp;if(c!=f)return!1;if(c&&f)return t.toString()==n.toString();var d=S(t);if((i=d.length)!==S(n).length)return!1;for(r=i;0!=r--;)if(!E.call(n,d[r]))return!1;for(r=i;0!=r--;)if(!e(t[o=d[r]],n[o]))return!1;return!0}return t!=t&&n!=n};function B(e,t){for(var n={},r=0,i=t;r<i.length;r++){var o=i[r];e.hasOwnProperty(o)&&(n[o]=e[o])}return n}function G(e,t){for(var n=ne({},e),r=0,i=t;r<i.length;r++){delete n[i[r]]}return n}var Y=j;function V(e){if(te(e))return e;var t=m(e)?e:j(e);if(t.length<250)return t;for(var n=0,r=0;r<t.length;r++){n=(n<<5)-n+t.charCodeAt(r),n&=n}return n}function X(e,t){return-1<e.indexOf(t)}function Q(e,t){return e.filter(function(e){return!X(t,e)})}function K(e,t){for(var n=0,r=0;r<e.length;r++)if(t(e[r],r,n++))return!0;return!1}function J(e,t){for(var n=0,r=0;r<e.length;r++)if(!t(e[r],r,n++))return!1;return!0}function Z(e){return[].concat.apply([],e)}function $(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=0,i=t;r<i.length;r++){e=ie(e,i[r])}return e}function ie(e,t){if("object"!=typeof t||null===t)return e;for(var n in t)t.hasOwnProperty(n)&&void 0!==t[n]&&("object"!=typeof t[n]||w(t[n])||null===t[n]?e[n]=t[n]:"object"!=typeof e[n]||null===e[n]?e[n]=$(w(t[n].constructor)?[]:{},t[n]):$(e[n],t[n]));return e}function oe(e,t){for(var n,r=[],i={},o=0,a=e;o<a.length;o++){var u=a[o];(n=t(u))in i||(i[n]=1,r.push(u))}return r}function ae(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t[n]&&e[n]&&t[n]!==e[n])return!0;return!1}function ue(e,t){for(var n in e)if(n in t)return!0;return!1}function se(e){for(var t={},n=function(e){var n=a(e).map(function(e,t){return 0===t?e:"["+e+"]"});n.map(function(e,t){return n.slice(0,t+1).join("")}).forEach(function(e){return t[e]=!0})},r=0,i=ce(e);r<i.length;r++){n(i[r])}return t}function le(e,t){return ue(se(e),se(t))}var ce=Object.keys;function fe(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function de(e){return ce(e)}function pe(e){return JSON.parse(JSON.stringify(e))}function he(e){return!0===e||!1===e}function me(e){var t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function ge(e,t){return H(e)?"!("+ge(e.not,t)+")":q(e)?"("+e.and.map(function(e){return ge(e,t)}).join(") && (")+")":M(e)?"("+e.or.map(function(e){return ge(e,t)}).join(") || (")+")":t(e)}function ve(e,t){if(0===t.length)return!0;var n=t.shift();return ve(e[n],t)&&delete e[n],0===Object.keys(e).length}function ye(e){return e.charAt(0).toUpperCase()+e.substr(1)}function be(e,t){void 0===t&&(t="datum");for(var n=a(e),r=[],i=1;i<=n.length;i++){var o="["+n.slice(0,i).map(v).join("][")+"]";r.push(""+t+o)}return r.join(" && ")}function xe(e,t){return void 0===t&&(t="datum"),t+"["+v(a(e).join("."))+"]"}function Se(e){return""+a(e).map(function(e){return e.replace(".","\\.")}).join("\\.")}function we(e){return""+a(e).join(".")}function Ee(e){return e?a(e).length:0}function ke(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,r=e;n<r.length;n++){var i=r[n];if(void 0!==i)return i}}var Ce=42;function Ne(e){var t=++Ce;return e?String(e)+t:t}var Oe=Object.freeze({deepEqual:W,pick:B,omit:G,stringify:Y,hash:V,contains:X,without:Q,union:function(e,t){return e.concat(Q(t,e))},some:K,every:J,flatten:Z,fill:function(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e;return n},mergeDeep:$,unique:oe,differ:ae,hasIntersection:ue,prefixGenerator:se,fieldIntersection:le,isNumeric:function(e){return!isNaN(e)},differArray:function(e,t){if(e.length!==t.length)return!0;e.sort(),t.sort();for(var n=0;n<e.length;n++)if(t[n]!==e[n])return!0;return!1},keys:ce,vals:fe,entries:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({key:n,value:e[n]});return t},flagKeys:de,duplicate:pe,isBoolean:he,varName:me,logicalExpr:ge,deleteNestedProperty:ve,titlecase:ye,accessPathWithDatum:be,flatAccessWithDatum:xe,replacePathInField:Se,removePathFromField:we,accessPathDepth:Ee,getFirstDefined:ke,uniqueId:Ne,resetIdCounter:function(){Ce=42}}),Ae={argmax:1,argmin:1,average:1,count:1,distinct:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},_e=de(Ae);function Te(e){return!!Ae[e]}var De=["count","valid","missing","distinct"];function ze(e){return e&&X(De,e)}function Fe(e){return e&&X(["min","max"],e)}var Ie=["count","sum","distinct","valid","missing"],Re=["mean","average","median","q1","q3","min","max"],Le=f(Re),je=Object.freeze({AGGREGATE_OPS:_e,isAggregateOp:Te,COUNTING_OPS:De,isCountingAggregateOp:ze,isMinMaxOp:Fe,SUM_OPS:Ie,SHARED_DOMAIN_OPS:Re,SHARED_DOMAIN_OP_INDEX:Le}),Ue=["domain","grid","labels","ticks","title"],Pe={grid:"grid",gridColor:"grid",gridDash:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"main",domain:"main",domainColor:"main",domainOpacity:"main",domainWidth:"main",format:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontWeight:"main",labelLimit:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",maxExtent:"main",minExtent:"main",offset:"main",position:"main",tickColor:"main",tickExtra:"main",tickOffset:"main",tickOpacity:"main",tickRound:"main",ticks:"main",tickSize:"main",title:"main",titleAlign:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontWeight:"main",titleLimit:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",tickWidth:"both",tickCount:"both",values:"both",scale:"both",zindex:"both"},Me={orient:1,bandPosition:1,domain:1,domainColor:1,domainOpacity:1,domainWidth:1,format:1,grid:1,gridColor:1,gridDash:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,maxExtent:1,minExtent:1,offset:1,position:1,tickColor:1,tickCount:1,tickExtra:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,values:1,zindex:1},qe=ne({},Me,{encoding:1,labelAngle:1,tickStep:1});function He(e){return!!qe[e]}var We,Be,Ge,Ye=de(ne({gridScale:1,scale:1},Me,{encode:1})),Ve=de(qe),Xe=Object.freeze({AXIS_PARTS:Ue,AXIS_PROPERTY_TYPE:Pe,isAxisProperty:He,VG_AXIS_PROPERTIES:Ye,AXIS_PROPERTIES:Ve}),Qe=(We=2||0,{level:function(e){return arguments.length?(We=+e,this):We},error:function(){return 1<=We&&s("error","ERROR",arguments),this},warn:function(){return 2<=We&&s("warn","WARN",arguments),this},info:function(){return 3<=We&&s("log","INFO",arguments),this},debug:function(){return 4<=We&&s("log","DEBUG",arguments),this}}),Ke=Qe;function Je(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Ke.warn.apply(Ke,arguments)}(Ge=Be||(Be={})).INVALID_SPEC="Invalid spec",Ge.FIT_NON_SINGLE='Autosize "fit" only works for single views and layered views.',Ge.CANNOT_FIX_RANGE_STEP_WITH_FIT='Cannot use a fixed value of "rangeStep" when "autosize" is "fit".',Ge.cannotProjectOnChannelWithoutField=function(e){return'Cannot project a selection on encoding channel "'+e+'", which has no field.'},Ge.nearestNotSupportForContinuous=function(e){return'The "nearest" transform is not supported for '+e+" marks."},Ge.selectionNotSupported=function(e){return"Selection not supported for "+e+" yet"},Ge.selectionNotFound=function(e){return'Cannot find a selection named "'+e+'"'},Ge.SCALE_BINDINGS_CONTINUOUS="Scale bindings are currently only supported for scales with unbinned, continuous domains.",Ge.noSuchRepeatedValue=function(e){return'Unknown repeated value "'+e+'".'},Ge.CONCAT_CANNOT_SHARE_AXIS="Axes cannot be shared in concatenated views.",Ge.REPEAT_CANNOT_SHARE_AXIS="Axes cannot be shared in repeated views.",Ge.cannotSetTitleAnchor=function(e){return'Cannot set title "anchor" for a '+e+" spec"},Ge.unrecognizedParse=function(e){return'Unrecognized parse "'+e+'".'},Ge.differentParse=function(e,t,n){return'An ancestor parsed field "'+e+'" as '+n+" but a child wants to parse the field as "+t+"."},Ge.invalidTransformIgnored=function(e){return"Ignoring an invalid transform: "+Y(e)+"."},Ge.NO_FIELDS_NEEDS_AS='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.',Ge.encodingOverridden=function(e){return"Layer's shared "+e.join(",")+" channel "+(1===e.length?"is":"are")+" overriden"},Ge.projectionOverridden=function(e){var t=e.parentProjection,n=e.projection;return"Layer's shared projection "+Y(t)+" is overridden by a child projection "+Y(n)+"."},Ge.primitiveChannelDef=function(e,t,n){return"Channel "+e+" is a "+t+". Converted to {value: "+Y(n)+"}."},Ge.invalidFieldType=function(e){return'Invalid field type "'+e+'"'},Ge.nonZeroScaleUsedWithLengthMark=function(e,t,n){return"A "+(n.scaleType?n.scaleType+" scale":n.zeroFalse?"scale with zero=false":"scale with custom domain that excludes zero")+" is used to encode "+e+"'s "+t+". This can be misleading as the "+("x"===t?"width":"height")+" of the "+e+" can be arbitrary based on the scale domain. You may want to use point mark instead."},Ge.invalidFieldTypeForCountAggregate=function(e,t){return'Invalid field type "'+e+'" for aggregate: "'+t+'", using "quantitative" instead.'},Ge.invalidAggregate=function(e){return'Invalid aggregation operator "'+e+'"'},Ge.emptyOrInvalidFieldType=function(e,t,n){return'Invalid field type "'+e+'" for channel "'+t+'", using "'+n+'" instead.'},Ge.droppingColor=function(e,t){var n=t.fill,r=t.stroke;return"Dropping color "+e+" as the plot also has "+(n&&r?"fill and stroke":n?"fill":"stroke")},Ge.emptyFieldDef=function(e,t){return"Dropping "+Y(e)+' from channel "'+t+'" since it does not contain data field or value.'},Ge.latLongDeprecated=function(e,t,n){return e+"-encoding with type "+t+" is deprecated. Replacing with "+n+"-encoding."},Ge.LINE_WITH_VARYING_SIZE="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.",Ge.incompatibleChannel=function(e,t,n){return e+' dropped as it is incompatible with "'+t+'"'+(n?" when "+n:"")+"."},Ge.invalidEncodingChannel=function(e){return e+"-encoding is dropped as "+e+" is not a valid encoding channel."},Ge.facetChannelShouldBeDiscrete=function(e){return e+" encoding should be discrete (ordinal / nominal / binned)."},Ge.discreteChannelCannotEncode=function(e,t){return'Using discrete channel "'+e+'" to encode "'+t+'" field can be misleading as it does not encode '+("ordinal"===t?"order":"magnitude")+"."},Ge.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL="Bar mark should not be used with point scale when rangeStep is null. Please use band scale instead.",Ge.lineWithRange=function(e,t){return"Line mark is for continuous lines and thus cannot be used with "+(e&&t?"x2 and y2":e?"x2":"y2")+". We will use the rule mark (line segments) instead."},Ge.orientOverridden=function(e,t){return'Specified orient "'+e+'" overridden with "'+t+'"'},Ge.CANNOT_UNION_CUSTOM_DOMAIN_WITH_FIELD_DOMAIN="custom domain scale cannot be unioned with default field-based domain",Ge.cannotUseScalePropertyWithNonColor=function(e){return'Cannot use the scale property "'+e+'" with non-color channel.'},Ge.unaggregateDomainHasNoEffectForRawField=function(e){return"Using unaggregated domain with raw field has no effect ("+Y(e)+")."},Ge.unaggregateDomainWithNonSharedDomainOp=function(e){return'Unaggregated domain not applicable for "'+e+'" since it produces values outside the origin domain of the source data.'},Ge.unaggregatedDomainWithLogScale=function(e){return"Unaggregated domain is currently unsupported for log scale ("+Y(e)+")."},Ge.cannotApplySizeToNonOrientedMark=function(e){return'Cannot apply size to non-oriented mark "'+e+'".'},Ge.rangeStepDropped=function(e){return'rangeStep for "'+e+'" is dropped as top-level '+("x"===e?"width":"height")+" is provided."},Ge.scaleTypeNotWorkWithChannel=function(e,t,n){return'Channel "'+e+'" does not work with "'+t+'" scale. We are using "'+n+'" scale instead.'},Ge.scaleTypeNotWorkWithFieldDef=function(e,t){return'FieldDef does not work with "'+e+'" scale. We are using "'+t+'" scale instead.'},Ge.scalePropertyNotWorkWithScaleType=function(e,t,n){return n+"-scale's \""+t+'" is dropped as it does not work with '+e+" scale."},Ge.scaleTypeNotWorkWithMark=function(e,t){return'Scale type "'+t+'" does not work with mark "'+e+'".'},Ge.mergeConflictingProperty=function(e,t,n,r){return"Conflicting "+t.toString()+' property "'+e.toString()+'" ('+Y(n)+" and "+Y(r)+").  Using "+Y(n)+"."},Ge.independentScaleMeansIndependentGuide=function(e){return'Setting the scale to be independent for "'+e+'" means we also have to set the guide (axis or legend) to be independent.'},Ge.domainSortDropped=function(e){return"Dropping sort property "+Y(e)+" as unioned domains only support boolean or op 'count'."},Ge.UNABLE_TO_MERGE_DOMAINS="Unable to merge domains",Ge.MORE_THAN_ONE_SORT="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",Ge.INVALID_CHANNEL_FOR_AXIS="Invalid channel for axis.",Ge.cannotStackRangedMark=function(e){return'Cannot stack "'+e+'" if there is already "'+e+'2"'},Ge.cannotStackNonLinearScale=function(e){return"Cannot stack non-linear scale ("+e+")"},Ge.stackNonSummativeAggregate=function(e){return'Stacking is applied even though the aggregate function is non-summative ("'+e+'")'},Ge.invalidTimeUnit=function(e,t){return"Invalid "+e+": "+Y(t)},Ge.dayReplacedWithDate=function(e){return'Time unit "'+e+'" is not supported. We are replacing it with '+e.replace("day","date")+"."},Ge.droppedDay=function(e){return"Dropping day from datetime "+Y(e)+" as day cannot be combined with other units."},Ge.errorBarCenterAndExtentAreNotNeeded=function(e,t){return(t?"extent ":"")+(t&&e?"and ":"")+(e?"center ":"")+(t&&e?"are ":"is ")+"not needed when data are aggregated."},Ge.errorBarCenterIsUsedWithWrongExtent=function(e,t,n){return e+" is not usually used with "+t+" for "+n+"."},Ge.errorBarContinuousAxisHasCustomizedAggregate=function(e,t){return"Continuous axis should not have customized aggregation function "+e+"; "+t+" already agregates the axis."},Ge.errorBarCenterIsNotNeeded=function(e,t){return"Center is not needed to be specified in "+t+" when extent is "+e+"."},Ge.errorBand1DNotSupport=function(e){return"1D error band does not support "+e},Ge.channelRequiredForBinned=function(e){return"Channel "+e+' is required for "binned" bin'},Ge.domainRequiredForThresholdScale=function(e){return"Domain for "+e+" is required for threshold scale"};var Ze=2006;function $e(e){return!!(e&&(e.year||e.quarter||e.month||e.date||e.day||e.hours||e.minutes||e.seconds||e.milliseconds))}var et=["january","february","march","april","may","june","july","august","september","october","november","december"],tt=et.map(function(e){return e.substr(0,3)}),nt=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],rt=nt.map(function(e){return e.substr(0,3)});function it(e,t){void 0===t&&(t=!1);var n=[];if(t&&void 0!==e.day&&1<ce(e).length&&(Je(Be.droppedDay(e)),delete(e=pe(e)).day),void 0!==e.year?n.push(e.year):void 0!==e.day?n.push(Ze):n.push(0),void 0!==e.month){var r=t?function(e){if(te(e))return(e-1).toString();var t=e.toLowerCase(),n=et.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=tt.indexOf(r);if(-1!==i)return i+"";throw new Error(Be.invalidTimeUnit("month",e))}(e.month):e.month;n.push(r)}else if(void 0!==e.quarter){var i=t?function(e){if(te(e))return 4<e&&Je(Be.invalidTimeUnit("quarter",e)),(e-1).toString();throw new Error(Be.invalidTimeUnit("quarter",e))}(e.quarter):e.quarter;n.push(i+"*3")}else n.push(0);if(void 0!==e.date)n.push(e.date);else if(void 0!==e.day){var o=t?function(e){if(te(e))return e%7+"";var t=e.toLowerCase(),n=nt.indexOf(t);if(-1!==n)return n+"";var r=t.substr(0,3),i=rt.indexOf(r);if(-1!==i)return i+"";throw new Error(Be.invalidTimeUnit("day",e))}(e.day):e.day;n.push(o+"+1")}else n.push(1);for(var a=0,u=["hours","minutes","seconds","milliseconds"];a<u.length;a++){var s=u[a];void 0!==e[s]?n.push(e[s]):n.push(0)}return e.utc?"utc("+n.join(", ")+")":"datetime("+n.join(", ")+")"}var ot=Object.freeze({isDateTime:$e,MONTHS:et,SHORT_MONTHS:tt,DAYS:nt,SHORT_DAYS:rt,dateTimeExpr:it});function at(e){return!!e&&!!e.header}var ut,st,lt=Object.freeze({isFacetFieldDef:at});(st=ut||(ut={})).YEAR="year",st.MONTH="month",st.DAY="day",st.DATE="date",st.HOURS="hours",st.MINUTES="minutes",st.SECONDS="seconds",st.MILLISECONDS="milliseconds",st.YEARMONTH="yearmonth",st.YEARMONTHDATE="yearmonthdate",st.YEARMONTHDATEHOURS="yearmonthdatehours",st.YEARMONTHDATEHOURSMINUTES="yearmonthdatehoursminutes",st.YEARMONTHDATEHOURSMINUTESSECONDS="yearmonthdatehoursminutesseconds",st.MONTHDATE="monthdate",st.HOURSMINUTES="hoursminutes",st.HOURSMINUTESSECONDS="hoursminutesseconds",st.MINUTESSECONDS="minutesseconds",st.SECONDSMILLISECONDS="secondsmilliseconds",st.QUARTER="quarter",st.YEARQUARTER="yearquarter",st.QUARTERMONTH="quartermonth",st.YEARQUARTERMONTH="yearquartermonth",st.UTCYEAR="utcyear",st.UTCMONTH="utcmonth",st.UTCDAY="utcday",st.UTCDATE="utcdate",st.UTCHOURS="utchours",st.UTCMINUTES="utcminutes",st.UTCSECONDS="utcseconds",st.UTCMILLISECONDS="utcmilliseconds",st.UTCYEARMONTH="utcyearmonth",st.UTCYEARMONTHDATE="utcyearmonthdate",st.UTCYEARMONTHDATEHOURS="utcyearmonthdatehours",st.UTCYEARMONTHDATEHOURSMINUTES="utcyearmonthdatehoursminutes",st.UTCYEARMONTHDATEHOURSMINUTESSECONDS="utcyearmonthdatehoursminutesseconds",st.UTCMONTHDATE="utcmonthdate",st.UTCHOURSMINUTES="utchoursminutes",st.UTCHOURSMINUTESSECONDS="utchoursminutesseconds",st.UTCMINUTESSECONDS="utcminutesseconds",st.UTCSECONDSMILLISECONDS="utcsecondsmilliseconds",st.UTCQUARTER="utcquarter",st.UTCYEARQUARTER="utcyearquarter",st.UTCQUARTERMONTH="utcquartermonth",st.UTCYEARQUARTERMONTH="utcyearquartermonth";var ct={year:1,quarter:1,month:1,day:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},ft=de(ct);function dt(e){return!!ct[e]}var pt={utcyear:1,utcquarter:1,utcmonth:1,utcday:1,utcdate:1,utchours:1,utcminutes:1,utcseconds:1,utcmilliseconds:1};function ht(e){return!!pt[e]}var mt={utcyearquarter:1,utcyearquartermonth:1,utcyearmonth:1,utcyearmonthdate:1,utcyearmonthdatehours:1,utcyearmonthdatehoursminutes:1,utcyearmonthdatehoursminutesseconds:1,utcquartermonth:1,utcmonthdate:1,utchoursminutes:1,utchoursminutesseconds:1,utcminutesseconds:1,utcsecondsmilliseconds:1},gt=ne({},pt,mt);function vt(e){return!!gt[e]}function yt(e){return e.substr(3)}var bt=ne({},ct,pt,{yearquarter:1,yearquartermonth:1,yearmonth:1,yearmonthdate:1,yearmonthdatehours:1,yearmonthdatehoursminutes:1,yearmonthdatehoursminutesseconds:1,quartermonth:1,monthdate:1,hoursminutes:1,hoursminutesseconds:1,minutesseconds:1,secondsmilliseconds:1},mt),xt=de(bt);var St={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",quarter:null,day:null};function wt(e,t){var n=St[e];return{setDateMethod:t?"setUTC"+n.substr(3):n,getDateMethod:"get"+(t?"UTC":"")+n.substr(3)}}function Et(n){return ft.reduce(function(e,t){return kt(n,t)?e.concat(t):e},[])}function kt(e,t){var n=e.indexOf(t);return-1<n&&(t!==ut.SECONDS||0===n||"i"!==e.charAt(n-1))}function Ct(r,e){var i=be(e),o=vt(r)?"utc":"";return it(ft.reduce(function(e,t){var n;return kt(r,t)&&(e[t]=(n=t)===ut.QUARTER?"("+o+"quarter("+i+")-1)":""+o+n+"("+i+")"),e},{}))}function Nt(e,t){if(e){var n=[],r=kt(e,ut.YEAR);kt(e,ut.MONTH)&&n.push(!1!==t?"%b":"%B"),kt(e,ut.DAY)?n.push(t?"%a":"%A"):kt(e,ut.DATE)&&n.push("%d"+(r?",":"")),r&&n.push(t?"%y":"%Y");var i=[];kt(e,ut.HOURS)&&i.push("%H"),kt(e,ut.MINUTES)&&i.push("%M"),kt(e,ut.SECONDS)&&i.push("%S"),kt(e,ut.MILLISECONDS)&&i.push("%L");var o=[];return 0<n.length&&o.push(n.join(" ")),0<i.length&&o.push(i.join(":")),o}}function Ot(e,t,n,r){if(e){var i=Nt(e,n),o="";return kt(e,ut.QUARTER)&&(o="'Q' + quarter("+t+")"),0<i.length&&(o&&(o+=" + ' ' + "),o+=r?"utcFormat("+t+", '"+i.join(" ")+"')":"timeFormat("+t+", '"+i.join(" ")+"')"),o||void 0}}function At(e){return"day"!==e&&0<=e.indexOf("day")?(Je(Be.dayReplacedWithDate(e)),e.replace("day","date")):e}var _t,Tt,Dt=Object.freeze({get TimeUnit(){return ut},TIMEUNIT_PARTS:ft,isLocalSingleTimeUnit:dt,isUtcSingleTimeUnit:ht,isUTCTimeUnit:vt,getLocalTimeUnit:yt,TIMEUNITS:xt,isTimeUnit:function(e){return!!bt[e]},convert:function(e,t){for(var n=vt(e),r=n?new Date(Date.UTC(0,0,1,0,0,0,0)):new Date(0,0,1,0,0,0,0),i=0,o=ft;i<o.length;i++){var a=o[i];if(kt(e,a))switch(a){case ut.DAY:throw new Error("Cannot convert to TimeUnits containing 'day'");case ut.QUARTER:var u=wt("month",n),s=u.getDateMethod;r[u.setDateMethod](3*Math.floor(t[s]()/3));break;default:var l=wt(a,n),c=l.getDateMethod;r[l.setDateMethod](t[c]())}}return r},getTimeUnitParts:Et,containsTimeUnit:kt,fieldExpr:Ct,getDateTimeComponents:Nt,formatExpression:Ot,normalizeTimeUnit:At});(Tt=_t||(_t={})).QUANTITATIVE="quantitative",Tt.ORDINAL="ordinal",Tt.TEMPORAL="temporal",Tt.NOMINAL="nominal",Tt.GEOJSON="geojson";var zt={quantitative:1,ordinal:1,temporal:1,nominal:1,geojson:1};var Ft=_t.QUANTITATIVE,It=_t.ORDINAL,Rt=_t.TEMPORAL,Lt=_t.NOMINAL,jt=_t.GEOJSON;function Ut(e){if(e)switch(e=e.toLowerCase()){case"q":case Ft:return"quantitative";case"t":case Rt:return"temporal";case"o":case It:return"ordinal";case"n":case Lt:return"nominal";case jt:return"geojson"}}var Pt=Object.freeze({get Type(){return _t},TYPE_INDEX:zt,isType:function(e){return!!zt[e]},QUANTITATIVE:Ft,ORDINAL:It,TEMPORAL:Rt,NOMINAL:Lt,GEOJSON:jt,getFullName:Ut});function Mt(e){return e.selection}function qt(e){return e&&!m(e)&&"repeat"in e}function Ht(e){var t=e.field,n=e.timeUnit,r=e.bin,i=e.aggregate;return ne({},n?{timeUnit:n}:{},r?{bin:r}:{},i?{aggregate:i}:{},{field:t})}function Wt(e){return!!e&&!!e.condition}function Bt(e){return!!e&&!!e.condition&&!w(e.condition)&&Yt(e.condition)}function Gt(e){return!!e&&!!e.condition&&(w(e.condition)||Xt(e.condition))}function Yt(e){return!(!e||!e.field&&"count"!==e.aggregate)}function Vt(e){return Yt(e)&&m(e.field)}function Xt(e){return e&&"value"in e&&void 0!==e.value}function Qt(e){return!(!e||!e.scale&&!e.sort)}function Kt(e){return!(!e||!e.axis&&!e.stack&&!e.impute)}function Jt(e){return!!e&&!!e.legend}function Zt(e){return!!e&&!!e.format}function $t(e,t){void 0===t&&(t={});var n=e.field,r=t.prefix,i=t.suffix;if(nn(e))n="count_*";else{var o=void 0;t.nofn||(e.op?o=e.op:Qr(e.bin)?(o=Xr(e.bin),i=t.binSuffix||""):e.aggregate?o=String(e.aggregate):e.timeUnit&&(o=String(e.timeUnit))),o&&(n=n?o+"_"+n:o)}return i&&(n=n+"_"+i),r&&(n=r+"_"+n),t.forAs?n:t.expr?xe(n,t.expr):Se(n)}function en(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return!!e.bin;case"temporal":return!1}throw new Error(Be.invalidFieldType(e.type))}function tn(e){return!en(e)}function nn(e){return"count"===e.aggregate}function rn(e,t){var n=e.field,r=e.bin,i=e.timeUnit,o=e.aggregate;return"count"===o?t.countTitle:Qr(r)?n+" (binned)":i?n+" ("+Et(i).join("-")+")":o?ye(o)+" of "+n:n}function on(e,t){var n=e.aggregate||e.timeUnit||Qr(e.bin)&&"bin";return n?n.toUpperCase()+"("+e.field+")":e.field}var an=function(e,t){switch(t.fieldTitle){case"plain":return e.field;case"functional":return on(e);default:return rn(e,t)}},un=an;function sn(e){un=e}function ln(){sn(an)}function cn(e,t,n){var r=n.allowDisabling,i=(fn(e)||{}).title;return r?ke(i,e.title,dn(e,t)):i||e.title||dn(e,t)}function fn(e){return Kt(e)&&e.axis?e.axis:Jt(e)&&e.legend?e.legend:at(e)&&e.header?e.header:void 0}function dn(e,t){return un(e,t)}function pn(e){return Zt(e)&&e.format?e.format:(fn(e)||{}).format}function hn(e,t){if(e.timeUnit)return"temporal";if(Qr(e.bin))return"quantitative";switch(Yr(t)){case"continuous":return"quantitative";case"discrete":case"flexible":return"nominal";default:return"quantitative"}}function mn(e){return Yt(e)?e:Bt(e)?e.condition:void 0}function gn(e,t){if(m(e)||te(e)||l(e)){var n=m(e)?"string":te(e)?"number":"boolean";return Je(Be.primitiveChannelDef(t,n,e)),{value:e}}return Yt(e)?vn(e,t):Bt(e)?ne({},e,{condition:vn(e.condition,t)}):e}function vn(e,t){if(e.aggregate&&!Te(e.aggregate)){e.aggregate;var n=re(e,["aggregate"]);Je(Be.invalidAggregate(e.aggregate)),e=n}if(e.timeUnit&&(e=ne({},e,{timeUnit:At(e.timeUnit)})),Qr(e.bin)&&(e=ne({},e,{bin:yn(e.bin,t)})),Kr(e.bin)&&!X(jr,t)&&Je("Channel "+t+' should not be used with "binned" bin'),e.type){var r=Ut(e.type);e.type!==r&&(e=ne({},e,{type:r})),"quantitative"!==e.type&&ze(e.aggregate)&&(Je(Be.invalidFieldTypeForCountAggregate(e.type,e.aggregate)),e=ne({},e,{type:"quantitative"}))}else{var i=hn(e,t);Je(Be.emptyOrInvalidFieldType(e.type,t,i)),e=ne({},e,{type:i})}var o=xn(e,t),a=o.compatible,u=o.warning;return a||Je(u),e}function yn(e,t){return l(e)?{maxbins:Zr(t)}:e.maxbins||e.step?e:ne({},e,{maxbins:Zr(t)})}var bn={compatible:!0};function xn(e,t){var n=e.type;if("geojson"===n&&"shape"!==t)return{compatible:!1,warning:"Channel "+t+" should not be used with a geojson data."};switch(t){case"row":case"column":return tn(e)?{compatible:!1,warning:Be.facetChannelShouldBeDiscrete(t)}:bn;case"x":case"y":case"color":case"fill":case"stroke":case"text":case"detail":case"key":case"tooltip":case"href":return bn;case"longitude":case"longitude2":case"latitude":case"latitude2":return n!==Ft?{compatible:!1,warning:"Channel "+t+" should be used with a quantitative field only, not "+e.type+" field."}:bn;case"opacity":case"size":case"x2":case"y2":return"nominal"!==n||e.sort?bn:{compatible:!1,warning:"Channel "+t+" should not be used with an unsorted discrete field."};case"shape":return X(["ordinal","nominal","geojson"],e.type)?bn:{compatible:!1,warning:"Shape channel should be used with only either discrete or geojson data."};case"order":return"nominal"!==e.type||"sort"in e?bn:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}throw new Error("channelCompatability not implemented for channel "+t)}function Sn(e){return"quantitative"===e.type||Qr(e.bin)}function wn(e){return"temporal"===e.type||!!e.timeUnit}function En(e,t){var n,r,i=t.timeUnit,o=t.type,a=t.time,u=t.undefinedIfExprNotRequired;return $e(e)?r=it(e,!0):(m(e)||te(e))&&(i||"temporal"===o)&&(r=dt(i)?it(((n={})[i]=e,n),!0):ht(i)?En(e,{timeUnit:yt(i)}):"datetime("+JSON.stringify(e)+")"),r?a?"time("+r+")":r:u?void 0:JSON.stringify(e)}function kn(e,t){var n=e.timeUnit,r=e.type;return t.map(function(e){var t=En(e,{timeUnit:n,type:r,undefinedIfExprNotRequired:!0});return void 0!==t?{signal:t}:e})}var Cn,Nn,On=Object.freeze({isConditionalSelection:Mt,isRepeatRef:qt,toFieldDefBase:Ht,isConditionalDef:Wt,hasConditionalFieldDef:Bt,hasConditionalValueDef:Gt,isFieldDef:Yt,isStringFieldDef:Vt,isValueDef:Xt,isScaleFieldDef:Qt,isPositionFieldDef:Kt,isMarkPropFieldDef:Jt,isTextFieldDef:Zt,vgField:$t,isDiscrete:en,isContinuous:tn,isCount:nn,verbalTitleFormatter:rn,functionalTitleFormatter:on,defaultTitleFormatter:an,setTitleFormatter:sn,resetTitleFormatter:ln,title:cn,getGuide:fn,defaultTitle:dn,format:pn,defaultType:hn,getFieldDef:mn,normalize:gn,normalizeFieldDef:vn,normalizeBin:yn,channelCompatibility:xn,isNumberFieldDef:Sn,isTimeFieldDef:wn,valueExpr:En,valueArray:kn});(Nn=Cn||(Cn={})).AREA="area",Nn.BAR="bar",Nn.LINE="line",Nn.POINT="point",Nn.RECT="rect",Nn.RULE="rule",Nn.TEXT="text",Nn.TICK="tick",Nn.TRAIL="trail",Nn.CIRCLE="circle",Nn.SQUARE="square",Nn.GEOSHAPE="geoshape";var An=Cn.AREA,_n=Cn.BAR,Tn=Cn.LINE,Dn=Cn.POINT,zn=Cn.TEXT,Fn=Cn.TICK,In=Cn.TRAIL,Rn=Cn.RECT,Ln=Cn.RULE,jn=Cn.GEOSHAPE,Un=Cn.CIRCLE,Pn=Cn.SQUARE,Mn={area:1,bar:1,line:1,point:1,text:1,tick:1,trail:1,rect:1,geoshape:1,rule:1,circle:1,square:1};function qn(e){return X(["line","area","trail"],e)}var Hn=de(Mn);function Wn(e){return e.type}var Bn=f(Hn);function Gn(e){return(Wn(e)?e.type:e)in Bn}var Yn,Vn,Xn=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],Qn=["fill","fillOpacity"],Kn=[].concat(Xn,Qn),Jn=["filled","color","tooltip"],Zn={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],text:["shortTimeLabels"],tick:["bandSize","thickness"]},$n={color:"#4c78a8",tooltip:{content:"encoding"}},er={binSpacing:1,continuousBandSize:5},tr={thickness:1},nr=Object.freeze({get Mark(){return Cn},AREA:An,BAR:_n,LINE:Tn,POINT:Dn,TEXT:zn,TICK:Fn,TRAIL:In,RECT:Rn,RULE:Ln,GEOSHAPE:jn,CIRCLE:Un,SQUARE:Pn,isMark:function(e){return!!Mn[e]},isPathMark:qn,PRIMITIVE_MARKS:Hn,isMarkDef:Wn,isPrimitiveMark:Gn,STROKE_CONFIG:Xn,FILL_CONFIG:Qn,FILL_STROKE_CONFIG:Kn,VL_ONLY_MARK_CONFIG_PROPERTIES:Jn,VL_ONLY_MARK_SPECIFIC_CONFIG_PROPERTY_INDEX:Zn,defaultMarkConfig:$n,defaultBarConfig:er,defaultTickConfig:tr});(Vn=Yn||(Yn={})).ROW="row",Vn.COLUMN="column",Vn.X="x",Vn.Y="y",Vn.X2="x2",Vn.Y2="y2",Vn.LATITUDE="latitude",Vn.LONGITUDE="longitude",Vn.LATITUDE2="latitude2",Vn.LONGITUDE2="longitude2",Vn.COLOR="color",Vn.FILL="fill",Vn.STROKE="stroke",Vn.SHAPE="shape",Vn.SIZE="size",Vn.OPACITY="opacity",Vn.TEXT="text",Vn.ORDER="order",Vn.DETAIL="detail",Vn.KEY="key",Vn.TOOLTIP="tooltip",Vn.HREF="href";var rr=Yn.X,ir=Yn.Y,or=Yn.X2,ar=Yn.Y2,ur=Yn.LATITUDE,sr=Yn.LATITUDE2,lr=Yn.LONGITUDE,cr=Yn.LONGITUDE2,fr=Yn.ROW,dr=Yn.COLUMN,pr=Yn.SHAPE,hr=Yn.SIZE,mr=Yn.COLOR,gr=Yn.FILL,vr=Yn.STROKE,yr=Yn.TEXT,br=Yn.DETAIL,xr=Yn.KEY,Sr=Yn.ORDER,wr=Yn.OPACITY,Er=Yn.TOOLTIP,kr=Yn.HREF,Cr={longitude:1,longitude2:1,latitude:1,latitude2:1},Nr=de(Cr),Or=ne({x:1,y:1,x2:1,y2:1},Cr,{color:1,fill:1,stroke:1,opacity:1,size:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1});function Ar(e){return"color"===e||"fill"===e||"stroke"===e}var _r=ne({},Or,{row:1,column:1}),Tr=de(_r),Dr=(_r.order,_r.detail,de(re(_r,["order","detail"])));function zr(e){return!!_r[e]}var Fr=de(Or),Ir=(Or.x,Or.y,Or.x2,Or.y2,Or.latitude,Or.longitude,Or.latitude2,Or.longitude2,re(Or,["x","y","x2","y2","latitude","longitude","latitude2","longitude2"])),Rr=de(Ir),Lr={x:1,y:1},jr=de(Lr),Ur=re(Ir,["text","tooltip","href","detail","key","order"]),Pr=de(Ur);function Mr(e){return!!Ir[e]}var qr=ne({},Lr,Ur),Hr=de(qr);function Wr(e){return!!qr[e]}function Br(e,t,n){if(X([Un,Dn,Pn,Fn],n)&&X([or,ar],t)){var r=e[t===or?rr:ir];return!!(Yt(r)&&Yt(e[t])&&Kr(r.bin))}return n in Gr(t)}function Gr(e){switch(e){case mr:case gr:case vr:case br:case xr:case Er:case kr:case Sr:case wr:case fr:case dr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0,geoshape:!0};case rr:case ir:case ur:case lr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,rect:!0,line:!0,trail:!0,area:!0,text:!0};case or:case ar:case sr:case cr:return{rule:!0,bar:!0,rect:!0,area:!0};case hr:return{point:!0,tick:!0,rule:!0,circle:!0,square:!0,bar:!0,text:!0,line:!0,trail:!0};case pr:return{point:!0,geoshape:!0};case yr:return{text:!0}}}function Yr(e){switch(e){case rr:case ir:case hr:case wr:case or:case ar:return"continuous";case fr:case dr:case pr:case yr:case Er:case kr:return"discrete";case mr:case gr:case vr:return"flexible";case ur:case lr:case sr:case cr:case br:case xr:case Sr:return}throw new Error("rangeType not implemented for "+e)}var Vr=Object.freeze({get Channel(){return Yn},X:rr,Y:ir,X2:or,Y2:ar,LATITUDE:ur,LATITUDE2:sr,LONGITUDE:lr,LONGITUDE2:cr,ROW:fr,COLUMN:dr,SHAPE:pr,SIZE:hr,COLOR:mr,FILL:gr,STROKE:vr,TEXT:yr,DETAIL:br,KEY:xr,ORDER:Sr,OPACITY:wr,TOOLTIP:Er,HREF:kr,GEOPOSITION_CHANNEL_INDEX:Cr,GEOPOSITION_CHANNELS:Nr,isColorChannel:Ar,CHANNELS:Tr,SINGLE_DEF_CHANNELS:Dr,isChannel:zr,UNIT_CHANNELS:Fr,NONPOSITION_CHANNELS:Rr,POSITION_SCALE_CHANNELS:jr,NONPOSITION_SCALE_CHANNELS:Pr,isNonPositionScaleChannel:Mr,SCALE_CHANNELS:Hr,isScaleChannel:Wr,supportMark:Br,getSupportedMark:Gr,rangeType:Yr});function Xr(t){return l(t)?"bin":"bin"+ce(t).map(function(e){return me("_"+e+"_"+t[e])}).join("")}function Qr(e){return!0===e||Jr(e)}function Kr(e){return"binned"===e}function Jr(e){return ee(e)}function Zr(e){switch(e){case fr:case dr:case hr:case mr:case gr:case vr:case wr:case pr:return 6;default:return 10}}var $r,ei,ti=Object.freeze({binToString:Xr,isBinning:Qr,isBinned:Kr,isBinParams:Jr,autoMaxBins:Zr});(ei=$r||($r={})).LINEAR="linear",ei.BIN_LINEAR="bin-linear",ei.LOG="log",ei.POW="pow",ei.SQRT="sqrt",ei.TIME="time",ei.UTC="utc",ei.SEQUENTIAL="sequential",ei.QUANTILE="quantile",ei.QUANTIZE="quantize",ei.THRESHOLD="threshold",ei.ORDINAL="ordinal",ei.BIN_ORDINAL="bin-ordinal",ei.POINT="point",ei.BAND="band";var ni={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric","bin-linear":"bin-linear",time:"time",utc:"time",sequential:"sequential",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"},ri=ce(ni);function ii(e,t){var n=ni[e],r=ni[t];return n===r||"ordinal-position"===n&&"time"===r||"ordinal-position"===r&&"time"===n}var oi={linear:0,log:1,pow:1,sqrt:1,time:0,utc:0,point:10,band:11,"bin-linear":0,sequential:0,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function ai(e){return oi[e]}var ui=["linear","bin-linear","log","pow","sqrt","time","utc"],si=f(ui),li=["quantile","quantize","threshold"],ci=f(li),fi=ui.concat(["sequential","quantile","quantize","threshold"]),di=f(fi),pi=["ordinal","bin-ordinal","point","band"],hi=f(pi),mi=f(["bin-linear","bin-ordinal"]);function gi(e){return e in hi}function vi(e){return e in mi}function yi(e){return e in di}function bi(e){return e in si}function xi(e){return e in ci}var Si={textXRangeStep:90,rangeStep:21,pointPadding:.5,bandPaddingInner:.1,facetSpacing:16,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4};function wi(e){return e&&!!e.name}function Ei(e){return e&&e.selection}var ki={type:1,domain:1,range:1,rangeStep:1,scheme:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},Ci=de(ki),Ni=de(re(ki,["type","domain","range","rangeStep","scheme"])),Oi=function(){for(var e={},t=0,n=Tr;t<n.length;t++)for(var r=n[t],i=0,o=ce(zt);i<o.length;i++)for(var a=o[i],u=0,s=ri;u<s.length;u++)for(var l=s[u],c=0,f=[!1,!0];c<f.length;c++){var d=f[c],p=zi(r,a,d);Di(r,l)&&Ti(l,a,d)&&(e[p]=e[p]||[],e[p].push(l))}return e}();function Ai(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":return X(["sequential","ordinal","bin-ordinal","quantile","quantize","threshold"],e);case"interpolate":return X(["linear","bin-linear","pow","log","sqrt","utc","time"],e);case"round":return bi(e)||"band"===e||"point"===e;case"padding":return bi(e)||X(["point","band"],e);case"paddingOuter":case"rangeStep":return X(["point","band"],e);case"paddingInner":return"band"===e;case"clamp":return bi(e)||"sequential"===e;case"nice":return bi(e)||"sequential"===e||"quantize"===e;case"exponent":return"pow"===e;case"base":return"log"===e;case"zero":return yi(e)&&!X(["log","time","utc","bin-linear","threshold","quantile"],e)}throw new Error("Invalid scale property "+t+".")}function _i(e,t){switch(t){case"interpolate":case"scheme":return Ar(e)?void 0:Be.cannotUseScalePropertyWithNonColor(e);case"type":case"domain":case"range":case"base":case"exponent":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeStep":case"reverse":case"round":case"clamp":case"zero":return}throw new Error('Invalid scale property "'+t+'".')}function Ti(e,t,n){return X([_t.ORDINAL,_t.NOMINAL],t)?void 0===e||gi(e):t===_t.TEMPORAL?X([$r.TIME,$r.UTC,$r.SEQUENTIAL,void 0],e):t!==_t.QUANTITATIVE||X(n?[$r.BIN_LINEAR,$r.BIN_ORDINAL,$r.LINEAR]:[$r.LOG,$r.POW,$r.SQRT,$r.QUANTILE,$r.QUANTIZE,$r.THRESHOLD,$r.LINEAR,$r.SEQUENTIAL,void 0],e)}function Di(e,t){switch(e){case Yn.X:case Yn.Y:return bi(t)||X(["band","point"],t);case Yn.SIZE:case Yn.OPACITY:return bi(t)||xi(t)||X(["band","point"],t);case Yn.COLOR:case Yn.FILL:case Yn.STROKE:return"band"!==t;case Yn.SHAPE:return"ordinal"===t}return!1}function zi(e,t,n){var r=e+"_"+t;return n?r+"_bin":r}var Fi=Object.freeze({get ScaleType(){return $r},SCALE_TYPES:ri,scaleCompatible:ii,scaleTypePrecedence:ai,CONTINUOUS_TO_CONTINUOUS_SCALES:ui,CONTINUOUS_TO_DISCRETE_SCALES:li,CONTINUOUS_DOMAIN_SCALES:fi,DISCRETE_DOMAIN_SCALES:pi,TIME_SCALE_TYPES:["time","utc"],hasDiscreteDomain:gi,isBinScale:vi,hasContinuousDomain:yi,isContinuousToContinuous:bi,isContinuousToDiscrete:xi,defaultScaleConfig:Si,isExtendedScheme:wi,isSelectionDomain:Ei,SCALE_PROPERTIES:Ci,NON_TYPE_DOMAIN_RANGE_VEGA_SCALE_PROPERTIES:Ni,SCALE_TYPE_INDEX:Oi,scaleTypeSupportProperty:Ai,channelScalePropertyIncompatability:_i,scaleTypeSupportDataType:Ti,channelSupportScaleType:Di,getSupportedScaleType:function(e,t,n){return Oi[zi(e,t,n)]}});function Ii(e,t,n){return Ri=t||ji,Li=n||Vi,Qi(e.trim()).map(Ki)}var Ri,Li,ji="view",Ui="[",Pi="]",Mi="{",qi="}",Hi=":",Wi=",",Bi="@",Gi=">",Yi=/[[\]{}]/,Vi={"*":1,arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1};function Xi(e,t,n,r,i){for(var o,a=0,u=e.length;t<u;++t){if(o=e[t],!a&&o===n)return t;i&&0<=i.indexOf(o)?--a:r&&0<=r.indexOf(o)&&++a}return t}function Qi(e){for(var t=[],n=0,r=e.length,i=0;i<r;)i=Xi(e,i,Wi,Ui+Mi,Pi+qi),t.push(e.substring(n,i).trim()),n=++i;if(0===t.length)throw"Empty event selector: "+e;return t}function Ki(e){return"["===e[0]?function(e){var t,n,r=e.length,i=1;if((i=Xi(e,i,Pi,Ui,Pi))===r)throw"Empty between selector: "+e;if(2!==(t=Qi(e.substring(1,i))).length)throw"Between selector must have two elements: "+e;if((e=e.slice(i+1).trim())[0]!==Gi)throw"Expected '>' after between selector: "+e;{if(t=t.map(Ki),(n=Ki(e.slice(1).trim())).between)return{between:t,stream:n};n.between=t}return n}(e):function(t){var e,n,r={source:Ri},i=[],o=[0,0],a=0,u=0,s=t.length,l=0;if(t[s-1]===qi){if(!(0<=(l=t.lastIndexOf(Mi))))throw"Unmatched right brace: "+t;try{o=function(n){var e=n.split(Wi);if(!n.length||2<e.length)throw n;return e.map(function(e){var t=+e;if(t!=t)throw n;return t})}(t.substring(l+1,s-1))}catch(e){throw"Invalid throttle specification: "+t}t=t.slice(0,l).trim(),s=t.length,l=0}if(!s)throw t;t[0]===Bi&&(a=++l);(e=Xi(t,l,Hi))<s&&(i.push(t.substring(u,e).trim()),u=l=++e);if((l=Xi(t,l,Ui))===s)i.push(t.substring(u,s).trim());else if(i.push(t.substring(u,l).trim()),n=[],(u=++l)===s)throw"Unmatched left bracket: "+t;for(;l<s;){if((l=Xi(t,l,Pi))===s)throw"Unmatched left bracket: "+t;if(n.push(t.substring(u,l).trim()),l<s-1&&t[++l]!==Ui)throw"Expected left bracket: "+t;u=++l}if(!(s=i.length)||Yi.test(i[s-1]))throw"Invalid event selector: "+t;1<s?(r.type=i[1],a?r.markname=i[0].slice(1):(c=i[0],Li.hasOwnProperty(c)?r.marktype=i[0]:r.source=i[0])):r.type=i[0];var c;"!"===r.type.slice(-1)&&(r.consume=!0,r.type=r.type.slice(0,-1));null!=n&&(r.filter=n);o[0]&&(r.throttle=o[0]);o[1]&&(r.debounce=o[1]);return r}(e)}var Ji="_vgsid_",Zi={single:{on:"click",fields:[Ji],resolve:"global",empty:"all"},multi:{on:"click",fields:[Ji],toggle:"event.shiftKey",resolve:"global",empty:"all"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global"}},$i={zero:1,center:1,normalize:1};function eo(e){return!!$i[e]}var to=[_n,An,Ln,Dn,Un,Pn,Tn,zn,Fn],no=[_n,An];function ro(e,t,n){var r=Wn(e)?e.type:e;if(!X(to,r))return null;var i=function(e){var t=e.x,n=e.y;if(Yt(t)&&Yt(n))if("quantitative"===t.type&&"quantitative"===n.type){if(t.stack)return"x";if(n.stack)return"y";if(!!t.aggregate!=!!n.aggregate)return t.aggregate?"x":"y"}else{if("quantitative"===t.type)return"x";if("quantitative"===n.type)return"y"}else{if(Yt(t)&&"quantitative"===t.type)return"x";if(Yt(n)&&"quantitative"===n.type)return"y"}}(t);if(!i)return null;var o,a=t[i],u=Vt(a)?$t(a,{}):void 0,s="x"===i?"y":"x",l=t[s],c=Vt(l)?$t(l,{}):void 0,f=Rr.reduce(function(r,i){if(of(t,i)){var e=t[i];(w(e)?e:[e]).forEach(function(e){var t=mn(e);if(!t.aggregate){var n=Vt(t)?$t(t,{}):void 0;(!n||n!==c&&n!==u)&&r.push({channel:i,fieldDef:t})}})}return r},[]);return 0===f.length?null:(o=void 0!==a.stack?a.stack:X(no,r)?ke(n,"zero"):n)&&eo(o)?(a.scale&&a.scale.type&&a.scale.type!==$r.LINEAR&&Je(Be.cannotStackNonLinearScale(a.scale.type)),of(t,i===rr?or:ar)?(void 0!==a.stack&&Je(Be.cannotStackRangedMark(i)),null):(a.aggregate&&!X(Ie,a.aggregate)&&Je(Be.stackNonSummativeAggregate(a.aggregate)),{groupbyChannel:l?s:void 0,fieldChannel:i,impute:qn(r),stackBy:f,offset:o})):null}var io=Object.freeze({isStackOffset:eo,STACKABLE_MARKS:to,STACK_BY_DEFAULT_MARKS:no,stack:ro});function oo(e,t){return ao(e,t)}function ao(e,t){if(fo(e))return r=t,i=(n=e).spec,o=re(n,["spec"]),ne({},o,{spec:ao(i,r)});var n,r,i,o,a,u,s,l,c,f,d,p,h,m,g,v,y,b,x,S,w,E,k,C,N,O,A,_;if(ho(e))return function t(e,n,r,i){var o=e.layer,a=e.encoding,u=e.projection,s=re(e,["layer","encoding","projection"]);var l=uo({parentEncoding:r,encoding:a});var c=so({parentProjection:i,projection:u});return ne({},s,{layer:o.map(function(e){return ho(e)?t(e,n,l,c):lo(e,n,l,c)})})}(e,t);if(mo(e))return u=t,s=(a=e).spec,l=re(a,["spec"]),ne({},l,{spec:ao(s,u)});if(vo(e))return f=t,d=(c=e).vconcat,p=re(c,["vconcat"]),ne({},p,{vconcat:d.map(function(e){return ao(e,f)})});if(yo(e))return m=t,g=(h=e).hconcat,v=re(h,["hconcat"]),ne({},v,{hconcat:g.map(function(e){return ao(e,m)})});if(po(e)){var T=of(e.encoding,fr),D=of(e.encoding,dr);return T||D?(b=t,x=(y=e).encoding,S=x.row,w=x.column,E=re(x,["row","column"]),k=y.mark,C=y.width,N=y.projection,O=y.height,A=y.selection,y.encoding,_=re(y,["mark","width","projection","height","selection","encoding"]),ne({},_,{facet:ne({},S?{row:S}:{},w?{column:w}:{}),spec:lo(ne({},N?{projection:N}:{},{mark:k},C?{width:C}:{},O?{height:O}:{},{encoding:E},A?{selection:A}:{}),b)})):lo(e,t)}throw new Error(Be.INVALID_SPEC)}function uo(e){var t=e.parentEncoding,n=e.encoding;if(t&&n){var r=ce(t).reduce(function(e,t){return n[t]&&e.push(t),e},[]);0<r.length&&Je(Be.encodingOverridden(r))}var i=ne({},t||{},n||{});return 0<ce(i).length?i:void 0}function so(e){var t=e.parentProjection,n=e.projection;return t&&n&&Je(Be.projectionOverridden({parentProjection:t,projection:n})),n||t}function lo(e,t,n,r){var i=e.encoding,o=e.projection,a=Wn(e.mark)?e.mark.type:e.mark;if(n||r){var u=so({parentProjection:r,projection:o}),s=uo({parentEncoding:n,encoding:i});return lo(ne({},e,u?{projection:u}:{},s?{encoding:s}:{}),t)}return Gn(e.mark)?lf(i)?function(e){var t=of(e.encoding,rr),n=of(e.encoding,ir),r=of(e.encoding,or),i=of(e.encoding,ar);if(r&&!t||i&&!n){var o=pe(e);return r&&!t&&(o.encoding.x=o.encoding.x2,delete o.encoding.x2),i&&!n&&(o.encoding.y=o.encoding.y2,delete o.encoding.y2),o}return e}(e):"line"===a&&(i.x2||i.y2)?(Je(Be.lineWithRange(!!i.x2,!!i.y2)),lo(ne({mark:"rule"},e),t,n,r)):qn(a)?function(e,t){void 0===t&&(t={});var n,r=e.selection,i=e.projection,o=e.encoding,a=e.mark,u=re(e,["selection","projection","encoding","mark"]),s=Wn(a)?a:{type:a},l=(p=s,h=t[s.type],m=o,"transparent"===p.point?{opacity:0}:p.point?ee(p.point)?p.point:{}:void 0!==p.point?null:h.point||m.shape?ee(h.point)?h.point:{}:null),c="area"===s.type&&(f=s,d=t[s.type],f.line?!0===f.line?{}:f.line:void 0!==f.line?null:d.line?!0===d.line?{}:d.line:null);var f,d;var p,h,m;if(!l&&!c)return ne({},e,{mark:co(s)});var g=[ne({},r?{selection:r}:{},{mark:co(ne({},s,"area"===s.type?{opacity:.7}:{})),encoding:G(o,["shape"])})],v=ro(s,o,t?t.stack:void 0),y=o;if(v){var b=v.fieldChannel,x=v.offset;y=ne({},o,((n={})[b]=ne({},o[b],x?{stack:x}:{}),n))}c&&g.push(ne({},i?{projection:i}:{},{mark:ne({type:"line"},B(s,["clip","interpolate","tension"]),c),encoding:y}));l&&g.push(ne({},i?{projection:i}:{},{mark:ne({type:"point",opacity:1,filled:!0},B(s,["clip"]),l),encoding:y}));return ne({},u,{layer:g})}(e,t):e:zf(e,t)}function co(e){e.point,e.line;var t=re(e,["point","line"]);return 1<ce(t).length?t:t.type}function fo(e){return void 0!==e.facet}function po(e){return!!e.mark}function ho(e){return void 0!==e.layer}function mo(e){return void 0!==e.repeat}function go(e){return vo(e)||yo(e)}function vo(e){return void 0!==e.vconcat}function yo(e){return void 0!==e.hconcat}function bo(t,e){return e.forEach(function(n){var e=V(["field","type","value","timeUnit","bin","aggregate"].reduce(function(e,t){return void 0!==n[t]&&(e[t]=n[t]),e},{}));t[e]=t[e]||n}),t}function xo(e){if(fo(e)||mo(e))return xo(e.spec);var t,n;if(ho(e))return t=[],e.layer.map(function(e){t=t.concat(xo(e))}),t;if(po(e))return n=[],ff(e.encoding,function(e,t){n.push(e.field)}),n;throw new Error(Be.INVALID_SPEC)}var So=Object.freeze({isFacetSpec:fo,isUnitSpec:po,isLayerSpec:ho,isRepeatSpec:mo,isConcatSpec:go,isVConcatSpec:vo,isHConcatSpec:yo,fieldDefs:function(e){return fe(function t(e,n){return void 0===n&&(n={}),ho(e)?e.layer.forEach(function(e){po(e)?bo(n,cf(e.encoding)):t(e,n)}):fo(e)?(bo(n,cf(e.facet)),t(e.spec,n)):mo(e)?t(e.spec,n):go(e)?(vo(e)?e.vconcat:e.hconcat).forEach(function(e){return t(e,n)}):bo(n,cf(e.encoding)),n}(e))},isStacked:function(e,t){return t=t||e.config,!!Gn(e.mark)&&null!==ro(e.mark,e.encoding,t?t.stack:void 0)},usedFields:xo,normalize:oo});function wo(e){var t=e.anchor,n=(e.frame,e.offset),r=e.orient,i=e.color,o=re(e,["anchor","frame","offset","orient","color"]);return{mark:ne({},o,i?{fill:i}:{}),nonMark:ne({},t?{anchor:t}:{},n?{offset:n}:{},r?{orient:r}:{})}}function Eo(e){return m(e)?{type:e}:e||{}}var ko=["background","padding"];function Co(n){return ko.reduce(function(e,t){return n&&void 0!==n[t]&&(e[t]=n[t]),e},{})}function No(e){return void 0!==e.filter}function Oo(e){return e&&void 0!==e.start&&void 0!==e.stop}function Ao(e){return void 0!==e.lookup}function _o(e){return void 0!==e.sample}function To(e){return void 0!==e.window}function Do(e){return void 0!==e.flatten}function zo(e){return void 0!==e.calculate}function Fo(e){return!!e.bin}function Io(e){return void 0!==e.impute}function Ro(e){return void 0!==e.timeUnit}function Lo(e){return void 0!==e.aggregate}function jo(e){return void 0!==e.stack}function Uo(e){return void 0!==e.fold}function Po(e){return e.map(function(e){return No(e)?{filter:function t(e,n){return H(e)?{not:t(e.not,n)}:q(e)?{and:e.and.map(function(e){return t(e,n)})}:M(e)?{or:e.or.map(function(e){return t(e,n)})}:n(e)}(e.filter,bc)}:e})}var Mo=Object.freeze({isFilter:No,isImputeSequence:Oo,isLookup:Ao,isSample:_o,isWindow:To,isFlatten:Do,isCalculate:zo,isBin:Fo,isImpute:Io,isTimeUnit:Ro,isAggregate:Lo,isStack:jo,isFold:Uo,normalizeTransform:Po});function qo(e){return!!e.signal}function Ho(e){return!!e.step}function Wo(e){return!w(e)&&("field"in e&&"data"in e)}var Bo=de({opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeMiterLimit:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,cursor:1,href:1,tooltip:1,cornerRadius:1});function Go(e,n,t,r){void 0===r&&(r={header:!1});var i=e.combine(),o=i.orient,a=i.scale,u=i.title,s=i.zindex,l=re(i,["orient","scale","title","zindex"]);if(ce(l).forEach(function(e){var t=Pe[e];t&&t!==n&&"both"!==t&&delete l[e]}),"grid"===n){if(!l.grid)return;if(l.encode){var c=l.encode.grid;l.encode=ne({},c?{grid:c}:{}),0===ce(l.encode).length&&delete l.encode}return ne({scale:a,orient:o},l,{domain:!1,labels:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:ke(s,0)})}if(r.header||!e.mainExtracted){if(l.encode){for(var f=0,d=Ue;f<d.length;f++){var p=d[f];e.hasAxisPart(p)||delete l.encode[p]}0===ce(l.encode).length&&delete l.encode}var h,m,g=(m=t,w(h=u)?h.map(function(e){return dn(e,m)}).join(", "):h);return ne({scale:a,orient:o,grid:!1},g?{title:g}:{},l,{zindex:ke(s,1)})}}var Yo={titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontWeight:"fontWeight",titleLimit:"limit",titlePadding:"offset"},Vo={labelAngle:"angle",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelLimit:"limit",labelPadding:"offset"},Xo=Object.keys(Yo),Qo=Object.keys(Vo),Ko=Object.freeze({HEADER_TITLE_PROPERTIES_MAP:Yo,HEADER_LABEL_PROPERTIES_MAP:Vo,HEADER_TITLE_PROPERTIES:Xo,HEADER_LABEL_PROPERTIES:Qo});function Jo(e){return!(!e||"count"!==e.op&&!e.field||!e.op)}function Zo(e){return!!e&&w(e)}var $o,ea,ta,na,ra,ia=Object.freeze({isSortField:Jo,isSortArray:Zo}),oa=function(){function e(e,t){this.debugName=t,this._children=[],this._parent=null,e&&(this.parent=e)}return e.prototype.clone=function(){throw new Error("Cannot clone node")},e.prototype.hash=function(){return void 0===this._hash&&(this._hash=Ne()),this._hash},e.prototype.producedFields=function(){return{}},e.prototype.dependentFields=function(){return{}},Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},set:function(e){(this._parent=e).addChild(this)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),e.prototype.numChildren=function(){return this._children.length},e.prototype.addChild=function(e,t){-1<this._children.indexOf(e)?console.warn("Attempt to add the same child twice."):void 0!==t?this._children.splice(t,0,e):this._children.push(e)},e.prototype.removeChild=function(e){var t=this._children.indexOf(e);return this._children.splice(t,1),t},e.prototype.remove=function(){for(var e=this._parent.removeChild(this),t=0,n=this._children;t<n.length;t++){var r=n[t];r._parent=this._parent,this._parent.addChild(r,e++)}},e.prototype.insertAsParentOf=function(e){var t=e.parent;t.removeChild(this),this.parent=t,e.parent=this},e.prototype.swapWithParent=function(){for(var e=this._parent,t=e.parent,n=0,r=this._children;n<r.length;n++){r[n].parent=e}this._children=[],e.removeChild(this),e.parent.removeChild(e),this.parent=t,e.parent=this},e}(),aa=function(o){function e(e,t,n,r){var i=o.call(this,e,t)||this;return i.type=n,i.refCounts=r,i._source=i._name=t,!i.refCounts||i._name in i.refCounts||(i.refCounts[i._name]=0),i}return h(e,o),e.prototype.clone=function(){var e=new this.constructor;return e.debugName="clone_"+this.debugName,e._source=this._source,e._name="clone_"+this._name,e.type=this.type,e.refCounts=this.refCounts,e.refCounts[e._name]=0,e},e.prototype.getSource=function(){return this.refCounts[this._name]++,this._source},e.prototype.isRequired=function(){return!!this.refCounts[this._name]},e.prototype.setSource=function(e){this._source=e},e}(oa);function ua(e){this.type=e}ua.prototype.visit=function(e){var t,n,r;if(e(this))return 1;for(n=0,r=(t=function(e){switch(e.type){case"ArrayExpression":return e.elements;case"BinaryExpression":case"LogicalExpression":return[e.left,e.right];case"CallExpression":var t=e.arguments.slice();return t.unshift(e.callee),t;case"ConditionalExpression":return[e.test,e.consequent,e.alternate];case"MemberExpression":return[e.object,e.property];case"ObjectExpression":return e.properties;case"Property":return[e.key,e.value];case"UnaryExpression":return[e.argument];case"Identifier":case"Literal":case"RawCode":default:return[]}}(this)).length;n<r;++n)if(t[n].visit(e))return 1};var sa=1,la=2,ca=3,fa=4,da=5,pa=6,ha=7,ma=8;($o={})[sa]="Boolean",$o[la]="<end>",$o[ca]="Identifier",$o[fa]="Keyword",$o[da]="Null",$o[pa]="Numeric",$o[ha]="Punctuator",$o[ma]="String",$o[9]="RegularExpression";var ga="ArrayExpression",va="BinaryExpression",ya="CallExpression",ba="ConditionalExpression",xa="Identifier",Sa="Literal",wa="LogicalExpression",Ea="MemberExpression",ka="ObjectExpression",Ca="Property",Na="UnaryExpression",Oa="Unexpected token %0",Aa="Unexpected number",_a="Unexpected string",Ta="Unexpected identifier",Da="Unexpected reserved word",za="Unexpected end of input",Fa="Invalid regular expression",Ia="Invalid regular expression: missing /",Ra="Octal literals are not allowed in strict mode.",La="Duplicate data property in object literal not allowed in strict mode",ja="ILLEGAL",Ua="Disabled.",Pa=new RegExp("[ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙա-ևא-תװ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࢠ-ࢲऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘౙౠౡಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൠൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏼᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡷᢀ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᧁ-ᧇᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々-〇〡-〩〱-〵〸-〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿌ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛯꜗ-ꜟꜢ-ꞈꞋ-ꞎꞐ-ꞭꞰꞱꟷ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭟꭤꭥꯀ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ]"),Ma=new RegExp("[ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮ̀-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁ҃-҇Ҋ-ԯԱ-Ֆՙա-և֑-ׇֽֿׁׂׅׄא-תװ-ײؐ-ؚؠ-٩ٮ-ۓە-ۜ۟-۪ۨ-ۼۿܐ-݊ݍ-ޱ߀-ߵߺࠀ-࠭ࡀ-࡛ࢠ-ࢲࣤ-ॣ०-९ॱ-ঃঅ-ঌএঐও-নপ-রলশ-হ়-ৄেৈো-ৎৗড়ঢ়য়-ৣ০-ৱਁ-ਃਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹ਼ਾ-ੂੇੈੋ-੍ੑਖ਼-ੜਫ਼੦-ੵઁ-ઃઅ-ઍએ-ઑઓ-નપ-રલળવ-હ઼-ૅે-ૉો-્ૐૠ-ૣ૦-૯ଁ-ଃଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହ଼-ୄେୈୋ-୍ୖୗଡ଼ଢ଼ୟ-ୣ୦-୯ୱஂஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹா-ூெ-ைொ-்ௐௗ௦-௯ఀ-ఃఅ-ఌఎ-ఐఒ-నప-హఽ-ౄె-ైొ-్ౕౖౘౙౠ-ౣ౦-౯ಁ-ಃಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹ಼-ೄೆ-ೈೊ-್ೕೖೞೠ-ೣ೦-೯ೱೲഁ-ഃഅ-ഌഎ-ഐഒ-ഺഽ-ൄെ-ൈൊ-ൎൗൠ-ൣ൦-൯ൺ-ൿංඃඅ-ඖක-නඳ-රලව-ෆ්ා-ුූෘ-ෟ෦-෯ෲෳก-ฺเ-๎๐-๙ກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ູົ-ຽເ-ໄໆ່-ໍ໐-໙ໜ-ໟༀ༘༙༠-༩༹༵༷༾-ཇཉ-ཬཱ-྄྆-ྗྙ-ྼ࿆က-၉ၐ-ႝႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚ፝-፟ᎀ-ᎏᎠ-Ᏼᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛸᜀ-ᜌᜎ-᜔ᜠ-᜴ᝀ-ᝓᝠ-ᝬᝮ-ᝰᝲᝳក-៓ៗៜ៝០-៩᠋-᠍᠐-᠙ᠠ-ᡷᢀ-ᢪᢰ-ᣵᤀ-ᤞᤠ-ᤫᤰ-᤻᥆-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉ᧐-᧙ᨀ-ᨛᨠ-ᩞ᩠-᩿᩼-᪉᪐-᪙ᪧ᪰-᪽ᬀ-ᭋ᭐-᭙᭫-᭳ᮀ-᯳ᰀ-᰷᱀-᱉ᱍ-ᱽ᳐-᳔᳒-ᳶ᳸᳹ᴀ-᷵᷼-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼ‌‍‿⁀⁔ⁱⁿₐ-ₜ⃐-⃥⃜⃡-⃰ℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯ⵿-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⷠ-ⷿⸯ々-〇〡-〯〱-〵〸-〼ぁ-ゖ゙゚ゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿌ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘫꙀ-꙯ꙴ-꙽ꙿ-ꚝꚟ-꛱ꜗ-ꜟꜢ-ꞈꞋ-ꞎꞐ-ꞭꞰꞱꟷ-ꠧꡀ-ꡳꢀ-꣄꣐-꣙꣠-ꣷꣻ꤀-꤭ꤰ-꥓ꥠ-ꥼꦀ-꧀ꧏ-꧙ꧠ-ꧾꨀ-ꨶꩀ-ꩍ꩐-꩙ꩠ-ꩶꩺ-ꫂꫛ-ꫝꫠ-ꫯꫲ-꫶ꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭟꭤꭥꯀ-ꯪ꯬꯭꯰-꯹가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻ︀-️︠-︭︳︴﹍-﹏ﹰ-ﹴﹶ-ﻼ０-９Ａ-Ｚ＿ａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ]");function qa(e,t){if(!e)throw new Error("ASSERT: "+t)}function Ha(e){return 48<=e&&e<=57}function Wa(e){return 0<="0123456789abcdefABCDEF".indexOf(e)}function Ba(e){return 0<="01234567".indexOf(e)}function Ga(e){return 10===e||13===e||8232===e||8233===e}function Ya(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||92===e||128<=e&&Pa.test(String.fromCharCode(e))}function Va(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57||92===e||128<=e&&Ma.test(String.fromCharCode(e))}var Xa={if:1,in:1,do:1,var:1,for:1,new:1,try:1,let:1,this:1,else:1,case:1,void:1,with:1,enum:1,while:1,break:1,catch:1,throw:1,const:1,yield:1,class:1,super:1,return:1,typeof:1,delete:1,switch:1,export:1,import:1,public:1,static:1,default:1,finally:1,extends:1,package:1,private:1,function:1,continue:1,debugger:1,interface:1,protected:1,instanceof:1,implements:1};function Qa(){for(var e,t;ta<na&&(e=ea.charCodeAt(ta),32===(t=e)||9===t||11===t||12===t||160===t||5760<=t&&0<=[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(t)||Ga(e));)++ta}function Ka(e){var t,n,r,i=0;for(n="u"===e?4:2,t=0;t<n;++t)ta<na&&Wa(ea[ta])?(r=ea[ta++],i=16*i+"0123456789abcdef".indexOf(r.toLowerCase())):fu({},Oa,ja);return String.fromCharCode(i)}function Ja(){var e,t,n,r;for(t=0,"}"===(e=ea[ta])&&fu({},Oa,ja);ta<na&&Wa(e=ea[ta++]);)t=16*t+"0123456789abcdef".indexOf(e.toLowerCase());return(1114111<t||"}"!==e)&&fu({},Oa,ja),t<=65535?String.fromCharCode(t):(n=55296+(t-65536>>10),r=56320+(t-65536&1023),String.fromCharCode(n,r))}function Za(){var e,t;for(e=ea.charCodeAt(ta++),t=String.fromCharCode(e),92===e&&(117!==ea.charCodeAt(ta)&&fu({},Oa,ja),++ta,(e=Ka("u"))&&"\\"!==e&&Ya(e.charCodeAt(0))||fu({},Oa,ja),t=e);ta<na&&Va(e=ea.charCodeAt(ta));)++ta,t+=String.fromCharCode(e),92===e&&(t=t.substr(0,t.length-1),117!==ea.charCodeAt(ta)&&fu({},Oa,ja),++ta,(e=Ka("u"))&&"\\"!==e&&Va(e.charCodeAt(0))||fu({},Oa,ja),t+=e);return t}function $a(){var e,t;return e=ta,{type:1===(t=92===ea.charCodeAt(ta)?Za():function(){var e,t;for(e=ta++;ta<na;){if(92===(t=ea.charCodeAt(ta)))return ta=e,Za();if(!Va(t))break;++ta}return ea.slice(e,ta)}()).length?ca:Xa.hasOwnProperty(t)?fa:"null"===t?da:"true"===t||"false"===t?sa:ca,value:t,start:e,end:ta}}function eu(){var e,t,n,r,i=ta,o=ea.charCodeAt(ta),a=ea[ta];switch(o){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:return++ta,{type:ha,value:String.fromCharCode(o),start:i,end:ta};default:if(61===(e=ea.charCodeAt(ta+1)))switch(o){case 43:case 45:case 47:case 60:case 62:case 94:case 124:case 37:case 38:case 42:return ta+=2,{type:ha,value:String.fromCharCode(o)+String.fromCharCode(e),start:i,end:ta};case 33:case 61:return ta+=2,61===ea.charCodeAt(ta)&&++ta,{type:ha,value:ea.slice(i,ta),start:i,end:ta}}}return">>>="===(r=ea.substr(ta,4))?{type:ha,value:r,start:i,end:ta+=4}:">>>"===(n=r.substr(0,3))||"<<="===n||">>="===n?{type:ha,value:n,start:i,end:ta+=3}:a===(t=n.substr(0,2))[1]&&0<="+-<>&|".indexOf(a)||"=>"===t?{type:ha,value:t,start:i,end:ta+=2}:0<="<>=!+-*%&|^/".indexOf(a)?{type:ha,value:a,start:i,end:++ta}:void fu({},Oa,ja)}function tu(){var e,t,n;if(qa(Ha((n=ea[ta]).charCodeAt(0))||"."===n,"Numeric literal must start with a decimal digit or a decimal point"),t=ta,e="","."!==n){if(e=ea[ta++],n=ea[ta],"0"===e){if("x"===n||"X"===n)return++ta,function(e){for(var t="";ta<na&&Wa(ea[ta]);)t+=ea[ta++];return 0===t.length&&fu({},Oa,ja),Ya(ea.charCodeAt(ta))&&fu({},Oa,ja),{type:pa,value:parseInt("0x"+t,16),start:e,end:ta}}(t);if(Ba(n))return function(e){for(var t="0"+ea[ta++];ta<na&&Ba(ea[ta]);)t+=ea[ta++];return(Ya(ea.charCodeAt(ta))||Ha(ea.charCodeAt(ta)))&&fu({},Oa,ja),{type:pa,value:parseInt(t,8),octal:!0,start:e,end:ta}}(t);n&&Ha(n.charCodeAt(0))&&fu({},Oa,ja)}for(;Ha(ea.charCodeAt(ta));)e+=ea[ta++];n=ea[ta]}if("."===n){for(e+=ea[ta++];Ha(ea.charCodeAt(ta));)e+=ea[ta++];n=ea[ta]}if("e"===n||"E"===n)if(e+=ea[ta++],"+"!==(n=ea[ta])&&"-"!==n||(e+=ea[ta++]),Ha(ea.charCodeAt(ta)))for(;Ha(ea.charCodeAt(ta));)e+=ea[ta++];else fu({},Oa,ja);return Ya(ea.charCodeAt(ta))&&fu({},Oa,ja),{type:pa,value:parseFloat(e),start:t,end:ta}}function nu(){var e,t,n,r;return ra=null,Qa(),e=ta,t=function(){var e,t,n,r;for(qa("/"===(e=ea[ta]),"Regular expression literal must start with a slash"),t=ea[ta++],r=n=!1;ta<na;)if(t+=e=ea[ta++],"\\"===e)Ga((e=ea[ta++]).charCodeAt(0))&&fu({},Ia),t+=e;else if(Ga(e.charCodeAt(0)))fu({},Ia);else if(n)"]"===e&&(n=!1);else{if("/"===e){r=!0;break}"["===e&&(n=!0)}return r||fu({},Ia),{value:t.substr(1,t.length-2),literal:t}}(),n=function(){var e,t,n;for(n=t="";ta<na&&Va((e=ea[ta]).charCodeAt(0));)++ta,"\\"===e&&ta<na?fu({},Oa,ja):(n+=e,t+=e);return 0<=n.search(/[^gimuy]/g)&&fu({},Fa,n),{value:n,literal:t}}(),r=function(e,t){var n=e;0<=t.indexOf("u")&&(n=n.replace(/\\u\{([0-9a-fA-F]+)\}/g,function(e,t){if(parseInt(t,16)<=1114111)return"x";fu({},Fa)}).replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"x"));try{return new RegExp(e,t)}catch(e){return null}}(t.value,n.value),{literal:t.literal+n.literal,value:r,regex:{pattern:t.value,flags:n.value},start:e,end:ta}}function ru(){var e;return Qa(),na<=ta?{type:la,start:ta,end:ta}:Ya(e=ea.charCodeAt(ta))?$a():40===e||41===e||59===e?eu():39===e||34===e?function(){var e,t,n,r,i="",o=!1;for(qa("'"===(e=ea[ta])||'"'===e,"String literal must starts with a quote"),t=ta,++ta;ta<na;){if((n=ea[ta++])===e){e="";break}if("\\"===n)if((n=ea[ta++])&&Ga(n.charCodeAt(0)))"\r"===n&&"\n"===ea[ta]&&++ta;else switch(n){case"u":case"x":"{"===ea[ta]?(++ta,i+=Ja()):i+=Ka(n);break;case"n":i+="\n";break;case"r":i+="\r";break;case"t":i+="\t";break;case"b":i+="\b";break;case"f":i+="\f";break;case"v":i+="\v";break;default:Ba(n)?(0!==(r="01234567".indexOf(n))&&(o=!0),ta<na&&Ba(ea[ta])&&(o=!0,r=8*r+"01234567".indexOf(ea[ta++]),0<="0123".indexOf(n)&&ta<na&&Ba(ea[ta])&&(r=8*r+"01234567".indexOf(ea[ta++]))),i+=String.fromCharCode(r)):i+=n}else{if(Ga(n.charCodeAt(0)))break;i+=n}}return""!==e&&fu({},Oa,ja),{type:ma,value:i,octal:o,start:t,end:ta}}():46===e?Ha(ea.charCodeAt(ta+1))?tu():eu():Ha(e)?tu():eu()}function iu(){var e;return ta=(e=ra).end,ra=ru(),ta=e.end,e}function ou(){var e;e=ta,ra=ru(),ta=e}function au(e,t,n){var r=new ua("||"===e||"&&"===e?wa:va);return r.operator=e,r.left=t,r.right=n,r}function uu(e){var t=new ua(xa);return t.name=e,t}function su(e){var t=new ua(Sa);return t.value=e.value,t.raw=ea.slice(e.start,e.end),e.regex&&("//"===t.raw&&(t.raw="/(?:)/"),t.regex=e.regex),t}function lu(e,t,n){var r=new ua(Ea);return r.computed="["===e,r.object=t,r.property=n,r.computed||(n.member=!0),r}function cu(e,t,n){var r=new ua(Ca);return r.key=t,r.value=n,r.kind=e,r}function fu(e,t){var n,r=Array.prototype.slice.call(arguments,2),i=t.replace(/%(\d)/g,function(e,t){return qa(t<r.length,"Message reference must be in range"),r[t]});throw(n=new Error(i)).index=ta,n.description=i,n}function du(e){e.type===la&&fu(e,za),e.type===pa&&fu(e,Aa),e.type===ma&&fu(e,_a),e.type===ca&&fu(e,Ta),e.type===fa&&fu(e,Da),fu(e,Oa,e.value)}function pu(e){var t=iu();t.type===ha&&t.value===e||du(t)}function hu(e){return ra.type===ha&&ra.value===e}function mu(e){return ra.type===fa&&ra.value===e}function gu(){var e,t,n=[];for(ta=ra.start,pu("[");!hu("]");)hu(",")?(iu(),n.push(null)):(n.push(Nu()),hu("]")||pu(","));return iu(),e=n,(t=new ua(ga)).elements=e,t}function vu(){var e;return ta=ra.start,(e=iu()).type===ma||e.type===pa?(e.octal&&fu(e,Ra),su(e)):uu(e.value)}function yu(){var e,t,n,r,i,o,a,u=[],s={},l=String;for(ta=ra.start,pu("{");!hu("}");)i=r=n=void 0,ta=ra.start,t="$"+((e=(n=ra).type===ca?(i=vu(),pu(":"),cu("init",i,Nu())):n.type!==la&&n.type!==ha?(r=vu(),pu(":"),cu("init",r,Nu())):void du(n)).key.type===xa?e.key.name:l(e.key.value)),Object.prototype.hasOwnProperty.call(s,t)?fu({},La):s[t]=!0,u.push(e),hu("}")||pu(",");return pu("}"),o=u,(a=new ua(ka)).properties=o,a}var bu={if:1,this:1};function xu(){var e,t,n,r;if(hu("("))return pu("("),r=Ou(),pu(")"),r;if(hu("["))return gu();if(hu("{"))return yu();if(e=ra.type,ta=ra.start,e===ca||bu[ra.value])n=uu(iu().value);else if(e===ma||e===pa)ra.octal&&fu(ra,Ra),n=su(iu());else{if(e===fa)throw new Error(Ua);e===sa?((t=iu()).value="true"===t.value,n=su(t)):e===da?((t=iu()).value=null,n=su(t)):hu("/")||hu("/=")?(n=su(nu()),ou()):du(iu())}return n}function Su(){var e=[];if(pu("("),!hu(")"))for(;ta<na&&(e.push(Nu()),!hu(")"));)pu(",");return pu(")"),e}function wu(){var e,t;return ta=ra.start,e=iu(),(t=e).type!==ca&&t.type!==fa&&t.type!==sa&&t.type!==da&&du(e),uu(e.value)}function Eu(){var e=function(){var e,t,n,r,i,o;for(e=xu();;)if(hu("."))pu("."),e=lu(".",e,wu());else if(hu("("))t=Su(),r=e,i=t,o=void 0,(o=new ua(ya)).callee=r,o.arguments=i,e=o;else{if(!hu("["))break;n=void 0,pu("["),n=Ou(),pu("]"),e=lu("[",e,n)}return e}();if(ra.type===ha&&(hu("++")||hu("--")))throw new Error(Ua);return e}function ku(){var e,t,n,r,i;if(ra.type!==ha&&ra.type!==fa)t=Eu();else{if(hu("++")||hu("--"))throw new Error(Ua);if(hu("+")||hu("-")||hu("~")||hu("!"))e=iu(),t=ku(),n=e.value,r=t,(i=new ua(Na)).operator=n,i.argument=r,i.prefix=!0,t=i;else{if(mu("delete")||mu("void")||mu("typeof"))throw new Error(Ua);t=Eu()}}return t}function Cu(e){var t=0;if(e.type!==ha&&e.type!==fa)return 0;switch(e.value){case"||":t=1;break;case"&&":t=2;break;case"|":t=3;break;case"^":t=4;break;case"&":t=5;break;case"==":case"!=":case"===":case"!==":t=6;break;case"<":case">":case"<=":case">=":case"instanceof":case"in":t=7;break;case"<<":case">>":case">>>":t=8;break;case"+":case"-":t=9;break;case"*":case"/":case"%":t=11}return t}function Nu(){var e,t,n,r,i,o,a;return e=function(){var e,t,n,r,i,o,a,u,s,l;if(e=ra,s=ku(),0===(i=Cu(r=ra)))return s;for(r.prec=i,iu(),t=[e,ra],o=[s,r,a=ku()];0<(i=Cu(ra));){for(;2<o.length&&i<=o[o.length-2].prec;)a=o.pop(),u=o.pop().value,s=o.pop(),t.pop(),n=au(u,s,a),o.push(n);(r=iu()).prec=i,o.push(r),t.push(ra),n=ku(),o.push(n)}for(n=o[l=o.length-1],t.pop();1<l;)t.pop(),n=au(o[l-1].value,o[l-2],n),l-=2;return n}(),hu("?")&&(iu(),t=Nu(),pu(":"),n=Nu(),r=e,i=t,o=n,(a=new ua(ba)).test=r,a.consequent=i,a.alternate=o,e=a),e}function Ou(){var e=Nu();if(hu(","))throw new Error(Ua);return e}function Au(e){var t=function(e){ta=0,na=(ea=e).length,ra=null,ou();var t=Ou();if(ra.type!==la)throw new Error("Unexpect token after expression.");return t}(e),n={};return t.visit(function(e){"MemberExpression"===e.type&&function e(t){return"MemberExpression"===t.object.type?e(t.object):"datum"===t.object.name}(e)&&(n[function e(t){var n=[];return"Identifier"===t.type?[t.name]:"Literal"===t.type?[t.value]:("MemberExpression"===t.type&&(n=(n=n.concat(e(t.object))).concat(e(t.property))),n)}(e).slice(1).join(".")]=!0)}),n}var _u=function(r){function u(e,t){var n=r.call(this,e)||this;return n.transform=t,n._dependentFields=Au(n.transform.calculate),n}return h(u,r),u.prototype.clone=function(){return new u(null,pe(this.transform))},u.parseAllForSortIndex=function(a,e){return e.forEachFieldDef(function(e,t){if(Qt(e)&&Zo(e.sort)){var n=e.field,r=e.timeUnit,i=e.sort,o=i.map(function(e,t){return yc({field:n,timeUnit:r,equal:e})+" ? "+t+" : "}).join("")+i.length;a=new u(a,{calculate:o,as:Tu(e,t,{forAs:!0})})}}),a},u.prototype.producedFields=function(){var e={};return e[this.transform.as]=!0,e},u.prototype.dependentFields=function(){return this._dependentFields},u.prototype.assemble=function(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}},u.prototype.hash=function(){return"Calculate "+V(this.transform)},u}(oa);function Tu(e,t,n){return $t(e,ne({prefix:t,suffix:"sort_index"},n||{}))}var Du=["row","column"],zu=["header","footer"];function Fu(e,t){for(var n=e.component.layoutHeaders[t],r=[],i=0,o=zu;i<o.length;i++){var a=o[i];if(n[a])for(var u=0,s=n[a];u<s.length;u++){var l=s[u];r.push(Iu(e,t,a,n,l))}}return r}function Iu(e,t,n,r,i){var o,a,u,s,l,c;if(i){var f=null,d=r.facetFieldDef;if(d&&i.labels){var p=d.header,h=void 0===p?{}:p,m=h.format,g=h.labelAngle,v=e.config?e.config:void 0,y=ne({},(90+(c=((c=g)%360+360)%360))%180==0?{}:c<90||270<c?{align:{value:"right"}}:135<=c&&c<225?{align:{value:"left"}}:{});f=ne({text:Yc(d,m,"parent",e.config),offset:10},"row"===t?{orient:"left"}:{},{style:"guide-label"},void 0!==g?{angle:g}:{},45<=(l=((l=g)%360+360)%360)&&l<=135?{baseline:"top"}:{baseline:"middle"},Ru(v,d,Qo,Vo),0<ce(y).length?{encode:{update:y}}:{})}var b=i.axes,x=b&&0<b.length;if(f||x){var S="row"===t?"height":"width";return ne({name:e.getName(t+"_"+n),type:"group",role:t+"-"+n},r.facetFieldDef?{from:{data:e.getName(t+"_domain")},sort:(a=d,u=t,s=a.sort,Jo(s)?{field:$t(s,{expr:"datum"}),order:s.order||"ascending"}:w(s)?{field:Tu(a,u,{expr:"datum"}),order:"ascending"}:{field:$t(a,{expr:"datum"}),order:s||"ascending"})}:{},f?{title:f}:{},i.sizeSignal?{encode:{update:(o={},o[S]=i.sizeSignal,o)}}:{},x?{axes:b}:{})}}return null}function Ru(e,t,n,r){for(var i={},o=0,a=n;o<a.length;o++){var u=a[o];e&&e.header&&e.header[u]&&(i[r[u]]=e.header[u]),t&&t.header&&t.header[u]&&(i[r[u]]=t.header[u])}return i}function Lu(e){return[].concat(ju(e,"width"),ju(e,"height"))}function ju(e,t){var n="width"===t?"x":"y",r=e.component.layoutSize.get(t);if(!r||"merged"===r)return[];var i=e.getSizeSignalRef(t).signal;if("range-step"!==r)return[{name:i,value:r}];var o=e.getScaleComponent(n);if(o){var a=o.get("type"),u=o.get("range");if(gi(a)&&Ho(u)){var s=e.scaleName(n);if(xl(e.parent))if("independent"===e.parent.component.resolve.scale[n])return[Uu(s,u)];return[Uu(s,u),{name:i,update:Pu(s,o,"domain('"+s+"').length")}]}}throw new Error("layout size is range step although there is no rangeStep.")}function Uu(e,t){return{name:e+"_step",value:t.step}}function Pu(e,t,n){var r=t.get("type"),i=t.get("padding"),o=ke(t.get("paddingOuter"),i),a=t.get("paddingInner");return"bandspace("+n+", "+(a="band"===r?void 0!==a?a:i:1)+", "+o+") * "+e+"_step"}var Mu={},qu={clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,direction:1,fillColor:1,format:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,strokeWidth:1,symbolFillColor:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,title:1,titleAlign:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontWeight:1,titleLimit:1,titleOpacity:1,titlePadding:1,type:1,values:1,zindex:1},Hu=ne({},qu,{opacity:1,shape:1,stroke:1,fill:1,size:1,encode:1}),Wu=de(qu),Bu=de(Hu),Gu=Object.freeze({defaultLegendConfig:Mu,LEGEND_PROPERTIES:Wu,VG_LEGEND_PROPERTIES:Bu});function Yu(e,t){var n=e.scale[t],r=X(jr,t)?"axis":"legend";return"independent"===n?("shared"===e[r][t]&&Je(Be.independentScaleMeansIndependentGuide(t)),"independent"):e[r][t]||"shared"}var Vu=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.explicit=e,this.implicit=t}return e.prototype.clone=function(){return new e(pe(this.explicit),pe(this.implicit))},e.prototype.combine=function(){return ne({},this.explicit,this.implicit)},e.prototype.get=function(e){return ke(this.explicit[e],this.implicit[e])},e.prototype.getWithExplicit=function(e){return void 0!==this.explicit[e]?{explicit:!0,value:this.explicit[e]}:void 0!==this.implicit[e]?{explicit:!1,value:this.implicit[e]}:{explicit:!1,value:void 0}},e.prototype.setWithExplicit=function(e,t){void 0!==t.value&&this.set(e,t.value,t.explicit)},e.prototype.set=function(e,t,n){return delete this[n?"implicit":"explicit"][e],this[n?"explicit":"implicit"][e]=t,this},e.prototype.copyKeyFromSplit=function(e,t){void 0!==t.explicit[e]?this.set(e,t.explicit[e],!0):void 0!==t.implicit[e]&&this.set(e,t.implicit[e],!1)},e.prototype.copyKeyFromObject=function(e,t){void 0!==t[e]&&this.set(e,t[e],!0)},e.prototype.copyAll=function(e){for(var t=0,n=ce(e.combine());t<n.length;t++){var r=n[t],i=e.getWithExplicit(r);this.setWithExplicit(r,i)}},e}();function Xu(e){return{explicit:!0,value:e}}function Qu(e){return{explicit:!1,value:e}}function Ku(o){return function(e,t,n,r){var i=o(e.value,t.value);return 0<i?e:i<0?t:Ju(e,t,n,r)}}function Ju(e,t,n,r){return e.explicit&&t.explicit&&Je(Be.mergeConflictingProperty(n,r,e.value,t.value)),e}function Zu(e,t,n,r,i){return void 0===i&&(i=Ju),void 0===e||void 0===e.value?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:Y(e.value)===Y(t.value)?e:i(e,t,n,r)}var $u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(Vu);function es(e){return ns(e,function(e,t){return Math.max(e,t.value)})}function ts(e){return ns(e,function(e,t){return ke(e,t.value)})}function ns(e,t){return Gt(e)?(w(e.condition)?e.condition:[e.condition]).reduce(t,e.value):Xt(e)?e.value:void 0}var rs=Object.freeze({symbols:function(e,t,n,r,i){if("gradient"!==i.get("type")){var o=ne({},function(e,t,n){for(var r=0,i=n;r<i.length;r++){var o=i[r],a=Bc(o,t.markDef,t.config);void 0!==a&&(e[o]={value:a})}return e}({},n,Kn),Tc(n));switch(n.mark){case _n:case Fn:case zn:o.shape={value:"square"};break;case Un:case Pn:o.shape={value:n.mark}}var a=n.markDef,u=n.encoding,s=a.filled,l=es(u.opacity)||a.opacity;if(o.fill)if("fill"===r||s&&r===mr)delete o.fill;else if(o.fill.field)i.get("symbolFillColor")?delete o.fill:(o.fill={value:"black"},o.fillOpacity={value:l||1});else if(w(o.fill)){var c=ts(u.fill||u.color)||a.fill||s&&a.color;c&&(o.fill={value:c})}if(o.stroke)if("stroke"===r||!s&&r===mr)delete o.stroke;else if(o.stroke.field)delete o.stroke;else if(w(o.stroke)){var f=ke(ts(u.stroke||u.color),a.stroke,s?a.color:void 0);f&&(o.stroke={value:f})}if(o.fill&&"transparent"!==o.fill.value&&!o.stroke&&(o.stroke={value:"transparent"}),r!==pr){var d=ts(u.shape)||a.shape;d&&(o.shape={value:d})}return r!==wr&&l&&(o.opacity={value:l}),o=ne({},o,t),0<ce(o).length?o:void 0}},gradient:function(e,t,n,r,i){var o={};if("gradient"===i.get("type")){var a=es(n.encoding.opacity)||n.markDef.opacity;a&&(o.opacity={value:a})}return o=ne({},o,t),0<ce(o).length?o:void 0},labels:function(e,t,n,r,i){var o=n.legend(r),a=n.config,u={};if(wn(e)){var s=n.getScaleComponent(r).get("type")===$r.UTC,l=Jc("datum.value",e.timeUnit,o.format,a.legend.shortTimeLabels,a.timeFormat,s);t=ne({},l?{text:{signal:l}}:{},t)}return u=ne({},u,t),0<ce(u).length?u:void 0}});function is(e){var r,i;bl(e)?e.component.legends=(i=(r=e).encoding,[mr,gr,vr,hr,pr,wr].reduce(function(e,t){var n=i[t];return!r.legend(t)||!r.getScaleComponent(t)||Yt(n)&&t===pr&&n.type===jt||(e[t]=function(i,o){for(var a=i.fieldDef(o),e=i.legend(o),u=new $u({},function(e,t){var n;switch(t){case mr:var r=e.scaleName(mr);return e.markDef.filled?{fill:r}:{stroke:r};case gr:case vr:case hr:case pr:case wr:return(n={})[t]=e.scaleName(t),n}}(i,o)),t=0,n=Wu;t<n.length;t++){var r=n[t],s=as(r,e,o,i);if(void 0!==s){var l=os(s,r,e,a);(l||void 0===i.config.legend[r])&&u.set(r,s,l)}}var c=e.encoding||{},f=["labels","legend","title","symbols","gradient"].reduce(function(e,t){var n=rf(c[t]||{},i),r=rs[t]?rs[t](a,n,i,o,u):n;return void 0!==r&&0<ce(r).length&&(e[t]={update:r}),e},{});return 0<ce(f).length&&u.set("encode",f,!!e.encoding),u}(r,t)),e},{})):e.component.legends=function(i){for(var e=i.component,n=e.legends,o=e.resolve,t=function(t){is(t),ce(t.component.legends).forEach(function(e){o.legend[e]=Yu(i.component.resolve,e),"shared"===o.legend[e]&&(n[e]=us(n[e],t.component.legends[e]),n[e]||(o.legend[e]="independent",delete n[e]))})},r=0,a=i.children;r<a.length;r++){var u=a[r];t(u)}return ce(n).forEach(function(e){for(var t=0,n=i.children;t<n.length;t++){var r=n[t];r.component.legends[e]&&"shared"===o.legend[e]&&delete r.component.legends[e]}}),n}(e)}function os(e,t,n,r){switch(t){case"values":return!!n.values;case"title":if("title"===t&&e===r.title)return!0}return e===n[t]}function as(e,t,n,r){var i=r.fieldDef(n);switch(e){case"format":return Vc(i,t.format,r.config);case"title":return cn(i,r.config,{allowDisabling:!0})||void 0;case"labelOverlap":return ke(t.labelOverlap,function(e){if(X(["quantile","threshold","log"],e))return"greedy"}(r.getScaleComponent(n).get("type")));case"values":return function(e,t){var n=e.values;if(n)return kn(t,n)}(t,i)}return t[e]}function us(t,r){if(!t)return r.clone();var e=t.getWithExplicit("orient"),n=r.getWithExplicit("orient");if(!e.explicit||!n.explicit||e.value===n.value){for(var i=!1,o=function(n){var e=Zu(t.getWithExplicit(n),r.getWithExplicit(n),n,"legend",function(e,t){switch(n){case"title":return tf(e,t);case"type":return i=!0,Qu("symbol")}return Ju(e,t,n,"legend")});t.setWithExplicit(n,e)},a=0,u=Bu;a<u.length;a++){o(u[a])}return i&&(((t.implicit||{}).encode||{}).gradient&&ve(t.implicit,["encode","gradient"]),((t.explicit||{}).encode||{}).gradient&&ve(t.explicit,["encode","gradient"])),t}}function ss(e){for(var t=e.component.legends,n={},r=0,i=ce(t);r<i.length;r++){var o=i[r],a=e.getScaleComponent(o),u=Y(a.domains);if(n[u])for(var s=0,l=n[u];s<l.length;s++){us(l[s],t[o])||n[u].push(t[o])}else n[u]=[t[o].clone()]}return Z(fe(n)).map(function(e){return e.combine()})}function ls(e){return El(e)||wl(e)||Sl(e)?(t=e).children.reduce(function(e,t){return e.concat(t.assembleProjections())},cs(t)):cs(e);var t}function cs(r){var e=r.component.projection;if(!e||e.merged)return[];var t=e.combine(),n=t.name,i=re(t,["name"]),o={signal:"["+e.size.map(function(e){return e.signal}).join(", ")+"]"},a=e.data.reduce(function(e,t){var n=qo(t)?t.signal:"data('"+r.lookupDataSource(t)+"')";return X(e,n)||e.push(n),e},[]);if(a.length<=0)throw new Error("Projection's fit didn't find any data sources");return[ne({name:n,size:o,fit:{signal:1<a.length?"["+a.join(", ")+"]":a[0]}},i)]}function fs(e){return!!e.url}function ds(e){return!!e.values}function ps(e){return!!e.name&&!fs(e)&&!ds(e)}var hs="main",ms="raw",gs=Object.freeze({isUrlData:fs,isInlineData:ds,isNamedData:ps,MAIN:hs,RAW:ms}),vs=["type","clipAngle","clipExtent","center","rotate","precision","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"],ys=function(o){function e(e,t,n,r){var i=o.call(this,ne({},t),{name:e})||this;return i.specifiedProjection=t,i.size=n,i.data=r,i.merged=!1,i}return h(e,o),e}(Vu);function bs(e){bl(e)?e.component.projection=function(t){var e=t.specifiedProjection,n=t.config;if(t.hasProjection){var r=[];return[[lr,ur],[cr,sr]].forEach(function(e){(t.channelHasField(e[0])||t.channelHasField(e[1]))&&r.push({signal:t.getName("geojson_"+r.length)})}),t.channelHasField(pr)&&t.fieldDef(pr).type===jt&&r.push({signal:t.getName("geojson_"+r.length)}),0===r.length&&r.push(t.requestDataName(hs)),new ys(t.projectionName(!0),ne({},n.projection||{},e||{}),[t.getSizeSignalRef("width"),t.getSizeSignalRef("height")],r)}return}(e):e.component.projection=function(e){if(0===e.children.length)return;var r,t=J(e.children,function(e){bs(e);var t=e.component.projection;if(t){if(r){var n=function(t,n){var e=J(vs,function(e){return!t.explicit.hasOwnProperty(e)&&!n.explicit.hasOwnProperty(e)||!(!t.explicit.hasOwnProperty(e)||!n.explicit.hasOwnProperty(e)||Y(t.get(e))!==Y(n.get(e)))});if(Y(t.size)===Y(n.size)){if(e)return t;if(Y(t.explicit)===Y({}))return n;if(Y(n.explicit)===Y({}))return t}return null}(r,t);return n&&(r=n),!!n}return r=t,!0}return!0});if(r&&t){var n=e.projectionName(!0),i=new ys(n,r.specifiedProjection,r.size,pe(r.data));return e.children.forEach(function(e){e.component.projection&&(i.data=i.data.concat(e.component.projection.data),e.renameProjection(e.component.projection.get("name"),n),e.component.projection.merged=!0)}),i}return}(e)}var xs=function(i){function d(e,t,n){var r=i.call(this,e)||this;return r.dimensions=t,r.measures=n,r}return h(d,i),d.prototype.clone=function(){return new d(null,ne({},this.dimensions),pe(this.measures))},d.makeFromEncoding=function(e,u){var t=!1;u.forEachFieldDef(function(e){e.aggregate&&(t=!0)});var s={},l={};return t?(u.forEachFieldDef(function(e,t){var n,r,i,o=e.aggregate,a=e.field;o?"count"===o?(s["*"]=s["*"]||{},s["*"].count=$t(e,{forAs:!0})):(s[a]=s[a]||{},s[a][o]=$t(e,{forAs:!0}),Wr(t)&&"unaggregated"===u.scaleDomain(t)&&(s[a].min=$t({field:a,aggregate:"min"},{forAs:!0}),s[a].max=$t({field:a,aggregate:"max"},{forAs:!0}))):(n=l,r=t,Qr((i=e).bin)?(n[$t(i,{})]=!0,n[$t(i,{binSuffix:"end"})]=!0,nf(i,r)&&(n[$t(i,{binSuffix:"range"})]=!0)):n[$t(i)]=!0)}),ce(l).length+ce(s).length===0?null:new d(e,l,s)):null},d.makeFromTransform=function(e,t){for(var n={},r={},i=0,o=t.aggregate;i<o.length;i++){var a=(f=o[i]).op,u=f.field,s=f.as;a&&("count"===a?(r["*"]=r["*"]||{},r["*"].count=s||$t(f,{forAs:!0})):(r[u]=r[u]||{},r[u][a]=s||$t(f,{forAs:!0})))}for(var l=0,c=t.groupby||[];l<c.length;l++){var f;n[f=c[l]]=!0}return ce(n).length+ce(r).length===0?null:new d(e,n,r)},d.prototype.merge=function(e){ae(this.dimensions,e.dimensions)?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];Ke.debug.apply(Ke,arguments)}("different dimensions, cannot merge"):(!function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];for(var i in r)r.hasOwnProperty(i)&&(n in e?e[n][i]=r[i]:e[n]={op:r[i]})}}(this.measures,e.measures),e.remove())},d.prototype.addDimensions=function(e){var t=this;e.forEach(function(e){return t.dimensions[e]=!0})},d.prototype.dependentFields=function(){var t={};return ce(this.dimensions).forEach(function(e){return t[e]=!0}),ce(this.measures).forEach(function(e){return t[e]=!0}),t},d.prototype.producedFields=function(){for(var e={},t=0,n=ce(this.measures);t<n.length;t++)for(var r=n[t],i=0,o=ce(this.measures[r]);i<o.length;i++){var a=o[i];e[this.measures[r][a]||a+"_"+r]=!0}return e},d.prototype.hash=function(){return"Aggregate "+V({dimensions:this.dimensions,measures:this.measures})},d.prototype.assemble=function(){for(var e=[],t=[],n=[],r=0,i=ce(this.measures);r<i.length;r++)for(var o=i[r],a=0,u=ce(this.measures[o]);a<u.length;a++){var s=u[a];n.push(this.measures[o][s]),e.push(s),t.push(Se(o))}return{type:"aggregate",groupby:ce(this.dimensions),ops:e,fields:t,as:n}},d}(oa);function Ss(e){for(var t=0,n=e;t<n.length;t++){for(var r=n[t],i=0,o=r.children;i<o.length;i++){var a=o[i];if(a.parent!==r)return console.error("Dataflow graph is inconsistent.",parent,a),!1}if(!Ss(r.children))return!1}return!0}var ws=function(f){function e(e,t,n,r){var i=f.call(this,e)||this;i.model=t,i.name=n,i.data=r;for(var o=0,a=[dr,fr];o<a.length;o++){var u=a[o],s=t.facet[u];if(s){var l=s.bin,c=s.sort;i[u]=ne({name:t.getName(u+"_domain"),fields:[$t(s)].concat(Qr(l)?[$t(s,{binSuffix:"end"})]:[])},Jo(c)?{sortField:c}:w(c)?{sortIndexField:Tu(s,u)}:{})}}return i.childModel=t.child,i}return h(e,f),e.prototype.hash=function(){var e="Facet";return this.column&&(e+=" c:"+V(this.column)),this.row&&(e+=" r:"+V(this.row)),e},Object.defineProperty(e.prototype,"fields",{get:function(){return(this.column&&this.column.fields||[]).concat(this.row&&this.row.fields||[])},enumerable:!0,configurable:!0}),e.prototype.getSource=function(){return this.name},e.prototype.getChildIndependentFieldsWithStep=function(){for(var e={},t=0,n=["x","y"];t<n.length;t++){var r=n[t],i=this.childModel.component.scales[r];if(i&&!i.merged){var o=i.get("type"),a=i.get("range");if(gi(o)&&Ho(a)){var u=Vs(Xs(this.childModel,r));u?e[r]=u:Je("Unknown field for ${channel}.  Cannot calculate view size.")}}}return e},e.prototype.assembleRowColumnData=function(e,t,n){var r="row"===e?"y":"x",i=[],o=[],a=[];n[r]&&(t?(i.push("distinct_"+n[r]),o.push("max")):(i.push(n[r]),o.push("distinct")),a.push("distinct_"+n[r]));var u=this[e],s=u.sortField,l=u.sortIndexField;if(s){var c=s.op,f=s.field;i.push(f),o.push(c),a.push($t(s,{forAs:!0}))}else l&&(i.push(l),o.push("max"),a.push(l));return{name:this[e].name,source:t||this.data,transform:[ne({type:"aggregate",groupby:this[e].fields},i.length?{fields:i,ops:o,as:a}:{})]}},e.prototype.assemble=function(){var e=[],t=null,n=this.getChildIndependentFieldsWithStep();if(this.column&&this.row&&(n.x||n.y)){t="cross_"+this.column.name+"_"+this.row.name;var r=[].concat(n.x?[n.x]:[],n.y?[n.y]:[]),i=r.map(function(){return"distinct"});e.push({name:t,source:this.data,transform:[{type:"aggregate",groupby:this.column.fields.concat(this.row.fields),fields:r,ops:i}]})}for(var o=0,a=[dr,fr];o<a.length;o++){var u=a[o];this[u]&&e.push(this.assembleRowColumnData(u,t,n))}return e},e}(oa);var Es=function(r){function g(e,t){var n=r.call(this,e)||this;return n._parse=t,n}return h(g,r),g.prototype.clone=function(){return new g(null,pe(this._parse))},g.prototype.hash=function(){return"Parse "+V(this._parse)},g.makeExplicit=function(e,t,n){var r={},i=t.data;return i&&i.format&&i.format.parse&&(r=i.format.parse),this.makeWithAncestors(e,r,{},n)},g.makeImplicitFromFilterTransform=function(e,t,n){var r={};return function e(t,n){if(H(t))e(t.not,n);else if(q(t))for(var r=0,i=t.and;r<i.length;r++)e(i[r],n);else if(M(t))for(var o=0,a=t.or;o<a.length;o++)e(a[o],n);else n(t)}(t.filter,function(e){if(mc(e)){var t=null;sc(e)?t=e.equal:pc(e)?t=e.range[0]:hc(e)&&(t=(e.oneOf||e.in)[0]),t&&($e(t)?r[e.field]="date":te(t)?r[e.field]="number":m(t)&&(r[e.field]="string")),e.timeUnit&&(r[e.field]="date")}}),0===ce(r).length?null:this.makeWithAncestors(e,{},r,n)},g.makeImplicitFromEncoding=function(e,t,n){var r={};return(bl(t)||xl(t))&&t.forEachFieldDef(function(e){wn(e)?r[e.field]="date":Sn(e)&&Fe(e.aggregate)?r[e.field]="number":1<Ee(e.field)?e.field in r||(r[e.field]="flatten"):Qt(e)&&Jo(e.sort)&&1<Ee(e.sort.field)&&(e.sort.field in r||(r[e.sort.field]="flatten"))}),this.makeWithAncestors(e,{},r,n)},g.makeWithAncestors=function(e,t,n,r){for(var i=0,o=ce(n);i<o.length;i++){var a=o[i];void 0!==(l=r.getWithExplicit(a)).value&&(l.explicit||l.value===n[a]||"derived"===l.value||"flatten"===n[a]?delete n[a]:Je(Be.differentParse(a,n[a],l.value)))}for(var u=0,s=ce(t);u<s.length;u++){var l;a=s[u];void 0!==(l=r.get(a))&&(l===t[a]?delete t[a]:Je(Be.differentParse(a,t[a],l)))}var c=new Vu(t,n);r.copyAll(c);for(var f={},d=0,p=ce(c.combine());d<p.length;d++){var h=p[d],m=c.get(h);null!==m&&(f[h]=m)}return 0===ce(f).length||r.parseNothing?null:new g(e,f)},Object.defineProperty(g.prototype,"parse",{get:function(){return this._parse},enumerable:!0,configurable:!0}),g.prototype.merge=function(e){this._parse=ne({},this._parse,e.parse),e.remove()},g.prototype.assembleFormatParse=function(){for(var e={},t=0,n=ce(this._parse);t<n.length;t++){var r=n[t],i=this._parse[r];1===Ee(r)&&(e[r]=i)}return e},g.prototype.producedFields=function(){return f(ce(this._parse))},g.prototype.dependentFields=function(){return f(ce(this._parse))},g.prototype.assembleTransforms=function(t){var o=this;return void 0===t&&(t=!1),ce(this._parse).filter(function(e){return!t||1<Ee(e)}).map(function(e){var t,n,r,i=(t=e,n=o._parse[e],r=be(t),"number"===n?"toNumber("+r+")":"boolean"===n?"toBoolean("+r+")":"string"===n?"toString("+r+")":"date"===n?"toDate("+r+")":"flatten"===n?r:0!==n.indexOf("date:")?0!==n.indexOf("utc:")?(Je(Be.unrecognizedParse(n)),null):"utcParse("+r+","+n.slice(4,n.length)+")":"timeParse("+r+","+n.slice(5,n.length)+")");return i?{type:"formula",expr:i,as:we(e)}:null}).filter(function(e){return null!==e})},g}(oa),ks=function(o){function e(e){var t=o.call(this,null)||this;if(ds(e=e||{name:"source"}))t._data={values:e.values};else if(fs(e)){if(t._data={url:e.url},e.format||(e.format={}),!e.format||!e.format.type){var n=/(?:\.([^.]+))?$/.exec(e.url)[1];X(["json","csv","tsv","dsv","topojson"],n)||(n="json"),e.format.type=n}}else ps(e)&&(t._data={});if(e.name&&(t._name=e.name),e.format){var r=e.format,i=(r.parse,re(r,["parse"]));t._data.format=i}return t}return h(e,o),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.hasName=function(){return!!this._name},Object.defineProperty(e.prototype,"dataName",{get:function(){return this._name},set:function(e){this._name=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{set:function(e){throw new Error("Source nodes have to be roots.")},enumerable:!0,configurable:!0}),e.prototype.remove=function(){throw new Error("Source nodes are roots and cannot be removed.")},e.prototype.hash=function(){throw new Error("Cannot hash sources")},e.prototype.assemble=function(){return ne({name:this._name},this._data,{transform:[]})},e}(oa),Cs=function(){function e(){this._mutated=!1}return e.prototype.setMutated=function(){this._mutated=!0},Object.defineProperty(e.prototype,"mutatedFlag",{get:function(){return this._mutated},enumerable:!0,configurable:!0}),e}(),Ns=function(t){function e(){var e=t.call(this)||this;return e._continue=!1,e}return h(e,t),e.prototype.setContinue=function(){this._continue=!0},Object.defineProperty(e.prototype,"continueFlag",{get:function(){return this._continue},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"flags",{get:function(){return{continueFlag:this.continueFlag,mutatedFlag:this.mutatedFlag}},set:function(e){var t=e.continueFlag,n=e.mutatedFlag;t&&this.setContinue(),n&&this.setMutated()},enumerable:!0,configurable:!0}),e.prototype.optimizeNextFromLeaves=function(e){if(e instanceof ks)return!1;var t=e.parent;return this.run(e).continueFlag&&this.optimizeNextFromLeaves(t),this.mutatedFlag},e}(Cs),Os=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t}(Cs),As=function(r){function i(e,t){var n=r.call(this,e)||this;return n.formula=t,n}return h(i,r),i.prototype.clone=function(){return new i(null,pe(this.formula))},i.makeFromEncoding=function(e,t){var n=t.reduceFieldDef(function(e,t){if(t.timeUnit){var n=$t(t,{forAs:!0});e[n]={as:n,timeUnit:t.timeUnit,field:t.field}}return e},{});return 0===ce(n).length?null:new i(e,n)},i.makeFromTransform=function(e,t){var n;return new i(e,((n={})[t.field]={as:t.as,timeUnit:t.timeUnit,field:t.field},n))},i.prototype.merge=function(e){this.formula=ne({},this.formula,e.formula),e.remove()},i.prototype.producedFields=function(){var t={};return fe(this.formula).forEach(function(e){t[e.as]=!0}),t},i.prototype.dependentFields=function(){var t={};return fe(this.formula).forEach(function(e){t[e.field]=!0}),t},i.prototype.hash=function(){return"TimeUnit "+V(this.formula)},i.prototype.assemble=function(){return fe(this.formula).map(function(e){return{type:"formula",as:e.as,expr:Ct(e.timeUnit,e.field)}})},i}(oa),_s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.run=function(e){var t=e.parent;if(e instanceof Es){if(t instanceof ks)return this.flags;if(1<t.numChildren())return this.setContinue(),this.flags;if(t instanceof Es)this.setMutated(),t.merge(e);else{if(le(t.producedFields(),e.dependentFields()))return this.setContinue(),this.flags;this.setMutated(),e.swapWithParent()}}return this.setContinue(),this.flags},t}(Ns),Ts=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.mergeNodes=function(e,t){for(var n=t.shift(),r=0,i=t;r<i.length;r++){var o=i[r];e.removeChild(o),o.parent=n,o.remove()}},t.prototype.run=function(e){for(var t=e.children.map(function(e){return e.hash()}),n={},r=0;r<t.length;r++)void 0===n[t[r]]?n[t[r]]=[e.children[r]]:n[t[r]].push(e.children[r]);for(var i=0,o=ce(n);i<o.length;i++){var a=o[i];1<n[a].length&&(this.setMutated(),this.mergeNodes(e,n[a]))}for(var u=0,s=e.children;u<s.length;u++){var l=s[u];this.run(l)}return this.mutatedFlag},t}(Os),Ds=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.run=function(e){return e instanceof aa||0<e.numChildren()||e instanceof ws||(this.setMutated(),e.remove()),this.flags},t}(Ns),zs=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.fields={},e}return h(e,t),e.prototype.run=function(e){var t=this;if(this.setContinue(),e instanceof As){var n=e.producedFields();ce(n).every(function(e){return!!t.fields[e]})?(this.setMutated(),e.remove()):this.fields=ne({},this.fields,n)}return this.flags},e}(Ns);var Fs=function(r){function p(e,t){var n=r.call(this,e)||this;return n._stack=t,n}return h(p,r),p.prototype.clone=function(){return new p(null,pe(this._stack))},p.makeFromTransform=function(e,t){var n,r=t.stack,i=t.groupby,o=t.as,a=t.offset,u=void 0===a?"zero":a,s=[],l=[];if(void 0!==t.sort)for(var c=0,f=t.sort;c<f.length;c++){var d=f[c];s.push(d.field),l.push(ke(d.order,"ascending"))}return new p(e,{stackField:r,groupby:i,offset:u,sort:{field:s,order:l},facetby:[],as:w(n=o)&&n.every(function(e){return m(e)})&&1<n.length?o:m(o)?[o,o+"_end"]:[t.stack+"_start",t.stack+"_end"]})},p.makeFromEncoding=function(e,t){var n,r=t.stack;if(!r)return null;r.groupbyChannel&&(n=t.fieldDef(r.groupbyChannel));var i,o=t.stack.stackBy.reduce(function(e,t){var n=$t(t.fieldDef);return n&&e.push(n),e},[]),a=t.encoding.order;return i=w(a)||Yt(a)?Zc(a):o.reduce(function(e,t){return e.field.push(t),e.order.push("descending"),e},{field:[],order:[]}),new p(e,{dimensionFieldDef:n,stackField:t.vgField(r.fieldChannel),facetby:[],stackby:o,sort:i,offset:r.offset,impute:r.impute,as:[t.vgField(r.fieldChannel,{suffix:"start",forAs:!0}),t.vgField(r.fieldChannel,{suffix:"end",forAs:!0})]})},Object.defineProperty(p.prototype,"stack",{get:function(){return this._stack},enumerable:!0,configurable:!0}),p.prototype.addDimensions=function(e){this._stack.facetby=this._stack.facetby.concat(e)},p.prototype.dependentFields=function(){var t={};t[this._stack.stackField]=!0,this.getGroupbyFields().forEach(function(e){return t[e]=!0}),this._stack.facetby.forEach(function(e){return t[e]=!0});var e=this._stack.sort.field;return w(e)?e.forEach(function(e){return t[e]=!0}):t[e]=!0,t},p.prototype.producedFields=function(){return this._stack.as.reduce(function(e,t){return e[t]=!0,e},{})},p.prototype.hash=function(){return"Stack "+V(this._stack)},p.prototype.getGroupbyFields=function(){var e=this._stack,t=e.dimensionFieldDef,n=e.impute,r=e.groupby;return t?t.bin?n?[$t(t,{binSuffix:"mid"})]:[$t(t,{}),$t(t,{binSuffix:"end"})]:[$t(t)]:r||[]},p.prototype.assemble=function(){var e=[],t=this._stack,n=t.facetby,r=t.dimensionFieldDef,i=t.stackField,o=t.stackby,a=t.sort,u=t.offset,s=t.impute,l=t.as;return s&&r&&(r.bin&&e.push({type:"formula",expr:"("+$t(r,{expr:"datum"})+"+"+$t(r,{expr:"datum",binSuffix:"end"})+")/2",as:$t(r,{binSuffix:"mid",forAs:!0})}),e.push({type:"impute",field:i,groupby:o,key:$t(r,{binSuffix:"mid"}),method:"value",value:0})),e.push({type:"stack",groupby:this.getGroupbyFields().concat(n),field:i,sort:a,as:l,offset:u}),e},p}(oa),Is=function(r){function e(e,t){var n=r.call(this,e)||this;return n.transform=t,n}return h(e,r),e.prototype.clone=function(){return new e(null,pe(this.transform))},e.prototype.addDimensions=function(e){this.transform.groupby=oe(this.transform.groupby.concat(e),function(e){return e})},e.prototype.dependentFields=function(){var t={};return this.transform.groupby.forEach(function(e){return t[e]=!0}),this.transform.sort.forEach(function(e){return t[e.field]=!0}),this.transform.window.map(function(e){return e.field}).filter(function(e){return void 0!==e}).forEach(function(e){return t[e]=!0}),t},e.prototype.producedFields=function(){var t=this,n={};return this.transform.window.forEach(function(e){return n[t.getDefaultName(e)]=!0}),n},e.prototype.getDefaultName=function(e){return e.as||$t(e)},e.prototype.hash=function(){return"WindowTransform "+V(this.transform)},e.prototype.assemble=function(){for(var e=[],t=[],n=[],r=[],i=0,o=this.transform.window;i<o.length;i++){var a=o[i];t.push(a.op),n.push(this.getDefaultName(a)),r.push(void 0===a.param?null:a.param),e.push(void 0===a.field?null:a.field)}var u=this.transform.frame,s=this.transform.groupby,l=[],c=[];if(void 0!==this.transform.sort)for(var f=0,d=this.transform.sort;f<d.length;f++){var p=d[f];l.push(p.field),c.push(p.order||"ascending")}var h={field:l,order:c},m=this.transform.ignorePeers,g={type:"window",params:r,as:n,ops:t,fields:e,sort:h};return void 0!==m&&(g.ignorePeers=m),void 0!==s&&(g.groupby=s),void 0!==u&&(g.frame=u),g},e}(oa),Rs="scale_",Ls=5;function js(e){if(e instanceof ws)if(1!==e.numChildren()||e.children[0]instanceof aa){var t=e.model.component.data.main;!function e(t){if(t instanceof aa&&t.type===hs&&1===t.numChildren()){var n=t.children[0];n instanceof ws||(n.swapWithParent(),e(t))}}(t);for(var n=(a=e,function e(t){if(t instanceof ws)return Z(t.children.map(e));var n=t.clone();if(n instanceof aa){var r=Rs+n.getSource();n.setSource(r),a.model.component.data.outputNodes[r]=n}else(n instanceof xs||n instanceof Fs||n instanceof Is)&&n.addDimensions(a.fields);return Z(t.children.map(e)).forEach(function(e){return e.parent=n}),[n]}),r=0,i=Z(e.children.map(n));r<i.length;r++){i[r].parent=t}}else{var o=e.children[0];(o instanceof xs||o instanceof Fs||o instanceof Is)&&o.addDimensions(e.fields),o.swapWithParent(),js(e)}else e.children.map(js);var a}var Us=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.run=function(e){e instanceof aa&&!e.isRequired()&&(this.setMutated(),e.remove());for(var t=0,n=e.children;t<n.length;t++){var r=n[t];this.run(r)}return this.mutatedFlag},t}(Os);function Ps(e){var n=[];return e.forEach(function e(t){0===t.numChildren()?n.push(t):t.children.forEach(e)}),n}var Ms=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.run=function(e){var t=e.parent,n=t.children.filter(function(e){return e instanceof Es});if(1<n.length){for(var r={},i=0,o=n;i<o.length;i++)for(var a=(p=o[i]).parse,u=0,s=ce(a);u<s.length;u++){var l=s[u];void 0===r[l]?r[l]=a[l]:r[l]!==a[l]&&delete r[l]}if(0!==ce(r).length){this.setMutated();for(var c=new Es(t,r),f=0,d=n;f<d.length;f++){for(var p=d[f],h=0,m=ce(r);h<m.length;h++){var g=m[h];delete p.parse[g]}t.removeChild(p),p.parent=c,0===ce(p.parse).length&&p.remove()}}}return this.setContinue(),this.flags},t}(Ns);function qs(e){return e}function Hs(n,e,t){return e.map(function(e){var t=new n;return t instanceof Ns?t.optimizeNextFromLeaves(e):t.run(e)}).some(qs)||t}function Ws(e){var t=e.sources,n=!1;return n=Hs(Us,t,n),t=t.filter(function(e){return 0<e.numChildren()}),n=Hs(Ds,Ps(t),n),t=t.filter(function(e){return 0<e.numChildren()}),n=Hs(_s,Ps(t),n),n=Hs(zs,Ps(t),n),n=Hs(Ms,Ps(t),n),n=Hs(Ts,t,n),e.sources=t,n}function Bs(e){var h,m,g;bl(e)?(m=(h=e).specifiedScales,g=h.component.scales,ce(g).forEach(function(e){var t,n,r,i,o=m[e],a=o?o.domain:void 0,u=(n=e,r=(t=h).getScaleComponent(n).get("type"),(i=function(e,t,n,r){if("unaggregated"===e){var i=Ys(t,n),o=i.valid,a=i.reason;if(!o)return void Je(a)}else if(void 0===e&&r.useUnaggregatedDomain){var o=Ys(t,n).valid;if(o)return"unaggregated"}return e}(t.scaleDomain(n),t.fieldDef(n),r,t.config.scale))!==t.scaleDomain(n)&&(t.specifiedScales[n]=ne({},t.specifiedScales[n],{domain:i})),"x"===n&&t.channelHasField("x2")?t.channelHasField("x")?Gs(r,i,t,"x").concat(Gs(r,i,t,"x2")):Gs(r,i,t,"x2"):"y"===n&&t.channelHasField("y2")?t.channelHasField("y")?Gs(r,i,t,"y").concat(Gs(r,i,t,"y2")):Gs(r,i,t,"y2"):Gs(r,i,t,n)),s=g[e];if(s.domains=u,Ei(a)&&s.set("domainRaw",{signal:Zl+V(a)},!0),h.component.data.isFaceted){for(var l=h;!xl(l)&&l.parent;)l=l.parent;var c=l.component.resolve.scale[e];if("shared"===c)for(var f=0,d=u;f<d.length;f++){var p=d[f];Wo(p)&&(p.data=Rs+p.data.replace(Rs,""))}}})):function(s){for(var e=0,t=s.children;e<t.length;e++){var n=t[e];Bs(n)}var l=s.component.scales;ce(l).forEach(function(e){for(var t,n=null,r=0,i=s.children;r<i.length;r++){var o=i[r],a=o.component.scales[e];if(a){t=void 0===t?a.domains:t.concat(a.domains);var u=a.get("domainRaw");n&&u&&n.signal!==u.signal&&Je("The same selection must be used to override scale domains in a layered view."),n=u}}l[e].domains=t,n&&l[e].set("domainRaw",n,!0)})}(e)}function Gs(e,t,n,r){var i,o,a=n.fieldDef(r);if(t&&"unaggregated"!==t&&!Ei(t)){var u=a.type,s=a.timeUnit;return"temporal"===u||s?(i=u,o=s,t.map(function(e){return{signal:"{data: "+En(e,{timeUnit:o,type:i})+"}"}})):[t]}var l=n.stack;if(l&&r===l.fieldChannel)return"normalize"===l.offset?[[0,1]]:[{data:f=n.requestDataName(hs),field:n.vgField(r,{suffix:"start"})},{data:f,field:n.vgField(r,{suffix:"end"})}];var c=Wr(r)?function(e,t,n){if(!gi(n))return;var r=e.fieldDef(t),i=r.sort;if(Zo(i))return{op:"min",field:Tu(r,t),order:"ascending"};if(Jo(i))return ne({},i,i.field?{field:Se(i.field)}:{});if("descending"===i)return{op:"min",field:e.vgField(t),order:"descending"};if(X(["ascending",void 0],i))return!0;return}(n,r,e):void 0;if("unaggregated"===t){var f=n.requestDataName(hs),d=a.field;return[{data:f,field:$t({field:d,aggregate:"min"})},{data:f,field:$t({field:d,aggregate:"max"})}]}if(!Qr(a.bin))return c?[{data:he(c)?n.requestDataName(hs):n.requestDataName(ms),field:n.vgField(r),sort:c}]:[{data:n.requestDataName(hs),field:n.vgField(r)}];if(vi(e)){var p=n.getName(Xr(a.bin)+"_"+a.field+"_bins");return[{signal:"sequence("+p+".start, "+p+".stop + "+p+".step, "+p+".step)"}]}return gi(e)?[{data:he(c)?n.requestDataName(hs):n.requestDataName(ms),field:n.vgField(r,nf(a,r)?{binSuffix:"range"}:{}),sort:!0!==c&&Jo(c)?c:{field:n.vgField(r,{}),op:"min"}}]:"x"!==r&&"y"!==r?[{data:n.requestDataName(hs),field:n.vgField(r,{})}]:Jr(a.bin)&&a.bin.extent?[a.bin.extent]:[{data:f=n.requestDataName(hs),field:n.vgField(r,{})},{data:f,field:n.vgField(r,{binSuffix:"end"})}]}function Ys(e,t){return e.aggregate?Le[e.aggregate]?"quantitative"===e.type&&"log"===t?{valid:!1,reason:Be.unaggregatedDomainWithLogScale(e)}:{valid:!0}:{valid:!1,reason:Be.unaggregateDomainWithNonSharedDomainOp(e.aggregate)}:{valid:!1,reason:Be.unaggregateDomainHasNoEffectForRawField(e)}}function Vs(e){if(Wo(e)&&m(e.field))return e.field;if(w(n=e)||!("fields"in n)||"data"in n)return!w(t=e)&&"fields"in t&&"data"in t?(Je("Detected faceted independent scales that union domain of multiple fields from the same data source.  We will use the first field.  The result view size may be incorrect."),m(r=e.fields[0])?r:void 0):void 0;for(var t,n,r=void 0,i=0,o=e.fields;i<o.length;i++){var a=o[i];if(Wo(a)&&m(a.field))if(r){if(r!==a.field)return Je("Detected faceted independent scales that union domain of multiple fields from different data sources.  We will use the first field.  The result view size may be incorrect."),r}else r=a.field}return Je("Detected faceted independent scales that union domain of identical fields from different source detected.  We will assume that this is the same field from a different fork of the same data source.  However, if this is not case, the result view size maybe incorrect."),r}function Xs(t,e){return function(e){var t=oe(e.map(function(e){return Wo(e)?(e.sort,re(e,["sort"])):e}),V),n=oe(e.map(function(e){if(Wo(e)){var t=e.sort;return void 0===t||he(t)||("count"===t.op&&delete t.field,"ascending"===t.order&&delete t.order),t}}).filter(function(e){return void 0!==e}),V);if(1===t.length){if(Wo(a=e[0])&&0<n.length){var r=n[0];return 1<n.length&&(Je(Be.MORE_THAN_ONE_SORT),r=!0),ne({},a,{sort:r})}return a}var i,o=oe(n.map(function(e){return he(e)?e:"count"===e.op?e:(Je(Be.domainSortDropped(e)),!0)}),V);1===o.length?i=o[0]:1<o.length&&(Je(Be.MORE_THAN_ONE_SORT),i=!0);var a,u=oe(e.map(function(e){return Wo(e)?e.data:null}),function(e){return e});return 1!==u.length||null===u[0]?ne({fields:t},i?{sort:i}:{}):a=ne({data:u[0],fields:t.map(function(e){return e.field})},i?{sort:i}:{})}(t.component.scales[e].domains.map(function(e){return Wo(e)&&(e.data=t.lookupDataSource(e.data)),e}))}function Qs(l){return ce(l.component.scales).reduce(function(e,t){var n=l.component.scales[t];if(n.merged)return e;var r=n.combine(),i=r.domainRaw,o=r.range,a=r.name,u=r.type,s=(r.domainRaw,r.range,re(r,["name","type","domainRaw","range"]));return o=function(e,t,n,r){if("x"===r||"y"===r){if(Ho(e))return{step:{signal:t+"_step"}};if(w(e)&&2===e.length){var i=e[0],o=e[1];if(0===i&&qo(o))return[0,{signal:n.getSizeName(o.signal)}];if(qo(i)&&0===o)return[{signal:n.getSizeName(i.signal)},0]}}return e}(o,a,l,t),i&&0<=i.signal.indexOf(Zl)&&(i=function(e,t){var n=JSON.parse(t.signal.replace(Zl,"")),r=me(n.selection),i=n.encoding,o=n.field,a=e.component.selection&&e.component.selection[r];{if(!a){if(a=e.getSelectionComponent(r,n.selection),i||o){if(i&&!o){var u=a.project.filter(function(e){return e.channel===i});!u.length||1<u.length?(o=a.project[0].field,Je((u.length?"Multiple ":"No ")+"matching "+v(i)+" encoding found for selection "+v(n.selection)+'. Using "field": '+v(o)+".")):o=u[0].field}}else o=a.project[0].field,1<a.project.length&&Je('A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": '+v(o)+".");return{signal:be(o,r)}}Je('Use "bind": "scales" to setup a binding for scales and selections within the same view.')}return{signal:"null"}}(l,i)),e.push(ne({name:a,type:u,domain:Xs(l,t)},i?{domainRaw:i}:{},{range:o},s)),e},[])}var Ks=function(r){function e(e,t){var n=r.call(this,{},{name:e})||this;return n.merged=!1,n.domains=[],n.setWithExplicit("type",t),n}return h(e,r),e}(Vu),Js=["shortTimeLabels"],Zs={width:200,height:200};function $s(e){return e&&!!e.scheme}var el={padding:5,timeFormat:"%b %d, %Y",countTitle:"Number of Records",invalidValues:"filter",view:Zs,mark:$n,area:{},bar:er,circle:{},geoshape:{},line:{},point:{},rect:{},rule:{color:"black"},square:{},text:{color:"black"},tick:tr,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:Si,projection:{},axis:{},axisX:{},axisY:{minExtent:30},axisLeft:{},axisRight:{},axisTop:{},axisBottom:{},axisBand:{},legend:Mu,selection:Zi,style:{},title:{}};function tl(e){return $(pe(el),e)}var nl=["view"].concat(Hn),rl=["padding","numberFormat","timeFormat","countTitle","stack","scale","selection","invalidValues","overlay"],il=ne({view:["width","height"]},Zn);function ol(e){e=pe(e);for(var t=0,n=rl;t<n.length;t++){delete e[o=n[t]]}if(e.axis)for(var r=0,i=Js;r<i.length;r++){var o=i[r];delete e.axis[o]}if(e.legend)for(var a=0,u=Js;a<u.length;a++){o=u[a];delete e.legend[o]}if(e.mark)for(var s=0,l=Jn;s<l.length;s++){o=l[s];delete e.mark[o]}for(var c=0,f=nl;c<f.length;c++){for(var d=f[c],p=0,h=Jn;p<h.length;p++){o=h[p];delete e[d][o]}var m=il[d];if(m)for(var g=0,v=m;g<v.length;g++){o=v[g];delete e[d][o]}al(e,d)}for(var y=0,b=Df();y<b.length;y++){delete e[b[y]]}for(var o in al(e,"title","group-title"),e)ee(e[o])&&0===ce(e[o]).length&&delete e[o];return 0<ce(e).length?e:void 0}function al(e,t,n,r){var i="title"===t?wo(e.title).mark:r?e[t][r]:e[t];"view"===t&&(n="cell");var o=ne({},i,e.style[t]);0<ce(o).length&&(e.style[n||t]=o),r||delete e[t]}var ul=Object.freeze({defaultViewConfig:Zs,isVgScheme:$s,defaultConfig:el,initConfig:tl,stripAndRedirectConfig:ol}),sl=["range","rangeStep","scheme"];function ll(e){var f,d;bl(e)?(d=(f=e).component.scales,Hr.forEach(function(e){var t=d[e];if(t){var n=f.getScaleComponent(e),r=f.specifiedScales[e],i=f.fieldDef(e),o="x"===e?"width":"y"===e?"height":void 0,a=o?!!f.component.layoutSize.get(o):void 0,u=n.get("type"),s=X(["point","band"],u)||!!r.rangeStep;o&&f.fit&&!a&&s&&(Je(Be.CANNOT_FIX_RANGE_STEP_WITH_FIT),a=!0);var l=function(e){var t=[],n=e.getScaleComponent("x"),r=n&&n.get("range");r&&Ho(r)&&te(r.step)&&t.push(r.step);var i=e.getScaleComponent("y"),o=i&&i.get("range");return o&&Ho(o)&&te(o.step)&&t.push(o.step),t}(f),c=function(e,t,n,r,i,o,a,u,s,l){for(var c=u||null===r.rangeStep,f=0,d=sl;f<d.length;f++){var p=d[f];if(void 0!==r[p]){var h=Ai(t,p),m=_i(e,p);if(h)if(m)Je(m);else switch(p){case"range":return Xu(r[p]);case"scheme":return Xu(cl(r[p]));case"rangeStep":var g=r[p];if(null!==g){if(!u)return Xu({step:g});Je(Be.rangeStepDropped(e))}}else Je(Be.scalePropertyNotWorkWithScaleType(t,p,e))}}return Qu(function(e,t,n,r,i,o,a,u,s,l){switch(e){case rr:case ir:if(X(["point","band"],t)&&!s)if(e===rr&&"text"===o){if(r.scale.textXRangeStep)return{step:r.scale.textXRangeStep}}else if(r.scale.rangeStep)return{step:r.scale.rangeStep};return e===ir&&yi(t)?[{signal:a},0]:[0,{signal:a}];case hr:var c=function(e,t,n){if(t)return 0;switch(e){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(Be.incompatibleChannel("size",e))}(o,i,r),f=function(e,t,n){var r=n.scale;switch(e){case"bar":case"tick":return void 0!==n.scale.maxBandSize?n.scale.maxBandSize:dl(t,n.scale)-1;case"line":case"trail":case"rule":return n.scale.maxStrokeWidth;case"text":return n.scale.maxFontSize;case"point":case"square":case"circle":if(n.scale.maxSize)return n.scale.maxSize;var i=dl(t,r);return(i-2)*(i-2)}throw new Error(Be.incompatibleChannel("size",e))}(o,u,r);return xi(t)?function(e,t,n){for(var r=[],i=(t-e)/(n-1),o=0;o<n;o++)r.push(e+o*i);return r}(c,f,fl(t,r,l,e)):[c,f];case pr:return"symbol";case mr:case gr:case vr:if("ordinal"===t)return"nominal"===n?"category":"ordinal";if(xi(t)){var d=fl(t,r,l,e);return r.range&&$s(r.range.ordinal)?ne({},r.range.ordinal,{count:d}):{scheme:"blues",count:d}}return bi(t)?["#f7fbff","#0e427f"]:"rect"===o||"geoshape"===o?"heatmap":"ramp";case wr:return[r.scale.minOpacity,r.scale.maxOpacity]}throw new Error("Scale range undefined for channel "+e)}(e,t,n,i,o,a,s,l,c,r.domain))}(e,u,i.type,r,f.config,t.get("zero"),f.mark,a,f.getName(o),l);t.setWithExplicit("range",c)}})):hl(e,"range")}function cl(e){if(wi(e)){var t={scheme:e.name};return e.count&&(t.count=e.count),e.extent&&(t.extent=e.extent),t}return{scheme:e}}function fl(e,t,n,r){switch(e){case"quantile":return t.scale.quantileCount;case"quantize":return t.scale.quantizeCount;case"threshold":return void 0!==n&&w(n)?n.length+1:(Je(Be.domainRequiredForThresholdScale(r)),3)}}function dl(e,t){return 0<e.length?Math.min.apply(null,e):t.rangeStep?t.rangeStep:21}function pl(e,t){var f,d,p;bl(e)?(d=t,p=(f=e).component.scales,ce(p).forEach(function(e){var t=f.specifiedScales[e],n=p[e],r=f.getScaleComponent(e),i=f.fieldDef(e),o=f.config,a=t[d],u=r.get("type"),s=Ai(u,d),l=_i(e,d);if(void 0!==a&&(s?l&&Je(l):Je(Be.scalePropertyNotWorkWithScaleType(u,d,e))),s&&void 0===l)if(void 0!==a)n.copyKeyFromObject(d,t);else{var c=function(e,t,n,r,i,o,a,u,s){var l=s.scale;switch(e){case"interpolate":return function(e,t){if(X([mr,gr,vr],e)&&bi(t))return"hcl"}(t,r);case"nice":return function(e,t,n){if(!n.bin&&!X([$r.TIME,$r.UTC],e))return!!X([rr,ir],t)||void 0}(r,t,n);case"padding":return function(e,t,n,r,i,o){if(X([rr,ir],e)){if(bi(t)){if(void 0!==n.continuousPadding)return n.continuousPadding;var a=i.type,u=i.orient;if("bar"===a&&!r.bin&&("vertical"===u&&"x"===e||"horizontal"===u&&"y"===e))return o.continuousBandSize}if(t===$r.POINT)return n.pointPadding}}(t,r,l,n,u,s.bar);case"paddingInner":return function(e,t,n){if(void 0===e)return X([rr,ir],t)?n.bandPaddingInner:void 0}(i,t,l);case"paddingOuter":return function(e,t,n,r,i){if(void 0===e)return X([rr,ir],t)&&n===$r.BAND?void 0!==i.bandPaddingOuter?i.bandPaddingOuter:r/2:void 0}(i,t,r,o,l);case"reverse":return function(e,t){if(yi(e)&&"descending"===t)return!0}(r,n.sort);case"zero":return function(e,t,n,r,i){if(n&&"unaggregated"!==n)return!1;if("size"===e&&"quantitative"===t.type&&!xi(i))return!0;if(t.bin||!X([rr,ir],e))return!1;var o=r.orient;return!X(["bar","area","line","trail"],r.type)||!("horizontal"===o&&"y"===e||"vertical"===o&&"x"===e)}(t,n,a,u,r)}return l[e]}(d,e,i,r.get("type"),r.get("padding"),r.get("paddingInner"),t.domain,f.markDef,o);void 0!==c&&n.set(d,c,!1)}})):hl(e,t)}function hl(o,a){for(var u=o.component.scales,e=0,t=o.children;e<t.length;e++){var n=t[e];"range"===a?ll(n):pl(n,a)}ce(u).forEach(function(e){for(var t,n=0,r=o.children;n<r.length;n++){var i=r[n].component.scales[e];if(i)t=Zu(t,i.getWithExplicit(a),a,"scale",Ku(function(e,t){switch(a){case"range":return e.step&&t.step?e.step-t.step:0}return 0}))}u[e].setWithExplicit(a,t)})}function ml(e,t,n,r,i){var o=function(e,t,n,r,i){switch(t.type){case"nominal":case"ordinal":if(Ar(e)||"discrete"===Yr(e))return"shape"===e&&"ordinal"===t.type&&Je(Be.discreteChannelCannotEncode(e,"ordinal")),"ordinal";if(X(["x","y"],e)){if(X(["rect","bar","rule"],n))return"band";if("bar"===n)return"band"}return"point";case"temporal":return Ar(e)?"sequential":"discrete"===Yr(e)?(Je(Be.discreteChannelCannotEncode(e,"temporal")),"ordinal"):"time";case"quantitative":if(Ar(e)){if(Qr(t.bin))return"bin-ordinal";var o=r||{},a=o.domain,u=void 0===a?void 0:a,s=o.range,l=void 0===s?void 0:s;return u&&w(u)&&2<u.length&&l&&w(l)&&2<l.length?"linear":"sequential"}return"discrete"===Yr(e)?(Je(Be.discreteChannelCannotEncode(e,"quantitative")),"ordinal"):Qr(t.bin)&&"x"!==e&&"y"!==e?"bin-linear":"linear";case"geojson":return}throw new Error(Be.invalidFieldType(t.type))}(t,n,r,e),a=e.type;return Wr(t)?void 0!==a?Di(t,a)?Ti(a,n.type,n.bin)?a:(Je(Be.scaleTypeNotWorkWithFieldDef(a,o)),o):(Je(Be.scaleTypeNotWorkWithChannel(t,a,o)),o):o:null}function gl(e){var a,u,s,l;bl(e)?e.component.scales=(u=(a=e).encoding,s=a.config,l=a.mark,Hr.reduce(function(e,t){var n,r,i=u[t];if(Yt(i)&&l===jn&&t===pr&&i.type===jt)return e;if(Yt(i)?r=(n=i).scale:Bt(i)?(n=i.condition,r=i.condition.scale):t===rr?n=mn(u.x2):t===ir&&(n=mn(u.y2)),n&&null!==r&&!1!==r){var o=ml(r=r||{},t,n,l,s.scale);e[t]=new Ks(a.scaleName(t+"",!0),{value:o,explicit:r.type===o})}return e},{})):e.component.scales=function(u){for(var s=u.component.scales={},l={},i=u.component.resolve,e=function(r){gl(r),ce(r.component.scales).forEach(function(e){if(i.scale[e]=i.scale[e]||function(e,t){if(El(t)||xl(t))return"shared";if(wl(t)||Sl(t))return X(jr,e)?"independent":"shared";throw new Error("invalid model type for resolve")}(e,u),"shared"===i.scale[e]){var t=l[e],n=r.component.scales[e].getWithExplicit("type");t?ii(t.value,n.value)?l[e]=Zu(t,n,"type","scale",vl):(i.scale[e]="independent",delete l[e]):l[e]=n}})},t=0,n=u.children;t<n.length;t++){var r=n[t];e(r)}return ce(l).forEach(function(e){var t=u.scaleName(e,!0),n=l[e];s[e]=new Ks(t,n);for(var r=0,i=u.children;r<i.length;r++){var o=i[r],a=o.component.scales[e];a&&(o.renameScale(a.get("name"),t),a.merged=!0)}}),s}(e)}var vl=Ku(function(e,t){return ai(e)-ai(t)});var yl=function(){function e(){this.nameMap={}}return e.prototype.rename=function(e,t){this.nameMap[e]=t},e.prototype.has=function(e){return void 0!==this.nameMap[e]},e.prototype.get=function(e){for(;this.nameMap[e]&&e!==this.nameMap[e];)e=this.nameMap[e];return e},e}();function bl(e){return e&&"unit"===e.type}function xl(e){return e&&"facet"===e.type}function Sl(e){return e&&"repeat"===e.type}function wl(e){return e&&"concat"===e.type}function El(e){return e&&"layer"===e.type}var kl=function(){function e(e,t,n,r,i,o){var a,u,s,l,c,f,d,p,h=this;this.children=[],this.correctDataNames=function(e){return e.from&&e.from.data&&(e.from.data=h.lookupDataSource(e.from.data)),e.from&&e.from.facet&&e.from.facet.data&&(e.from.facet.data=h.lookupDataSource(e.from.facet.data)),e},this.parent=t,this.config=r,this.repeater=i,this.name=e.name||n,this.title=m(e.title)?{text:e.title}:e.title,this.scaleNameMap=t?t.scaleNameMap:new yl,this.projectionNameMap=t?t.projectionNameMap:new yl,this.layoutSizeNameMap=t?t.layoutSizeNameMap:new yl,this.data=e.data,this.description=e.description,this.transforms=Po(e.transform||[]),this.layout=po(e)||ho(e)?void 0:(u=(a=e||{}).align,s=void 0===u?void 0:u,l=a.center,c=void 0===l?void 0:l,f=a.bounds,d=void 0===f?void 0:f,p=a.spacing,{align:s,bounds:d,center:c,spacing:void 0===p?void 0:p}),this.component={data:{sources:t?t.component.data.sources:[],outputNodes:t?t.component.data.outputNodes:{},outputNodeRefCounts:t?t.component.data.outputNodeRefCounts:{},isFaceted:fo(e)||t&&t.component.data.isFaceted&&!e.data},layoutSize:new Vu,layoutHeaders:{row:{},column:{}},mark:null,resolve:ne({scale:{},axis:{},legend:{}},o||{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}return Object.defineProperty(e.prototype,"width",{get:function(){return this.getSizeSignalRef("width")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.getSizeSignalRef("height")},enumerable:!0,configurable:!0}),e.prototype.initSize=function(e){var t=e.width,n=e.height;t&&this.component.layoutSize.set("width",t,!0),n&&this.component.layoutSize.set("height",n,!0)},e.prototype.parse=function(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSize(),this.parseSelection(),this.parseProjection(),this.parseData(),this.parseAxisAndHeader(),this.parseLegend(),this.parseMarkGroup()},e.prototype.parseScale=function(){!function(e){gl(e),Bs(e);for(var t=0,n=Ni;t<n.length;t++)pl(e,n[t]);ll(e)}(this)},e.prototype.parseProjection=function(){bs(this)},e.prototype.renameTopLevelLayoutSize=function(){"width"!==this.getName("width")&&this.renameLayoutSize(this.getName("width"),"width"),"height"!==this.getName("height")&&this.renameLayoutSize(this.getName("height"),"height")},e.prototype.parseLegend=function(){is(this)},e.prototype.assembleGroupStyle=function(){if("unit"===this.type||"layer"===this.type)return"cell"},e.prototype.assembleLayoutSize=function(){if("unit"===this.type||"layer"===this.type)return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},e.prototype.assembleLayout=function(){if(this.layout){var e=this.layout,t=e.align,n=e.bounds,r=e.center,i=e.spacing,o=void 0===i?{}:i;return ne({padding:te(o)?o:{row:o.row||10,column:o.column||10}},this.assembleDefaultLayout(),t?{align:t}:{},n?{bounds:n}:{},r?{center:r}:{})}},e.prototype.assembleDefaultLayout=function(){return{}},e.prototype.assembleHeaderMarks=function(){for(var e,t,n,r,i,o=this.component.layoutHeaders,a=[],u=0,s=Du;u<s.length;u++){o[f=s[u]].title&&a.push((t=f,void 0,n=(e=this).component.layoutHeaders[t].title,r=e.config?e.config:void 0,i=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0,{name:t+"-title",type:"group",role:t+"-title",title:ne({text:n,offset:10},"row"===t?{orient:"left"}:{},{style:"guide-title"},Ru(r,i,Xo,Yo))}))}for(var l=0,c=Du;l<c.length;l++){var f=c[l];a=a.concat(Fu(this,f))}return a},e.prototype.assembleAxes=function(){return e=this.component.axes,t=this.config,n=e.x,r=void 0===n?[]:n,i=e.y,o=void 0===i?[]:i,r.map(function(e){return Go(e,"main",t)}).concat(r.map(function(e){return Go(e,"grid",t)}),o.map(function(e){return Go(e,"main",t)}),o.map(function(e){return Go(e,"grid",t)})).filter(function(e){return e});var e,t,n,r,i,o},e.prototype.assembleLegends=function(){return ss(this)},e.prototype.assembleProjections=function(){return ls(this)},e.prototype.assembleTitle=function(){var e=this.title||{},t=e.encoding,n=re(e,["encoding"]),r=ne({},wo(this.config.title).nonMark,n,t?{encode:{update:t}}:{});if(r.text)return X(["unit","layer"],this.type)||(r.anchor&&"start"!==r.anchor&&Je(Be.cannotSetTitleAnchor(this.type)),r.anchor="start"),0<ce(r).length?r:void 0},e.prototype.assembleGroup=function(e){void 0===e&&(e=[]);var t={};0<(e=e.concat(this.assembleSelectionSignals())).length&&(t.signals=e);var n=this.assembleLayout();n&&(t.layout=n),t.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());var r=!this.parent||xl(this.parent)?function n(e){return El(e)||wl(e)||Sl(e)?e.children.reduce(function(e,t){return e.concat(n(t))},Qs(e)):Qs(e)}(this):[];0<r.length&&(t.scales=r);var i=this.assembleAxes();0<i.length&&(t.axes=i);var o=this.assembleLegends();return 0<o.length&&(t.legends=o),t},e.prototype.hasDescendantWithFieldOnChannel=function(e){for(var t=0,n=this.children;t<n.length;t++){var r=n[t];if(bl(r)){if(r.channelHasField(e))return!0}else if(r.hasDescendantWithFieldOnChannel(e))return!0}return!1},e.prototype.getName=function(e){return me((this.name?this.name+"_":"")+e)},e.prototype.requestDataName=function(e){var t=this.getName(e),n=this.component.data.outputNodeRefCounts;return n[t]=(n[t]||0)+1,t},e.prototype.getSizeSignalRef=function(e){if(xl(this.parent)){var t="width"===e?"x":"y",n=this.component.scales[t];if(n&&!n.merged){var r=n.get("type"),i=n.get("range");if(gi(r)&&Ho(i)){var o=n.get("name"),a=Vs(Xs(this,t));return a?{signal:Pu(o,n,$t({aggregate:"distinct",field:a},{expr:"datum"}))}:(Je("Unknown field for ${channel}.  Cannot calculate view size."),null)}}}return{signal:this.layoutSizeNameMap.get(this.getName(e))}},e.prototype.lookupDataSource=function(e){var t=this.component.data.outputNodes[e];return t?t.getSource():e},e.prototype.getSizeName=function(e){return this.layoutSizeNameMap.get(e)},e.prototype.renameLayoutSize=function(e,t){this.layoutSizeNameMap.rename(e,t)},e.prototype.renameScale=function(e,t){this.scaleNameMap.rename(e,t)},e.prototype.renameProjection=function(e,t){this.projectionNameMap.rename(e,t)},e.prototype.scaleName=function(e,t){return t?this.getName(e):zr(e)&&Wr(e)&&this.component.scales[e]||this.scaleNameMap.has(this.getName(e))?this.scaleNameMap.get(this.getName(e)):void 0},e.prototype.projectionName=function(e){return e?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0},e.prototype.getScaleComponent=function(e){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale().  Make sure you have called parseScale or use parseUnitModelWithScale().");var t=this.component.scales[e];return t&&!t.merged?t:this.parent?this.parent.getScaleComponent(e):void 0},e.prototype.getSelectionComponent=function(e,t){var n=this.component.selection[e];if(!n&&this.parent&&(n=this.parent.getSelectionComponent(e,t)),!n)throw new Error(Be.selectionNotFound(t));return n},e}(),Cl=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return h(t,e),t.prototype.vgField=function(e,t){void 0===t&&(t={});var n=this.fieldDef(e);if(n)return $t(n,t)},t.prototype.reduceFieldDef=function(i,e,t){return df(this.getMapping(),function(e,t,n){var r=mn(t);return r?i(e,r,n):e},e,t)},t.prototype.forEachFieldDef=function(r,e){ff(this.getMapping(),function(e,t){var n=mn(e);n&&r(n,t)},e)},t}(kl),Nl="_fields",Ol={has:function(e){return"interval"===e.type&&"global"===e.resolve&&e.bind&&"scales"===e.bind},parse:function(e,t,n){for(var r=me(n.name),i=n.scales=[],o=0,a=n.project;o<a.length;o++){var u=a[o],s=u.channel;if(Wr(s)){var l=e.getScaleComponent(s),c=l?l.get("type"):void 0;if(l&&yi(c)&&!vi(c)){if(l.set("domainRaw",{signal:be(u.field,r)},!0),i.push(s),e.repeater&&e.repeater.row===e.repeater.column)e.getScaleComponent(s===rr?ir:rr).set("domainRaw",{signal:be(u.field,r)},!0)}else Je(Be.SCALE_BINDINGS_CONTINUOUS)}}},topLevelSignals:function(e,n,r){var t=n.scales.filter(function(t){return!r.filter(function(e){return e.name===ac(n,t,"data")}).length}).map(function(e){return{channel:e,signal:ac(n,e,"data")}});if(!e.parent||!t.length)return r;var i=r.filter(function(e){return e.name===n.name})[0],o=i.update;if(0<=o.indexOf($l))i.update="{"+t.map(function(e){return n.fields[e.channel]+": "+e.signal}).join(", ")+"}";else for(var a=0,u=t;a<u.length;a++){var s=u[a],l=", "+n.fields[s.channel]+": "+s.signal;o.indexOf(l)<0&&(i.update=o.substring(0,o.length-1)+l+"}")}return r.concat(t.map(function(e){return{name:e.signal}}))},signals:function(e,n,r){if(e.parent)for(var t=function(t){var e=r.filter(function(e){return e.name===ac(n,t,"data")})[0];e.push="outer",delete e.value,delete e.update},i=0,o=n.scales;i<o.length;i++){t(o[i])}return r}};function Al(e,t){return"domain("+v(e.scaleName(t))+")"}var _l="_brush",Tl="_scale_trigger",Dl={signals:function(e,t){var n=t.name,r=n+Jl+Nl,i=Ol.has(t),o=[],a=[],u=[];if(t.translate&&!i){var s="!event.item || event.item.mark.name !== "+v(n+_l);Fl(t,function(e,t){var n=t.between[0].filter||(t.between[0].filter=[]);n.indexOf(s)<0&&n.push(s)})}for(var l=0,c=t.project;l<c.length;l++){var f=c[l].channel;if(f===rr||f===ir){var d=zl(e,t,f),p=ac(t,f,"data"),h=ac(t,f,"visual"),m=v(e.scaleName(f)),g=yi(e.getScaleComponent(f).get("type"))?"+":"";o.push.apply(o,d),a.push(p),u.push({scaleName:e.scaleName(f),expr:"(!isArray("+p+") || ("+g+"invert("+m+", "+h+")[0] === "+g+p+"[0] && "+g+"invert("+m+", "+h+")[1] === "+g+p+"[1]))"})}else Je("Interval selections only support x and y encoding channels.")}return i||o.push({name:n+Tl,update:u.map(function(e){return e.expr}).join(" && ")+" ? "+(n+Tl)+" : {}"}),o.concat({name:n+Jl,on:[{events:a.map(function(e){return{signal:e}}),update:a.join(" && ")+" ? {unit: "+ic(e)+", fields: "+r+", values: ["+a.join(", ")+"]} : null"}]})},modifyExpr:function(e,t){return t.name+Jl+", "+("global"===t.resolve?"true":"{unit: "+ic(e)+"}")},marks:function(e,t,n){var r=t.name,i=uc(t),o=i.xi,a=i.yi,u="data("+v(t.name+Kl)+")";if(Ol.has(t))return n;var s={x:null!==o?{signal:r+"_x[0]"}:{value:0},y:null!==a?{signal:r+"_y[0]"}:{value:0},x2:null!==o?{signal:r+"_x[1]"}:{field:{group:"width"}},y2:null!==a?{signal:r+"_y[1]"}:{field:{group:"height"}}};if("global"===t.resolve)for(var l=0,c=ce(s);l<c.length;l++){var f=c[l];s[f]=[ne({test:u+".length && "+u+"[0].unit === "+ic(e)},s[f]),{value:0}]}var d=t.mark,p=d.fill,h=d.fillOpacity,m=re(d,["fill","fillOpacity"]),g=ce(m).reduce(function(e,t){return e[t]=[{test:[null!==o&&r+"_x[0] !== "+r+"_x[1]",null!=a&&r+"_y[0] !== "+r+"_y[1]"].filter(function(e){return e}).join(" && "),value:m[t]},{value:null}],e},{});return[{name:r+_l+"_bg",type:"rect",clip:!0,encode:{enter:{fill:{value:p},fillOpacity:{value:h}},update:s}}].concat(n,{name:r+_l,type:"rect",clip:!0,encode:{enter:{fill:{value:"transparent"}},update:ne({},s,g)}})}};function zl(e,t,n){var r=ac(t,n,"visual"),i=ac(t,n,"data"),o=Ol.has(t),a=v(e.scaleName(n)),u=e.getScaleComponent(n),s=u?u.get("type"):void 0,l=e.getSizeSignalRef(n===rr?"width":"height").signal,c=n+"(unit)",f=Fl(t,function(e,t){return e.concat({events:t.between[0],update:"["+c+", "+c+"]"},{events:t,update:"["+r+"[0], clamp("+c+", 0, "+l+")]"})});return f.push({events:{signal:t.name+Tl},update:yi(s)&&!vi(s)?"[scale("+a+", "+i+"[0]), scale("+a+", "+i+"[1])]":"[0, 0]"}),o?[{name:i,on:[]}]:[{name:r,value:[],on:f},{name:i,on:[{events:{signal:r},update:r+"[0] === "+r+"[1] ? null : invert("+a+", "+r+")"}]}]}function Fl(e,n){return e.events.reduce(function(e,t){return t.between?n(e,t):(Je(t+" is not an ordered event stream for interval selections"),e)},[])}var Il="voronoi",Rl={has:function(e){return"interval"!==e.type&&e.nearest},marks:function(r,e,t){var n=uc(e),i=n.x,o=n.y,a=r.mark;if(qn(a))return Je(Be.nearestNotSupportForContinuous(a)),t;var u={name:r.getName(Il),type:"path",from:{data:r.getName("marks")},encode:{enter:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0}}},transform:[{type:"voronoi",x:{expr:i||!i&&!o?"datum.datum.x || 0":"0"},y:{expr:o||!i&&!o?"datum.datum.y || 0":"0"},size:[r.getSizeSignalRef("width"),r.getSizeSignalRef("height")]}]},s=0,l=!1;return t.forEach(function(e,t){var n=e.name||"";n===r.component.mark[0].name?s=t:0<=n.indexOf(Il)&&(l=!0)}),l||t.splice(s+1,0,u),t}};function Ll(n,e){var t=e.name,r=t+Jl+Nl,i=e.project,o=Rl.has(e)?"(item().isVoronoi ? datum.datum : datum)":"datum",a=i.map(function(e){var t=n.fieldDef(e.channel);return t&&t.bin?"["+be(n.vgField(e.channel,{}),o)+", "+be(n.vgField(e.channel,{binSuffix:"end"}),o)+"]":""+be(e.field,o)}).join(", ");return[{name:t+Jl,value:{},on:[{events:e.events,update:"datum && item().mark.marktype !== 'group' ? {unit: "+ic(n)+", fields: "+r+", values: ["+a+"]} : null",force:!0}]}]}var jl={signals:Ll,modifyExpr:function(e,t){return t.name+Jl+", "+("global"===t.resolve?"null":"{unit: "+ic(e)+"}")}},Ul={signals:Ll,modifyExpr:function(e,t){return t.name+Jl+", "+("global"===t.resolve?"true":"{unit: "+ic(e)+"}")}},Pl="_toggle",Ml="_translate_anchor",ql="_translate_delta",Hl={has:function(e){return"interval"===e.type&&e.translate},signals:function(e,t,n){var r=t.name,i=Ol.has(t),o=r+Ml,a=uc(t),u=a.x,s=a.y,l=Ii(t.translate,"scope");return i||(l=l.map(function(e){return e.between[0].markname=r+_l,e})),n.push({name:o,value:{},on:[{events:l.map(function(e){return e.between[0]}),update:"{x: x(unit), y: y(unit)"+(null!==u?", extent_x: "+(i?Al(e,rr):"slice("+ac(t,"x","visual")+")"):"")+(null!==s?", extent_y: "+(i?Al(e,ir):"slice("+ac(t,"y","visual")+")"):"")+"}"}]},{name:r+ql,value:{},on:[{events:l,update:"{x: "+o+".x - x(unit), y: "+o+".y - y(unit)}"}]}),null!==u&&Wl(e,t,rr,"width",n),null!==s&&Wl(e,t,ir,"height",n),n}};function Wl(e,t,n,r,i){var o=t.name,a=Ol.has(t),u=i.filter(function(e){return e.name===ac(t,n,a?"data":"visual")})[0],s=o+Ml,l=o+ql,c=e.getSizeSignalRef(r).signal,f=e.getScaleComponent(n),d=f.get("type"),p=s+".extent_"+n,h=(a?"log"===d?"panLog":"pow"===d?"panPow":"panLinear":"panLinear")+"("+p+", "+(""+(a&&n===rr?"-":"")+l+"."+n+" / "+(a?""+c:"span("+p+")"))+(a&&"pow"===d?", "+(f.get("exponent")||1):"")+")";u.on.push({events:{signal:l},update:a?h:"clampRange("+h+", 0, "+c+")"})}var Bl="_zoom_anchor",Gl="_zoom_delta",Yl={has:function(e){return"interval"===e.type&&e.zoom},signals:function(e,t,n){var r=t.name,i=Ol.has(t),o=r+Gl,a=uc(t),u=a.x,s=a.y,l=v(e.scaleName(rr)),c=v(e.scaleName(ir)),f=Ii(t.zoom,"scope");return i||(f=f.map(function(e){return e.markname=r+_l,e})),n.push({name:r+Bl,on:[{events:f,update:i?"{"+[l?"x: invert("+l+", x(unit))":"",c?"y: invert("+c+", y(unit))":""].filter(function(e){return!!e}).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:o,on:[{events:f,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),null!==u&&Vl(e,t,"x","width",n),null!==s&&Vl(e,t,"y","height",n),n}};function Vl(e,t,n,r,i){var o=t.name,a=Ol.has(t),u=i.filter(function(e){return e.name===ac(t,n,a?"data":"visual")})[0],s=e.getSizeSignalRef(r).signal,l=e.getScaleComponent(n),c=l.get("type"),f=a?Al(e,n):u.name,d=o+Gl,p=(a?"log"===c?"zoomLog":"pow"===c?"zoomPow":"zoomLinear":"zoomLinear")+"("+f+", "+(""+o+Bl+"."+n)+", "+d+(a&&"pow"===c?", "+(l.get("exponent")||1):"")+")";u.on.push({events:{signal:d},update:a?p:"clampRange("+p+", 0, "+s+")"})}var Xl={project:{has:function(e){var t=e;return void 0!==t.fields||void 0!==t.encodings},parse:function(e,t,n){var r={},i={},o=n.project||(n.project=[]);n.fields={},t.fields&&o.push.apply(o,t.fields.map(function(e){return{field:e,type:"E"}}));for(var a=0,u=t.encodings||[];a<u.length;a++){var s=u[a],l=e.fieldDef(s);if(l){var c=l.field;if(l.timeUnit&&(r[c=e.vgField(s)]={as:c,field:l.field,timeUnit:l.timeUnit}),!i[c]){var f="E";if("interval"===n.type){var d=e.getScaleComponent(s).get("type");yi(d)&&!vi(d)&&(f="R")}else l.bin&&(f="R-RE");o.push(i[c]={field:c,channel:s,type:f})}n.fields[s]=c}else Je(Be.cannotProjectOnChannelWithoutField(s))}ce(r).length&&(n.timeUnit=new As(null,r))},signals:function(e,t,n){var r=t.name+Jl+Nl;return n.filter(function(e){return e.name===r}).length?n:n.concat({name:r,update:""+JSON.stringify(t.project)})}},toggle:{has:function(e){return"multi"===e.type&&e.toggle},signals:function(e,t,n){return n.concat({name:t.name+Pl,value:!1,on:[{events:t.events,update:t.toggle}]})},modifyExpr:function(e,t,n){var r=t.name+Jl,i=t.name+Pl;return i+" ? null : "+r+", "+("global"===t.resolve?i+" ? null : true, ":i+" ? null : {unit: "+ic(e)+"}, ")+i+" ? "+r+" : null"}},scales:Ol,translate:Hl,zoom:Yl,inputs:{has:function(e){return"single"===e.type&&"global"===e.resolve&&e.bind&&"scales"!==e.bind},topLevelSignals:function(e,n,r){for(var i=n.name,t=n.project,o=n.bind,a=Rl.has(n)?"(item().isVoronoi ? datum.datum : datum)":"datum",u=function(e){var t=me(i+"_"+e.field);r.filter(function(e){return e.name===t}).length||r.unshift({name:t,value:"",on:[{events:n.events,update:"datum && item().mark.marktype !== 'group' ? "+be(e.field,a)+" : null"}],bind:o[e.field]||o[e.channel]||o})},s=0,l=t;s<l.length;s++){u(l[s])}return r},signals:function(e,t,n){var r=t.name,i=t.project,o=n.filter(function(e){return e.name===r+Jl})[0],a=r+Jl+Nl,u=i.map(function(e){return me(r+"_"+e.field)}),s=u.map(function(e){return e+" !== null"}).join(" && ");return u.length&&(o.update=s+" ? {fields: "+a+", values: ["+u.join(", ")+"]} : null"),delete o.value,delete o.on,n}},nearest:Rl};function Ql(e,t){for(var n in Xl)Xl[n].has(e)&&t(Xl[n])}var Kl="_store",Jl="_tuple",Zl="_selection_domain_",$l="vlSelectionResolve";function ec(n,r){return nc(n,function(t,e){r=e.marks?e.marks(n,t,r):r,Ql(t,function(e){e.marks&&(r=e.marks(n,t,r))})}),r}function tc(a,e,u){var s=[];var t=ge(e,function(e){var t=me(e),n=a.getSelectionComponent(t,e),r=v(t+Kl);if(n.timeUnit){var i=u||a.component.data.raw,o=n.timeUnit.clone();i.parent?o.insertAsParentOf(i):i.parent=o}return"none"!==n.empty&&s.push(r),"vlSelectionTest("+r+", datum"+("global"===n.resolve?")":", "+v(n.resolve)+")")});return(s.length?"!("+s.map(function(e){return"length(data("+e+"))"}).join(" || ")+") || ":"")+"("+t+")"}function nc(e,t){var n=e.component.selection;for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];t(i,rc(i.type))}}function rc(e){switch(e){case"single":return Ul;case"multi":return jl;case"interval":return Dl}return null}function ic(e){var t=v(e.name),n=function(e){for(var t=e.parent;t&&!xl(t);)t=t.parent;return t}(e);return n&&(t+=(n.facet.row?" + '_' + ("+be(n.vgField("row"),"facet")+")":"")+(n.facet.column?" + '_' + ("+be(n.vgField("column"),"facet")+")":"")),t}function oc(e){var t=!1;return nc(e,function(e){t=t||e.project.some(function(e){return e.field===Ji})}),t}function ac(e,t,n){var r=e._signalNames||(e._signalNames={});if(r[t]&&r[t][n])return r[t][n];r[t]=r[t]||{};for(var i=me(e.name+"_"+("visual"===n?t:e.fields[t])),o=i,a=1;r[o];)o=i+"_"+a++;return r[o]=r[t][n]=o}function uc(e){var n=null,r=null,i=null,o=null;return e.project.forEach(function(e,t){e.channel===rr?(n=e,r=t):e.channel===ir&&(i=e,o=t)}),{x:n,xi:r,y:i,yi:o}}function sc(e){return e&&!!e.field&&void 0!==e.equal}function lc(e){return e&&!!e.field&&void 0!==e.lt}function cc(e){return e&&!!e.field&&void 0!==e.lte}function fc(e){return e&&!!e.field&&void 0!==e.gt}function dc(e){return e&&!!e.field&&void 0!==e.gte}function pc(e){return!!(e&&e.field&&w(e.range)&&2===e.range.length)}function hc(e){return e&&!!e.field&&(w(e.oneOf)||w(e.in))}function mc(e){return hc(e)||sc(e)||pc(e)||lc(e)||fc(e)||cc(e)||dc(e)}function gc(n,e,r){return ge(e,function(e){return m(e)?e:(t=e)&&t.selection?tc(n,e.selection,r):yc(e);var t})}function vc(e,t){return En(e,{timeUnit:t,time:!0})}function yc(e,t){void 0===t&&(t=!0);var n,r,i,o=e.field,a=e.timeUnit,u=a?"time("+Ct(a,o)+")":$t(e,{expr:"datum"});if(sc(e))return u+"==="+vc(e.equal,a);if(lc(e))return u+"<"+vc(l=e.lt,a);if(fc(e))return u+">"+vc(s=e.gt,a);if(cc(e))return u+"<="+vc(l=e.lte,a);if(dc(e))return u+">="+vc(s=e.gte,a);if(hc(e))return"indexof(["+(r=e.oneOf,i=a,r.map(function(e){return vc(e,i)})).join(",")+"], "+u+") !== -1";if((n=e)&&n.field&&void 0!==n.valid)return e.valid?u+"!==null&&!isNaN("+u+")":u+"===null||isNaN("+u+")";if(pc(e)){var s=e.range[0],l=e.range[1];if(null!==s&&null!==l&&t)return"inrange("+u+", ["+vc(s,a)+", "+vc(l,a)+"])";var c=[];return null!==s&&c.push(u+" >= "+vc(s,a)),null!==l&&c.push(u+" <= "+vc(l,a)),0<c.length?c.join(" && "):"true"}throw new Error("Invalid field predicate: "+JSON.stringify(e))}function bc(e){return mc(e)&&e.timeUnit?ne({},e,{timeUnit:At(e.timeUnit)}):e}function xc(e,t){var n=t[e+"Offset"];if(n)return n}function Sc(e,t,n,r){return wc(e,t,{binSuffix:"start"===n?void 0:"end"},r?{offset:r}:{})}function wc(e,t,n,r){var i=ne({},t?{scale:t}:{},{field:$t(e,n)});return r?ne({},i,r):i}function Ec(e,t){return void 0===t&&(t=!0),{scale:e,band:t}}function kc(e,t,n){return{signal:'scale("'+e+'", ('+$t(t,{expr:"datum"})+" + "+(void 0!==n?$t(n,{expr:"datum"}):$t(t,{binSuffix:"end",expr:"datum"}))+") / 2)"}}function Cc(e,t,n,r,i,o,a){if(t){if(Yt(t)){if(Qr(t.bin))return X([rr,ir],e)&&t.type===Ft?o&&o.impute?wc(t,r,{binSuffix:"mid"}):kc(r,t):wc(t,r,nf(t,e)?{binSuffix:"range"}:{});if(Kr(t.bin)){if(Yt(n))return kc(r,t,n);Je(Be.channelRequiredForBinned(e))}if(i){var u=i.get("type");if(gi(u))return"band"===u?wc(t,r,{binSuffix:"range"},{band:.5}):wc(t,r,{binSuffix:"range"})}return wc(t,r,{})}if(Xt(t)){var s=t.value;return X(["x","x2"],e)&&"width"===s?{field:{group:"width"}}:X(["y","y2"],e)&&"height"===s?{field:{group:"height"}}:{value:s}}}return"function"==typeof a?a():a}function Nc(e,t){for(var n=[],r={},i=0,o=e;i<o.length;i++){var a=o[i],u=cn(a,t,{allowDisabling:!1}),s=Oc(a,t).signal;r[u]||n.push('"'+u+'": '+s),r[u]=!0}return n.length?{signal:"{"+n.join(", ")+"}"}:void 0}function Oc(e,t){if(e){if(Xt(e))return{value:e.value};if(Yt(e))return Yc(e,pn(e),"datum",t)}}function Ac(e){return ne({},e,{mult:.5})}function _c(t,n,r,i,o){return function(){if(m(t)){if(r){var e=i.get("type");if(X([$r.LOG,$r.TIME,$r.UTC],e))"bar"!==o&&"area"!==o||Je(Be.nonZeroScaleUsedWithLengthMark(o,n,{scaleType:e}));else{if(function(e){if(!1!==e.get("zero"))return!0;var t=e.domains;return!!w(t)&&K(t,function(e){return w(e)&&2===e.length&&e[0]<=0&&0<=e[1]})}(i))return{scale:r,value:0};"bar"!==o&&"area"!==o||Je(Be.nonZeroScaleUsedWithLengthMark(o,n,{zeroFalse:!1===i.explicit.zero}))}}return"zeroOrMin"===t?"x"===n?{value:0}:{field:{group:"height"}}:"x"===n?{field:{group:"width"}}:{value:0}}return t}}function Tc(e){var t,n,r=e.markDef,i=e.encoding,o=e.config,a=r.filled,u=r.type,s={fill:Bc("fill",r,o),stroke:Bc("stroke",r,o),color:Bc("color",r,o)},l=X(["bar","point","circle","square","geoshape"],u)?"transparent":void 0,c={fill:ke(r.fill,s.fill,l),stroke:ke(r.stroke,s.stroke)},f=a?"fill":"stroke",d=ne({},c.fill?{fill:{value:c.fill}}:{},c.stroke?{stroke:{value:c.stroke}}:{});return i.fill||i.stroke?(r.color&&Je(Be.droppingColor("property",{fill:"fill"in i,stroke:"stroke"in i})),ne({},Rc("fill",e,{defaultValue:ke(c.fill,l)}),Rc("stroke",e,{defaultValue:c.stroke}))):i.color?ne({},d,Rc("color",e,{vgChannel:f,defaultValue:ke(r[f],r.color,s[f],s.color,a?l:void 0)})):void 0!==r.fill||void 0!==r.stroke?(r.color&&Je(Be.droppingColor("property",{fill:"fill"in r,stroke:"stroke"in r})),d):r.color?ne({},d,((t={})[f]={value:r.color},t)):void 0!==s.fill||void 0!==s.stroke?d:s.color?ne({},l?{fill:{value:"transparent"}}:{},((n={})[f]={value:s.color},n)):{}}function Dc(e,t){var r,i,o,a,n,u,s,l=Tc(e),c=l.fill,f=l.stroke;return ne({},(u=e.markDef,s=t,Bo.reduce(function(e,t){return void 0!==u[t]&&"ignore"!==s[t]&&(e[t]={value:u[t]}),e},{})),zc(e,"fill",c),zc(e,"stroke",f),Rc("opacity",e),(i=(r=e).encoding,o=r.markDef,a=r.config,n=i.tooltip,w(n)?{tooltip:Nc(n,a)}:Lc(r,n,"tooltip",function(e){var t=Oc(e,r.config);if(t)return t;var n=ke(o.tooltip,Bc("tooltip",o,a));return m(n)?{value:n}:ee(n)?"encoding"===n.content?Nc(cf(i),a):{signal:"datum"}:void 0})),jc(e,"href"))}function zc(e,t,n){var r,i,o,a=e.config,u=e.mark;if(a.invalidValues&&n&&!qn(u)){var s=Fc(e,{invalid:!0,channels:Hr});if(s)return(r={})[t]=[{test:s,value:null}].concat(null!=(o=n)?w(o)?o:[o]:[]),r}return n?((i={})[t]=n,i):{}}function Fc(o,e){var t=e.invalid,n=void 0!==t&&t,r=e.channels.reduce(function(e,t){var n=o.getScaleComponent(t);if(n){var r=n.get("type"),i=o.vgField(t,{expr:"datum"});i&&yi(r)&&(e[i]=!0)}return e},{}),i=ce(r);if(0<i.length){var a=n?"||":"&&";return i.map(function(e){return e+" "+(n?"===":"!==")+" null "+a+" "+(n?"":"!")+"isNaN("+e+")"}).join(" "+a+" ")}}function Ic(e){if("filter"===e.config.invalidValues){var t=Fc(e,{channels:["x","y"]});if(t)return{defined:{signal:t}}}return{}}function Rc(t,n,e){void 0===e&&(e={});var r=e.defaultValue,i=e.vgChannel,o=e.defaultRef||(void 0!==r?{value:r}:void 0),a=n.encoding[t];return Lc(n,a,i||t,function(e){return Cc(t,e,void 0,n.scaleName(t),n.getScaleComponent(t),null,o)})}function Lc(r,e,t,i){var n,o,a=e&&e.condition,u=i(e);if(a){var s=(w(a)?a:[a]).map(function(e){var t=i(e),n=Mt(e)?tc(r,e.selection):gc(r,e.test);return ne({test:n},t)});return(n={})[t]=s.concat(void 0!==u?[u]:[]),n}return void 0!==u?((o={})[t]=u,o):{}}function jc(t,e){void 0===e&&(e="text");var n=t.encoding[e];return Lc(t,n,e,function(e){return Oc(e,t.config)})}function Uc(e,t,n){var r,i,o,a=n.scaleName(t),u="x"===t?"width":"height";if(n.encoding.size||void 0!==n.markDef.size)if(n.markDef.orient){var s=((r={})[t+"c"]=wc(e,a,{},{band:.5}),r);if(mn(n.encoding.size))return ne({},s,Rc("size",n,{vgChannel:u}));if(Xt(n.encoding.size))return ne({},s,Rc("size",n,{vgChannel:u}));if(void 0!==n.markDef.size)return ne({},s,((i={})[u]={value:n.markDef.size},i))}else Je(Be.cannotApplySizeToNonOrientedMark(n.markDef.type));return(o={})[t]=wc(e,a,{binSuffix:"range"}),o[u]=Ec(a),o}function Pc(e,t,n,r){var i="x"===e?"width":"height";return ne({},qc(e,t,n,"x"===e?"xc":"yc"),Rc("size",t,{defaultRef:r,vgChannel:i}))}function Mc(e,t,n,r,i,o){var a,u,s={x:o?i:0,x2:o?0:i,y:o?0:i,y2:o?i:0},l=n===rr?or:ar;return Qr(e.bin)?((a={})[l]=Sc(e,r,"start",s[n+"2"]),a[n]=Sc(e,r,"end",s[n]),a):Kr(e.bin)&&Yt(t)?((u={})[l]=wc(e,r,{},{offset:s[n+"2"]}),u[n]=wc(t,r,{},{offset:s[n]}),u):void Je(Be.channelRequiredForBinned(l))}function qc(e,t,n,r){var i,o,a,u,s,l,c,f,d=t.encoding,p=t.mark,h=t.stack,m=d[e],g=d[e===rr?or:ar],v=t.scaleName(e),y=t.getScaleComponent(e),b=xc(e,t.markDef),x=m||!d.latitude&&!d.longitude?ne({},(a=m,u=g,c=h,f=_c(n,o=e,s=v,l=y,p),Yt(a)&&c&&o===c.fieldChannel?wc(a,s,{suffix:"end"}):Cc(o,a,u,s,l,c,f)),b?{offset:b}:{}):{field:t.getName(e)};return(i={})[r||e]=x,i}function Hc(e,t,n){var r,i,o,a,u,s,l,c,f=e.encoding,d=e.mark,p=e.stack,h="x2"===n?"x":"y",m=f[h],g=e.scaleName(h),v=e.getScaleComponent(h),y=xc(n,e.markDef),b=m||!f.latitude&&!f.longitude?ne({},(o=m,a=f[i=n],l=p,c=_c(t,h,u=g,s=v,d),Yt(o)&&l&&i.charAt(0)===l.fieldChannel.charAt(0)?wc(o,u,{suffix:"start"}):Cc(i,a,void 0,u,s,l,c)),y?{offset:y}:{}):{field:e.getName(n)};return(r={})[n]=b,r}function Wc(e){return[].concat(e.type,e.style||[])}function Bc(e,t,n,r){var i=(void 0===r?{}:r).skipGeneralMarkConfig,o=void 0!==i&&i;return ke(Gc(e,t,n.style),n[t.type][e],o?void 0:n.mark[e])}function Gc(e,t,n){for(var r,i=0,o=Wc(t);i<o.length;i++){var a=n[o[i]],u=e;a&&void 0!==a[u]&&(r=a[u])}return r}function Yc(e,t,n,r){var i=Vc(e,t,r);if(Qr(e.bin))return{signal:Kc($t(e,{expr:n}),$t(e,{expr:n,binSuffix:"end"}),i,r)};if("quantitative"===e.type)return{signal:""+Xc($t(e,{expr:n,binSuffix:"range"}),i)};if(wn(e)){var o=Qt(e)&&e.scale&&e.scale.type===$r.UTC;return{signal:Jc($t(e,{expr:n}),e.timeUnit,t,r.text.shortTimeLabels,r.timeFormat,o,!0)}}return{signal:"''+"+$t(e,{expr:n})}}function Vc(e,t,n){if(!wn(e))return t||(e.type===Ft?n.numberFormat:void 0)}function Xc(e,t){return"format("+e+', "'+(t||"")+'")'}function Qc(e,t,n){return Xc(e,t||n.numberFormat)}function Kc(e,t,n,r){return e+" === null || isNaN("+e+') ? "null" : '+Qc(e,n,r)+' + " - " + '+Qc(t,n,r)}function Jc(e,t,n,r,i,o,a){return void 0===a&&(a=!1),!t||n?(n=n||i)||a?(o?"utc":"time")+"Format("+e+", '"+n+"')":void 0:Ot(t,e,r,o)}function Zc(e,n){return(w(e)?e:[e]).reduce(function(e,t){return e.field.push($t(t,n)),e.order.push(t.sort||"ascending"),e},{field:[],order:[]})}function $c(e,t){var i=e.slice();return t.forEach(function(e){for(var t=0,n=i;t<n.length;t++){var r=n[t];if(Y(r)===Y(e))return}i.push(e)}),i}function ef(e,t){return e!==t&&t?e?e+", "+t:t:e}function tf(e,t){if(w(e.value)&&w(t.value))return{explicit:e.explicit,value:$c(e.value,t.value)};if(!w(e.value)&&!w(t.value))return{explicit:e.explicit,value:ef(e.value,t.value)};throw new Error("It should never reach here")}function nf(e,t){return Qr(e.bin)?Wr(t)&&X(["ordinal","nominal"],e.type):(console.warn("Only use this method with binned field defs"),!1)}function rf(r,i){return ce(r).reduce(function(e,t){var n=r[t];return ne({},e,Lc(i,n,t,function(e){return{value:e.value}}))},{})}function of(e,t){var n=e&&e[t];return!!n&&(w(n)?K(n,function(e){return!!e.field}):Yt(n)||Bt(n))}function af(r){return K(Tr,function(e){if(of(r,e)){var t=r[e];if(w(t))return K(t,function(e){return!!e.aggregate});var n=mn(t);return n&&!!n.aggregate}return!1})}function uf(m,g){var v=[],y=[],b=[],x=[],S={};return ff(m,function(e,t){var n=e.field,r=e.aggregate,i=e.timeUnit,o=e.bin,a=re(e,["field","aggregate","timeUnit","bin"]);if(Yt(e)&&(r||i||o)){var u=fn(e),s=u&&u.title,l=$t(e,{forAs:!0}),c=ne({},s?[]:{title:cn(e,g,{allowDisabling:!0})},a,{field:l}),f=t===Yn.X||t===Yn.Y;if(r&&Te(r)){var d={op:r,as:l};n&&(d.field=n),x.push(d)}else if(Qr(o)){if(y.push({bin:o,field:n,as:l}),v.push($t(e,{binSuffix:"end"})),nf(e,t)&&v.push($t(e,{binSuffix:"range"})),f){var p={field:l+"_end",type:_t.QUANTITATIVE};S[t+"2"]=p}c.bin="binned",c.type=_t.QUANTITATIVE}else if(i){b.push({timeUnit:i,field:n,as:l});var h=Nt(i,g.axis.shortTimeLabels).join(" ");Mr(t)?c.legend=ne({format:h},c.legend):f?c.axis=ne({format:h},c.axis):"text"!==t&&"tooltip"!==t||(c.format=c.format||h)}r||v.push(l),S[t]=c}else Yt(e)&&v.push(n),S[t]=m[t]}),{bins:y,timeUnits:b,aggregate:x,groupby:v,encoding:S}}function sf(i,o){return ce(i).reduce(function(e,n){if(!zr(n))return Je(Be.invalidEncodingChannel(n)),e;if(!Br(i,n,o))return Je(Be.incompatibleChannel(n,o)),e;if("size"===n&&"line"===o){var t=mn(i[n]);if(t&&t.aggregate)return Je(Be.LINE_WITH_VARYING_SIZE),e}if("color"===n&&("fill"in i||"stroke"in i))return Je(Be.droppingColor("encoding",{fill:"fill"in i,stroke:"stroke"in i})),e;var r=i[n];if("detail"===n||"order"===n&&!w(r)&&!Xt(r)||"tooltip"===n&&w(r))r&&(e[n]=(w(r)?r:[r]).reduce(function(e,t){return Yt(t)?e.push(vn(t,n)):Je(Be.emptyFieldDef(t,n)),e},[]));else{if(!Yt(r)&&!Xt(r)&&!Wt(r))return Je(Be.emptyFieldDef(r,n)),e;e[n]=gn(r,n)}return e},{})}function lf(e){return e&&(!!e.x&&!!e.x2||!!e.y&&!!e.y2)}function cf(n){var r=[];return Tr.forEach(function(e){if(of(n,e)){var t=n[e];(w(t)?t:[t]).forEach(function(e){Yt(e)?r.push(e):Bt(e)&&r.push(e.condition)})}}),r}function ff(e,n,r){if(e)for(var t=function(t){w(e[t])?e[t].forEach(function(e){n.call(r,e,t)}):n.call(r,e[t],t)},i=0,o=ce(e);i<o.length;i++){t(o[i])}}function df(r,i,e,o){return r?ce(r).reduce(function(e,n){var t=r[n];return w(t)?t.reduce(function(e,t){return i.call(o,e,t,n)},e):i.call(o,e,t,n)},e):e}var pf=Object.freeze({channelHasField:of,isAggregate:af,extractTransformsFromEncoding:uf,normalizeEncoding:sf,isRanged:lf,fieldDefs:cf,forEach:ff,reduce:df});function hf(s,l,c,f,d){var p=c.scale,h=c.axis;return function(e,t,n,r,i){var o,a;void 0===r&&(r=void 0),void 0===i&&(i={});var u=h&&void 0!==h.title?void 0:void 0!==c.title?c.title:c.field;return mf(s,e,d,{mark:t,encoding:ne((o={},o[l]=ne({field:n+"_"+c.field,type:c.type},u?{title:u}:{},p?{scale:p}:{},h?{axis:h}:{}),o),m(r)?(a={},a[l+"2"]={field:r+"_"+c.field,type:c.type},a):{},f,i)})}}function mf(e,t,n,r){var i=e.clip,o=e.color,a=e.opacity,u=e.type;return e[t]||void 0===e[t]&&n[t]?[ne({},r,{mark:ne({},n[t],i?{clip:i}:{},o?{color:o}:{},a?{opacity:a}:{},Wn(r.mark)?r.mark:{type:r.mark},{style:u+"-"+t},l(e[t])?{}:e[t])})]:[]}function gf(e,t,n){var r,i,o,a=e.encoding;if(i="vertical"===t?(o="y",r=a.y,a.y2?a.y2:void 0):(o="x",r=a.x,a.x2?a.x2:void 0),r&&r.aggregate){var u=r.aggregate,s=re(r,["aggregate"]);u!==n&&Je(Be.errorBarContinuousAxisHasCustomizedAggregate(u,n)),r=s}if(i&&i.aggregate){u=i.aggregate;var l=re(i,["aggregate"]);u!==n&&Je(Be.errorBarContinuousAxisHasCustomizedAggregate(u,n)),i=l}return{continuousAxisChannelDef:r,continuousAxisChannelDef2:i,continuousAxis:o}}function vf(e,t){var n=e.mark,r=e.encoding;if(Yt(r.x)&&tn(r.x)){if(Yt(r.y)&&tn(r.y)){if(void 0===r.x.aggregate&&r.y.aggregate===t)return"vertical";if(void 0===r.y.aggregate&&r.x.aggregate===t)return"horizontal";if(r.x.aggregate===t&&r.y.aggregate===t)throw new Error("Both x and y cannot have aggregate");return Wn(n)&&n.orient?n.orient:"vertical"}return"horizontal"}if(Yt(r.y)&&tn(r.y))return"vertical";throw new Error("Need a valid continuous axis for "+t+"s")}function yf(e,r,i){return ne({},e,{encoding:df(e.encoding,function(e,t,n){return-1<r.indexOf(n)?e[n]=t:Je(Be.incompatibleChannel(n,i)),e},{})})}var bf="boxplot",xf=ce({box:1,median:1,outliers:1,rule:1,ticks:1}),Sf=["x","y","color","detail","opacity","size"];function wf(e){return[{op:"q1",field:e,as:"lower_box_"+e},{op:"q3",field:e,as:"upper_box_"+e}]}var Ef="errorbar",kf=ce({ticks:1,rule:1});var Cf=["x","y","x2","y2","color","detail","opacity"];function Nf(e,t,n){var r=(e=yf(e,Cf,t)).mark,i=e.encoding,o=e.selection,a=(e.projection,re(e,["mark","encoding","selection","projection"])),u=Wn(r)?r:{type:r};o&&Je(Be.selectionNotSupported(t));var s=function(e,t){var n=e.encoding;if(Yt(n.x2)&&Yt(n.x)&&tn(n.x)){if(Yt(n.y2)&&Yt(n.y)&&tn(n.y))throw new Error("Cannot have both x2 and y2 with both are quantiative");return{orient:"horizontal",isRangedErrorBar:!0}}return Yt(n.y2)&&Yt(n.y)&&tn(n.y)?{orient:"vertical",isRangedErrorBar:!0}:{orient:vf(e,t),isRangedErrorBar:!1}}(e,t),l=s.orient,c=s.isRangedErrorBar,f=gf(e,l,t),d=f.continuousAxisChannelDef,p=f.continuousAxisChannelDef2,h=f.continuousAxis,m=function(e,t,n,r,i,o){var a=[],u=[],s=t.field;if(r)(e.center||e.extent)&&Je(Be.errorBarCenterAndExtentAreNotNeeded(e.center,e.extent)),u=[{calculate:"datum."+s,as:"lower_"+s},{calculate:"datum."+n.field,as:"upper_"+s}];else{var l=e.center?e.center:e.extent?"iqr"===e.extent?"median":"mean":o.errorbar.center,c=e.extent?e.extent:"mean"===l?"stderr":"iqr";"median"===l!=("iqr"===c)&&Je(Be.errorBarCenterIsUsedWithWrongExtent(l,c,i)),"stderr"===c||"stdev"===c?(a=[{op:c,field:s,as:"extent_"+s},{op:l,field:s,as:"center_"+s}],u=[{calculate:"datum.center_"+s+" + datum.extent_"+s,as:"upper_"+s},{calculate:"datum.center_"+s+" - datum.extent_"+s,as:"lower_"+s}]):(e.center&&e.extent&&Je(Be.errorBarCenterIsNotNeeded(e.extent,i)),a=[{op:"ci"===c?"ci0":"q1",field:s,as:"lower_"+s},{op:"ci"===c?"ci1":"q3",field:s,as:"upper_"+s}])}return{postAggregateCalculates:u,errorBarSpecificAggregate:a}}(u,d,p,c,t,n),g=m.errorBarSpecificAggregate,v=m.postAggregateCalculates,y=h,b=(i[y],h+"2"),x=(i[b],uf(re(i,["symbol"==typeof y?y:y+"","symbol"==typeof b?b:b+""]),n)),S=x.bins,w=x.timeUnits,E=x.aggregate,k=x.groupby,C=x.encoding,N=E.concat(g),O=c?[]:k;return{transform:(a.transform||[]).concat(S,w,N.length?[{aggregate:N,groupby:O}]:[],v),groupby:O,continuousAxisChannelDef:d,continuousAxis:h,encodingWithoutContinuousAxis:C,ticksOrient:"vertical"===l?"horizontal":"vertical",markDef:u,outerSpec:a}}var Of="errorband",Af=ce({band:1,borders:1});var _f={};function Tf(e,t,n){_f[e]={normalizer:t,parts:n}}function Df(){return ce(_f)}function zf(e,t){var n=Wn(e.mark)?e.mark.type:e.mark;if(n in _f)return(0,_f[n].normalizer)(e,t);throw new Error('Invalid mark type "'+n+'"')}Tf(bf,function(e,t){var n,r=(e=yf(e,Sf,bf)).mark,i=(e.encoding,e.selection),o=(e.projection,re(e,["mark","encoding","selection","projection"])),a=Wn(r)?r:{type:r};i&&Je(Be.selectionNotSupported("boxplot"));var u,s,l,c,f,d,p,h,m,g,v,y,b,x,S,w,E,k,C,N,O=a.extent||t.boxplot.extent,A=ke(a.size,t.boxplot.size),_=!te(O),T=(s=O,l=t,c=vf(u=e,bf),f=gf(u,c,bf),d=f.continuousAxisChannelDef,p=f.continuousAxis,h=d.field,m=!te(s),g=wf(h).concat([{op:"median",field:h,as:"mid_box_"+h},{op:"min",field:h,as:(m?"lower_whisker_":"min_")+h},{op:"max",field:h,as:(m?"upper_whisker_":"max_")+h}]),v=m?[]:[{calculate:"datum.upper_box_"+h+" - datum.lower_box_"+h,as:"iqr_"+h},{calculate:"min(datum.upper_box_"+h+" + datum.iqr_"+h+" * "+s+", datum.max_"+h+")",as:"upper_whisker_"+h},{calculate:"max(datum.lower_box_"+h+" - datum.iqr_"+h+" * "+s+", datum.min_"+h+")",as:"lower_whisker_"+h}],(y=u.encoding)[b=p],x=uf(re(y,["symbol"==typeof b?b:b+""]),l),S=x.bins,w=x.timeUnits,E=x.aggregate,k=x.groupby,C=x.encoding,N="vertical"===c?"horizontal":"vertical",{transform:S.concat(w,[{aggregate:E.concat(g),groupby:k}],v),groupby:k,continuousAxisChannelDef:d,continuousAxis:p,encodingWithoutContinuousAxis:C,tickOrient:N}),D=T.transform,z=T.continuousAxisChannelDef,F=T.continuousAxis,I=T.groupby,R=T.encodingWithoutContinuousAxis,L=T.tickOrient,j=(R.color,R.size),U=re(R,["color","size"]),P=function(e){return hf(a,F,z,e,t.boxplot)},M=P(U),q=P(R),H=P(ne({},U,j?{size:j}:{})),W={type:"tick",color:"black",opacity:1,orient:L},B=ne({type:"bar"},A?{size:A}:{}),G=ne({type:"tick"},ee(t.boxplot.median)&&t.boxplot.median.color?{color:t.boxplot.median.color}:{},A?{size:A}:{},{orient:L}),Y=M("rule","rule","lower_whisker","lower_box").concat(M("rule","rule","upper_box","upper_whisker"),M("ticks",W,"lower_whisker"),M("ticks",W,"upper_whisker"),q("box",B,"lower_box","upper_box"),H("median",G,"mid_box")),V=[];if(!_){var X="datum.lower_box_"+z.field,Q="datum.upper_box_"+z.field,K="("+Q+" - "+X+")",J=X+" - "+O+" * "+K,Z=Q+" + "+O+" * "+K,$="datum."+z.field;V=mf(a,"outliers",t.boxplot,{transform:[{window:wf(z.field),frame:[null,null],groupby:I},{filter:"("+$+" < "+J+") || ("+$+" > "+Z+")"}],mark:"point",encoding:ne((n={},n[F]={field:z.field,type:z.type},n),U)})}return 0<V.length?ne({},o,{layer:[{transform:D,layer:Y}].concat(V)}):ne({},o,{transform:(o.transform||[]).concat(D),layer:Y})},xf),Tf(Ef,function(e,t){var n=Nf(e,Ef,t),r=n.transform,i=n.continuousAxisChannelDef,o=n.continuousAxis,a=n.encodingWithoutContinuousAxis,u=n.ticksOrient,s=n.markDef,l=n.outerSpec,c=hf(s,o,i,a,t.errorbar),f={type:"tick",orient:u};return ne({},l,{transform:r,layer:c("ticks",f,"lower").concat(c("ticks",f,"upper"),c("rule","rule","lower","upper"))})},kf),Tf(Of,function(e,t){var n=Nf(e,Of,t),r=n.transform,i=n.continuousAxisChannelDef,o=n.continuousAxis,a=n.encodingWithoutContinuousAxis,u=n.markDef,s=n.outerSpec,l=hf(u,o,i,a,t.errorband),c=void 0!==e.encoding.x&&void 0!==e.encoding.y,f={type:c?"area":"rect"},d={type:c?"line":"rule"},p=ne({},u.interpolate?{interpolate:u.interpolate}:{},u.tension&&u.interpolate?{interpolate:u.tension}:{});return c?(f=ne({},f,p),d=ne({},d,p)):u.interpolate?Je(Be.errorBand1DNotSupport("interpolate")):u.tension&&Je(Be.errorBand1DNotSupport("tension")),ne({},s,{transform:r,layer:l("band",f,"lower","upper").concat(l("borders",d,"lower"),l("borders",d,"upper"))})},Af);var Ff=Object.freeze({add:Tf,remove:function(e){delete _f[e]},getAllCompositeMarks:Df,getCompositeMarkParts:function(e){if(e in _f)return _f[e].parts;throw new Error("Unregistered composite mark "+e)},normalize:zf});function If(e,t,n){var r;r="as"in e?m(e.as)?[e.as,e.as+"_end"]:[e.as[0],e.as[1]]:[$t(e,{forAs:!0}),$t(e,{binSuffix:"end",forAs:!0})];var i,o,a,u,s=yn(t,void 0)||{},l=(i=s,o=e.field,Xr(i)+"_"+o),c=(u=l,{signal:(a=n).getName(u+"_bins"),extentSignal:a.getName(u+"_extent")}),f=c.signal,d=c.extentSignal;return{key:l,binComponent:ne({bin:s,field:e.field,as:r},f?{signal:f}:{},d?{extentSignal:d}:{})}}var Rf=function(r){function u(e,t){var n=r.call(this,e)||this;return n.bins=t,n}return h(u,r),u.prototype.clone=function(){return new u(null,pe(this.bins))},u.makeFromEncoding=function(e,a){var t=a.reduceFieldDef(function(e,t,n){if(Qr(t.bin)){var r=If(t,t.bin,a),i=r.key,o=r.binComponent;e[i]=ne({},o,e[i],function(e,t,n,r){if(nf(t,n)){var i=bl(e)&&(e.axis(n)||e.legend(n))||{},o=$t(t,{expr:"datum"}),a=$t(t,{expr:"datum",binSuffix:"end"});return{formulaAs:$t(t,{binSuffix:"range",forAs:!0}),formula:Kc(o,a,i.format,r)}}return{}}(a,t,n,a.config))}return e},{});return 0===ce(t).length?null:new u(e,t)},u.makeFromTransform=function(e,t,n){var r,i=If(t,t.bin,n),o=i.key,a=i.binComponent;return new u(e,((r={})[o]=a,r))},u.prototype.merge=function(e){this.bins=ne({},this.bins,e.bins),e.remove()},u.prototype.producedFields=function(){var t={};return fe(this.bins).forEach(function(e){e.as.forEach(function(e){return t[e]=!0})}),t},u.prototype.dependentFields=function(){var t={};return fe(this.bins).forEach(function(e){t[e.field]=!0}),t},u.prototype.hash=function(){return"Bin "+V(this.bins)},u.prototype.assemble=function(){return Z(fe(this.bins).map(function(e){var t=[],n=ne({type:"bin",field:e.field,as:e.as,signal:e.signal},e.bin);return!e.bin.extent&&e.extentSignal&&(t.push({type:"extent",field:e.field,signal:e.extentSignal}),n.extent={signal:e.extentSignal}),t.push(n),e.formula&&t.push({type:"formula",expr:e.formula,as:e.formulaAs}),t}))},u}(oa),Lf=function(i){function e(e,t,n){var r=i.call(this,e)||this;return r.model=t,r.filter=n,r.expr=gc(r.model,r.filter,r),r._dependentFields=Au(r.expr),r}return h(e,i),e.prototype.clone=function(){return new e(null,this.model,pe(this.filter))},e.prototype.dependentFields=function(){return this._dependentFields},e.prototype.assemble=function(){return{type:"filter",expr:this.expr}},e.prototype.hash=function(){return"Filter "+this.expr},e}(oa),jf=function(u){function e(e,t){var n=u.call(this,e)||this;n.transform=t;var r=n.transform,i=r.flatten,o=r.as,a=void 0===o?[]:o;return n.transform.as=i.map(function(e,t){return a[t]||e}),n}return h(e,u),e.prototype.clone=function(){return new e(this.parent,pe(this.transform))},e.prototype.producedFields=function(){var r=this;return this.transform.flatten.reduce(function(e,t,n){return e[r.transform.as[n]]=!0,e},{})},e.prototype.hash=function(){return"FlattenTransform "+V(this.transform)},e.prototype.assemble=function(){var e=this.transform;return{type:"flatten",fields:e.flatten,as:e.as}},e}(oa),Uf=function(i){function e(e,t){var n=i.call(this,e)||this;n.transform=t;var r=n.transform.as||[void 0,void 0];return n.transform.as=[r[0]||"key",r[1]||"value"],n}return h(e,i),e.prototype.clone=function(){return new e(null,pe(this.transform))},e.prototype.producedFields=function(){return this.transform.as.reduce(function(e,t){return e[t]=!0,e},{})},e.prototype.hash=function(){return"FoldTransform "+V(this.transform)},e.prototype.assemble=function(){var e=this.transform;return{type:"fold",fields:e.fold,as:e.as}},e}(oa),Pf=function(o){function a(e,t,n,r){var i=o.call(this,e)||this;return i.fields=t,i.geojson=n,i.signal=r,i}return h(a,o),a.prototype.clone=function(){return new a(null,pe(this.fields),this.geojson,this.signal)},a.parseAll=function(n,r){var i=0;if([[lr,ur],[cr,sr]].forEach(function(e){var t=e.map(function(e){return r.channelHasField(e)?r.fieldDef(e).field:void 0});(t[0]||t[1])&&(n=new a(n,t,null,r.getName("geojson_"+i++)))}),r.channelHasField(pr)){var e=r.fieldDef(pr);e.type===jt&&(n=new a(n,null,e.field,r.getName("geojson_"+i++)))}return n},a.prototype.assemble=function(){return ne({type:"geojson"},this.fields?{fields:this.fields}:{},this.geojson?{geojson:this.geojson}:{},{signal:this.signal})},a}(oa),Mf=function(o){function a(e,t,n,r){var i=o.call(this,e)||this;return i.projection=t,i.fields=n,i.as=r,i}return h(a,o),a.prototype.clone=function(){return new a(null,this.projection,pe(this.fields),pe(this.as))},a.parseAll=function(r,i){return i.projectionName()&&[[lr,ur],[cr,sr]].forEach(function(e){var t=e.map(function(e){return i.channelHasField(e)?i.fieldDef(e).field:void 0}),n=e[0]===cr?"2":"";(t[0]||t[1])&&(r=new a(r,i.projectionName(),t,[i.getName("x"+n),i.getName("y"+n)]))}),r},a.prototype.assemble=function(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}},a}(oa),qf=function(t){function e(e){return t.call(this,e)||this}return h(e,t),e.prototype.clone=function(){return new e(null)},e.prototype.producedFields=function(){var e;return(e={})[Ji]=!0,e},e.prototype.assemble=function(){return{type:"identifier",as:Ji}},e}(oa);function Hf(e,t,n,r){if(void 0!==e.size)return{value:e.size};var i=Bc("size",e,r,{skipGeneralMarkConfig:!0});if(void 0!==i)return{value:i};if(n){var o=n.get("type");if("point"!==o&&"band"!==o)return{value:r.bar.continuousBandSize};if(void 0!==r.bar.discreteBandSize)return{value:r.bar.discreteBandSize};if(o!==$r.POINT)return Ec(t);var a=n.get("range");if(Ho(a)&&te(a.step))return{value:a.step-1};Je(Be.BAR_WITH_POINT_SCALE_AND_RANGESTEP_NULL)}return{value:ke(r.bar.discreteBandSize,r.scale.rangeStep?r.scale.rangeStep-1:void 0,20)}}function Wf(e,t){var n=e.config,r=e.markDef,i=e.width,o=e.height;return ne({},Dc(e,{size:"include",orient:"ignore"}),qc("x",e,Ac(i)),qc("y",e,Ac(o)),Rc("size",e,{defaultValue:Bc("size",r,n)}),function(e,t,n){if(n)return{shape:{value:n}};return Rc("shape",e,{defaultValue:Bc("shape",e.markDef,t)})}(e,n,t))}var Bf={area:{vgMark:"area",encodeEntry:function(e){return ne({},Dc(e,{size:"ignore",orient:"include"}),qc("x",e,"zeroOrMin"),qc("y",e,"zeroOrMin"),Hc(e,"zeroOrMin","horizontal"===e.markDef.orient?"x2":"y2"),Ic(e))}},bar:{vgMark:"rect",encodeEntry:function(e){return ne({},Dc(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.config,n=e.encoding,r=e.markDef,i=e.width,o=r.orient,a=n.size,u=n.x,s=n.x2,l=e.scaleName(rr),c=e.getScaleComponent(rr);{if(Yt(u)&&Kr(u.bin))return Mc(u,s,rr,l,ke(r.binSpacing,t.bar.binSpacing),c.get("reverse"));if("horizontal"===o||s)return ne({},qc("x",e,"zeroOrMin"),Hc(e,"zeroOrMin","x2"));if(Yt(u)){var f=c.get("type");if(Qr(u.bin)&&!a&&!gi(f))return Mc(u,void 0,rr,e.scaleName("x"),ke(r.binSpacing,t.bar.binSpacing),c.get("reverse"));if(f===$r.BAND)return Uc(u,"x",e)}return Pc("x",e,ne({},Ac(i)),Hf(r,l,c,t))}}(e),function(e){var t=e.config,n=e.encoding,r=e.height,i=e.markDef,o=i.orient,a=n.size,u=n.y,s=n.y2,l=e.scaleName(ir),c=e.getScaleComponent(ir);{if(Yt(u)&&Kr(u.bin))return Mc(u,s,ir,l,ke(i.binSpacing,t.bar.binSpacing),c.get("reverse"));if("vertical"===o||s)return ne({},qc("y",e,"zeroOrMin"),Hc(e,"zeroOrMin","y2"));if(Yt(u)){var f=c.get("type");if(Qr(u.bin)&&!a&&!gi(f))return Mc(u,void 0,ir,e.scaleName("y"),ke(i.binSpacing,t.bar.binSpacing),c.get("reverse"));if(f===$r.BAND)return Uc(u,"y",e)}return Pc("y",e,Ac(r),Hf(i,l,c,t))}}(e))}},circle:{vgMark:"symbol",encodeEntry:function(e){return Wf(e,"circle")}},geoshape:{vgMark:"shape",encodeEntry:function(e){return ne({},Dc(e,{size:"ignore",orient:"ignore"}))},postEncodingTransform:function(e){var t=e.encoding.shape;return[ne({type:"geoshape",projection:e.projectionName()},t&&Yt(t)&&t.type===jt?{field:$t(t,{expr:"datum"})}:{})]}},line:{vgMark:"line",encodeEntry:function(e){var t=e.width,n=e.height;return ne({},Dc(e,{size:"ignore",orient:"ignore"}),qc("x",e,Ac(t)),qc("y",e,Ac(n)),Rc("size",e,{vgChannel:"strokeWidth"}),Ic(e))}},point:{vgMark:"symbol",encodeEntry:function(e){return Wf(e)}},rect:{vgMark:"rect",encodeEntry:function(e){return ne({},Dc(e,{size:"ignore",orient:"ignore"}),function(e){var t=e.encoding.x,n=e.encoding.x2,r=e.getScaleComponent(rr),i=r?r.get("type"):void 0,o=e.scaleName(rr);{if(Yt(t)&&(Qr(t.bin)||Kr(t.bin)))return Mc(t,n,rr,o,0,r.get("reverse"));if(Yt(t)&&r&&gi(i)){if(i===$r.BAND)return Uc(t,"x",e);throw new Error(Be.scaleTypeNotWorkWithMark(Rn,i))}return ne({},qc("x",e,"zeroOrMax"),Hc(e,"zeroOrMin","x2"))}}(e),function(e){var t=e.encoding.y,n=e.encoding.y2,r=e.getScaleComponent(ir),i=r?r.get("type"):void 0,o=e.scaleName(ir);{if(Yt(t)&&(Qr(t.bin)||Kr(t.bin)))return Mc(t,n,ir,o,0,r.get("reverse"));if(Yt(t)&&r&&gi(i)){if(i===$r.BAND)return Uc(t,"y",e);throw new Error(Be.scaleTypeNotWorkWithMark(Rn,i))}return ne({},qc("y",e,"zeroOrMax"),Hc(e,"zeroOrMin","y2"))}}(e))}},rule:{vgMark:"rule",encodeEntry:function(e){var t=e.markDef,n=e.width,r=e.height,i=t.orient;return e.encoding.x||e.encoding.y||e.encoding.latitude||e.encoding.longitude?ne({},Dc(e,{size:"ignore",orient:"ignore"}),qc("x",e,"horizontal"===i?"zeroOrMin":Ac(n)),qc("y",e,"vertical"===i?"zeroOrMin":Ac(r)),"vertical"!==i?Hc(e,"zeroOrMax","x2"):{},"horizontal"!==i?Hc(e,"zeroOrMax","y2"):{},Rc("size",e,{vgChannel:"strokeWidth",defaultValue:t.size})):{}}},square:{vgMark:"symbol",encodeEntry:function(e){return Wf(e,"square")}},text:{vgMark:"text",encodeEntry:function(e){var t=e.config,n=(e.encoding,e.width),r=e.height,i=e.markDef,o=ke(i.fontSize,i.size,Gc("fontSize",i,t.style),Gc("size",i,t.style),t[i.type].fontSize,t[i.type].size);return ne({},Dc(e,{size:"ignore",orient:"ignore"}),qc("x",e,Ac(n)),qc("y",e,Ac(r)),jc(e),Rc("size",e,{defaultValue:o,vgChannel:"fontSize"}),function(e,t){var n;if(void 0!==t)return(n={})[e]={value:t},n}("align",function(e,t,n){if(void 0!==(e.align||Bc("align",e,n)))return;return"center"}(e.markDef,0,t)))}},tick:{vgMark:"rect",encodeEntry:function(e){var t,n=e.config,r=e.markDef,i=e.width,o=e.height,a=r.orient,u="horizontal"===a?"width":"height",s="horizontal"===a?"height":"width";return ne({},Dc(e,{size:"ignore",orient:"ignore"}),qc("x",e,Ac(i),"xc"),qc("y",e,Ac(o),"yc"),Rc("size",e,{defaultValue:function(e){var t=e.config,n=e.markDef,r=n.orient,i=e.getScaleComponent("horizontal"===r?"x":"y");{if(void 0!==n.size)return n.size;if(void 0!==t.tick.bandSize)return t.tick.bandSize;var o=i?i.get("range"):void 0,a=o&&Ho(o)?o.step:t.scale.rangeStep;if("number"!=typeof a)throw new Error("Function does not handle non-numeric rangeStep");return a/1.5}}(e),vgChannel:u}),((t={})[s]={value:ke(r.thickness,n.tick.thickness)},t))}},trail:{vgMark:"trail",encodeEntry:function(e){var t=e.width,n=e.height;return ne({},Dc(e,{size:"include",orient:"ignore"}),qc("x",e,Ac(t)),qc("y",e,Ac(n)),Rc("size",e),Ic(e))}}};function Gf(e){return X([Tn,An,In],e.mark)?(n=Xf((t=e).mark,t.encoding),r=Vf(t,{fromPrefix:0<n.length?Yf:""}),0<n.length?[{name:t.getName("pathgroup"),type:"group",from:{facet:{name:Yf+t.requestDataName(hs),data:t.requestDataName(hs),groupby:n}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:r}]:r):Vf(e);var t,n,r}var Yf="faceted_path_";function Vf(e,t){void 0===t&&(t={fromPrefix:""});var n,r,i,o=e.mark,a=ke(e.markDef.clip,(r=(n=e).getScaleComponent("x"),i=n.getScaleComponent("y"),!!(r&&r.get("domainRaw")||i&&i.get("domainRaw")))),u=Wc(e.markDef),s=e.encoding.key,l=function(e){var t=e.encoding,n=e.stack,r=e.mark,i=e.markDef,o=t.order;if(w(o)||!Xt(o)){if((w(o)||Yt(o))&&!n)return Zc(o,{expr:"datum"});if(qn(r)){var a=t["horizontal"===i.orient?"y":"x"];if(Yt(a)){var u=a.sort;return{field:Jo(u)?$t({aggregate:af(e.encoding)?u.op:void 0,field:u.field},{expr:"datum"}):$t(a,{binSuffix:e.stack&&e.stack.impute?"mid":void 0,expr:"datum"}),order:"descending"}}}}}(e),c=Bf[o].postEncodingTransform?Bf[o].postEncodingTransform(e):null;return[ne({name:e.getName("marks"),type:Bf[o].vgMark},a?{clip:!0}:{},u?{style:u}:{},s?{key:{field:s.field}}:{},l?{sort:l}:{},{from:{data:t.fromPrefix+e.requestDataName(hs)},encode:{update:Bf[o].encodeEntry(e)}},c?{transform:c}:{})]}function Xf(i,o){return ce(o).reduce(function(t,e){switch(e){case"x":case"y":case"order":case"href":case"x2":case"y2":case"latitude":case"longitude":case"latitude2":case"longitude2":case"text":case"shape":case"tooltip":return t;case"detail":case"key":var n=o[e];return(w(n)||Yt(n))&&(w(n)?n:[n]).forEach(function(e){e.aggregate||t.push($t(e,{}))}),t;case"size":if("trail"===i)return t;case"color":case"fill":case"stroke":case"opacity":var r=mn(o[e]);return r&&!r.aggregate&&t.push($t(r,{})),t;default:throw new Error("Bug: Channel "+e+" unimplemented for line mark")}},[])}var Qf=function(r){function p(e,t){var n=r.call(this,e)||this;return n.transform=t,n}return h(p,r),p.prototype.clone=function(){return new p(null,pe(this.transform))},p.prototype.producedFields=function(){var e;return(e={})[this.transform.impute]=!0,e},p.prototype.processSequence=function(e){var t=e.start,n=void 0===t?0:t,r=e.stop,i=e.step;return{signal:"sequence("+[n,r].concat(i?[i]:[]).join(",")+")"}},p.makeFromTransform=function(e,t){return new p(e,t)},p.makeFromEncoding=function(e,t){var n=t.encoding,r=n.x,i=n.y;if(Yt(r)&&Yt(i)){var o=r.impute?r:i.impute?i:void 0;if(void 0===o)return;var a=r.impute?i:i.impute?r:void 0,u=o.impute,s=u.method,l=u.value,c=u.frame,f=u.keyvals,d=Xf(t.mark,n);return new p(e,ne({impute:o.field,key:a.field},s?{method:s}:{},void 0!==l?{value:l}:{},c?{frame:c}:{},void 0!==f?{keyvals:f}:{},d.length?{groupby:d}:{}))}return null},p.prototype.hash=function(){return"Impute "+V(this.transform)},p.prototype.assemble=function(){var e,t=this.transform,n=t.impute,r=t.key,i=t.keyvals,o=t.method,a=t.groupby,u=t.value,s=t.frame,l=void 0===s?[null,null]:s,c=ne({type:"impute",field:n,key:r},i?{keyvals:Oo(i)?this.processSequence(i):i}:{},{method:"value"},a?{groupby:a}:{},{value:null});o&&"value"!==o?e=[ne({type:"window",as:["imputed_"+n+"_value"],ops:[o],fields:[n],frame:l,ignorePeers:!1},a?{groupby:a}:{}),{type:"formula",expr:"datum."+n+" === null ? datum.imputed_"+n+"_value : datum."+n,as:n}]:e=[{type:"formula",expr:"datum."+n+" === null ? "+u+" : datum."+n,as:n}];return[c].concat(e)},p}(oa),Kf=function(i){function e(e,t,n){void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=!1);var r=i.call(this,e,t)||this;return r.explicit=e,r.implicit=t,r.parseNothing=n,r}return h(e,i),e.prototype.clone=function(){var e=i.prototype.clone.call(this);return e.parseNothing=this.parseNothing,e},e}(Vu),Jf=function(i){function s(e,t,n){var r=i.call(this,e)||this;return r.transform=t,r.secondary=n,r}return h(s,i),s.prototype.clone=function(){return new s(null,pe(this.transform),this.secondary)},s.make=function(e,t,n,r){var i=t.component.data.sources,o=fd(n.from.data,i);o||(o=new ks(n.from.data),i.push(o));var a=t.getName("lookup_"+r),u=new aa(o,a,"lookup",t.component.data.outputNodeRefCounts);return new s(e,n,(t.component.data.outputNodes[a]=u).getSource())},s.prototype.producedFields=function(){return f(this.transform.from.fields||(this.transform.as instanceof Array?this.transform.as:[this.transform.as]))},s.prototype.hash=function(){return"Lookup "+V({transform:this.transform,secondary:this.secondary})},s.prototype.assemble=function(){var e;if(this.transform.from.fields)e=ne({values:this.transform.from.fields},this.transform.as?{as:this.transform.as instanceof Array?this.transform.as:[this.transform.as]}:{});else{var t=this.transform.as;m(t)||(Je(Be.NO_FIELDS_NEEDS_AS),t="_lookup"),e={as:[t]}}return ne({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},e,this.transform.default?{default:this.transform.default}:{})},s}(oa),Zf=function(r){function e(e,t){var n=r.call(this,e)||this;return n.transform=t,n}return h(e,r),e.prototype.clone=function(){return new e(null,pe(this.transform))},e.prototype.hash=function(){return"SampleTransform "+V(this.transform)},e.prototype.assemble=function(){return{type:"sample",size:this.transform.sample}},e}(oa);function $f(i){var o=0;return function t(e,n){e instanceof ks&&(fs(e.data)||(i.push(n),n={name:null,source:n.name,transform:[]}));if(e instanceof Es&&(e.parent instanceof ks&&!n.source?(n.format=ne({},n.format||{},{parse:e.assembleFormatParse()}),n.transform=n.transform.concat(e.assembleTransforms(!0))):n.transform=n.transform.concat(e.assembleTransforms())),e instanceof ws)return n.name||(n.name="data_"+o++),!n.source||0<n.transform.length?(i.push(n),e.data=n.name):e.data=n.source,void e.assemble().forEach(function(e){return i.push(e)});(e instanceof Lf||e instanceof _u||e instanceof Mf||e instanceof Pf||e instanceof xs||e instanceof Jf||e instanceof Is||e instanceof Uf||e instanceof jf||e instanceof qf||e instanceof Zf)&&n.transform.push(e.assemble()),(e instanceof Rf||e instanceof As||e instanceof Qf||e instanceof Fs)&&(n.transform=n.transform.concat(e.assemble())),e instanceof aa&&(n.source&&0===n.transform.length?e.setSource(n.source):e.parent instanceof aa?e.setSource(n.name):(n.name||(n.name="data_"+o++),e.setSource(n.name),1===e.numChildren()&&(i.push(n),n={name:null,source:n.name,transform:[]})));switch(e.numChildren()){case 0:e instanceof aa&&(!n.source||0<n.transform.length)&&i.push(n);break;case 1:t(e.children[0],n);break;default:n.name||(n.name="data_"+o++);var r=n.name;!n.source||0<n.transform.length?i.push(n):r=n.source,e.children.forEach(function(e){t(e,{name:null,source:r,transform:[]})})}}}function ed(e){nd(e);var t=e.component.layoutSize;t.setWithExplicit("width",rd(e,"width")),t.setWithExplicit("height",rd(e,"height"))}var td=ed;function nd(e){for(var t=0,n=e.children;t<n.length;t++){n[t].parseLayoutSize()}}function rd(e,t){for(var n,r="width"===t?"x":"y",i=e.component.resolve,o=0,a=e.children;o<a.length;o++){var u=(f=a[o]).component.layoutSize.getWithExplicit(t),s=i.scale[r];if("independent"===s&&"range-step"===u.value){n=void 0;break}if(n){if("independent"===s&&n.value!==u.value){n=void 0;break}n=Zu(n,u,t,"")}else n=u}if(n){for(var l=0,c=e.children;l<c.length;l++){var f=c[l];e.renameLayoutSize(f.getName(t),e.getName(t)),f.component.layoutSize.set(t,"merged",!1)}return n}return{explicit:!1,value:void 0}}function id(e,t){var n="width"===t?"x":"y",r=e.config,i=e.getScaleComponent(n);if(i){var o=i.get("type"),a=i.get("range");return gi(o)&&Ho(a)?"range-step":r.view[t]}return e.hasProjection?r.view[t]:"width"===t&&"text"===e.mark?r.scale.textXRangeStep:r.scale.rangeStep||Si.rangeStep}function od(e,t){return qt(e.field)?e.field.repeat in t?ne({},e,{field:t[e.field.repeat]}):void Je(Be.noSuchRepeatedValue(e.field.repeat)):e}function ad(e,t){if(void 0!==(e=od(e,t))){if(e.sort&&Jo(e.sort)){var n=od(e.sort,t);e=ne({},e,n?{sort:n}:{})}return e}}function ud(e,t){if(Yt(e))return(n=ad(e,t))?n:Wt(e)?{condition:e.condition}:void 0;if(Bt(e)){var n;if(n=ad(e.condition,t))return ne({},e,{condition:n});e.condition;return re(e,["condition"])}return e}function sd(e,t){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];if(w(i))n[r]=i.map(function(e){return ud(e,t)}).filter(function(e){return e});else{var o=ud(i,t);o&&(n[r]=o)}}return n}function ld(e,t,n){return $t(t,ne({suffix:"by_"+$t(e)},n||{}))}var cd=function(u){function c(e,t,n,r,i){var o=u.call(this,e,t,n,i,r,e.resolve)||this;o.type="facet",o.child=Od(e.spec,o,o.getName("child"),void 0,r,i,!1),o.children=[o.child];var a=sd(e.facet,r);return o.facet=o.initFacet(a),o}return h(c,u),c.prototype.initFacet=function(e){return df(e,function(e,t,n){return X([fr,dr],n)?void 0===t.field?Je(Be.emptyFieldDef(t,n)):e[n]=gn(t,n):Je(Be.incompatibleChannel(n,"facet")),e},{})},c.prototype.channelHasField=function(e){return!!this.facet[e]},c.prototype.fieldDef=function(e){return this.facet[e]},c.prototype.parseData=function(){this.component.data=dd(this),this.child.parseData()},c.prototype.parseLayoutSize=function(){nd(this)},c.prototype.parseSelection=function(){this.child.parseSelection(),this.component.selection=this.child.component.selection},c.prototype.parseMarkGroup=function(){this.child.parseMarkGroup()},c.prototype.parseAxisAndHeader=function(){this.child.parseAxisAndHeader(),this.parseHeader("column"),this.parseHeader("row"),this.mergeChildAxis("x"),this.mergeChildAxis("y")},c.prototype.parseHeader=function(e){if(this.channelHasField(e)){var t=this.facet[e],n=cn(t,this.config,{allowDisabling:!0});this.child.component.layoutHeaders[e].title&&(n+=" / "+this.child.component.layoutHeaders[e].title,this.child.component.layoutHeaders[e].title=null),this.component.layoutHeaders[e]={title:n,facetFieldDef:t,header:[this.makeHeaderComponent(e,!0)]}}},c.prototype.makeHeaderComponent=function(e,t){var n="row"===e?"height":"width";return{labels:t,sizeSignal:this.child.component.layoutSize.get(n)?this.child.getSizeSignalRef(n):void 0,axes:[]}},c.prototype.mergeChildAxis=function(e){var t,n=this.child;if(n.component.axes[e]){var r=this.component,i=r.layoutHeaders,o=r.resolve;if(o.axis[e]=Yu(o,e),"shared"===o.axis[e])for(var a="x"===e?"column":"row",u=i[a],s=0,l=n.component.axes[e];s<l.length;s++){var c=l[s],f="top"===(t=c.get("orient"))||"left"===t?"header":"footer";u[f]=u[f]||[this.makeHeaderComponent(a,!1)];var d=Go(c,"main",this.config,{header:!0});u[f][0].axes.push(d),c.mainExtracted=!0}}},c.prototype.assembleSelectionTopLevelSignals=function(e){return this.child.assembleSelectionTopLevelSignals(e)},c.prototype.assembleSelectionSignals=function(){return this.child.assembleSelectionSignals(),[]},c.prototype.assembleSelectionData=function(e){return this.child.assembleSelectionData(e)},c.prototype.getHeaderLayoutMixins=function(){var a=this,u={};return["row","column"].forEach(function(o){["header","footer"].forEach(function(e){var t=a.component.layoutHeaders[o],n=t[e];if(n&&n[0]){var r="row"===o?"height":"width",i="header"===e?"headerBand":"footerBand";a.child.component.layoutSize.get(r)||(u[i]=u[i]||{},u[i][o]=.5),t.title&&(u.offset=u.offset||{},u.offset["row"===o?"rowTitle":"columnTitle"]=10)}})}),u},c.prototype.assembleDefaultLayout=function(){var e=this.channelHasField("column")?this.columnDistinctSignal():1;return ne({},this.getHeaderLayoutMixins(),{columns:e,bounds:"full",align:"all"})},c.prototype.assembleLayoutSignals=function(){return this.child.assembleLayoutSignals()},c.prototype.columnDistinctSignal=function(){if(!(this.parent&&this.parent instanceof c))return{signal:"length(data('"+this.getName("column_domain")+"'))"}},c.prototype.assembleGroup=function(e){return this.parent&&this.parent instanceof c?ne({},this.channelHasField("column")?{encode:{update:{columns:{field:$t(this.facet.column,{prefix:"distinct"})}}}}:{},u.prototype.assembleGroup.call(this,e)):u.prototype.assembleGroup.call(this,e)},c.prototype.getCardinalityAggregateForChild=function(){var e=[],t=[],n=[];if(this.child instanceof c){if(this.child.channelHasField("column")){var r=$t(this.child.facet.column);e.push(r),t.push("distinct"),n.push("distinct_"+r)}}else for(var i=0,o=["x","y"];i<o.length;i++){var a=o[i],u=this.child.component.scales[a];if(u&&!u.merged){var s=u.get("type"),l=u.get("range");if(gi(s)&&Ho(l))(r=Vs(Xs(this.child,a)))?(e.push(r),t.push("distinct"),n.push("distinct_"+r)):Je("Unknown field for ${channel}.  Cannot calculate view size.")}}return{fields:e,ops:t,as:n}},c.prototype.assembleFacet=function(){var a=this,e=this.component.data.facetRoot,t=e.name,n=e.data,r=this.facet,u=r.row,s=r.column,i=this.getCardinalityAggregateForChild(),l=i.fields,c=i.ops,f=i.as,d=[];["row","column"].forEach(function(e){var t=a.facet[e];if(t){d.push($t(t));var n=t.sort;if(Jo(n)){var r=n.field,i=n.op,o=ld(t,n);u&&s?(l.push(o),c.push("max")):(l.push(r),c.push(i)),f.push(o)}else if(w(n)){o=Tu(t,e);l.push(o),c.push("max"),f.push(o)}}});var o=!!u&&!!s;return ne({name:t,data:n,groupby:d},o||l.length?{aggregate:ne({},o?{cross:o}:{},l.length?{fields:l,ops:c,as:f}:{})}:{})},c.prototype.headerSortFields=function(e){var t=this.facet[e];return t?Jo(t.sort)?[ld(t,t.sort,{expr:"datum"})]:w(t.sort)?[Tu(t,e,{expr:"datum"})]:[$t(t,{expr:"datum"})]:[]},c.prototype.headerSortOrder=function(e){var t=this.facet[e];if(t){var n=t.sort;return[(Jo(n)?n.order:!w(n)&&n)||"ascending"]}return[]},c.prototype.assembleMarks=function(){var t,e,n,r=this.child,i=this.component.data.facetRoot,o=(t=i,n=$f(e=[]),t.children.forEach(function(e){return n(e,{source:t.name,name:null,transform:[]})}),e),a=r.assembleLayoutSize(),u=r.assembleTitle(),s=r.assembleGroupStyle();return[ne({name:this.getName("cell"),type:"group"},u?{title:u}:{},s?{style:s}:{},{from:{facet:this.assembleFacet()},sort:{field:this.headerSortFields("row").concat(this.headerSortFields("column")),order:this.headerSortOrder("row").concat(this.headerSortOrder("column"))}},0<o.length?{data:o}:{},a?{encode:{update:a}}:{},r.assembleGroup(function(e,t){if(e.component.selection&&ce(e.component.selection).length){var n=v(e.getName("cell"));t.unshift({name:"facet",value:{},on:[{events:Ii("mousemove","scope"),update:"isTuple(facet) ? facet : group("+n+").datum"}]})}return t}(this,[])))]},c.prototype.getMapping=function(){return this.facet},c}(Cl);function fd(e,t){for(var n=0,r=t;n<r.length;n++){var i=r[n],o=i.data;if(ds(e)&&ds(o)){var a=e.values,u=o.values;if(W(a,u))return i}else if(fs(e)&&fs(o)){if(e.url===o.url)return i}else if(ps(e)&&ps(o)&&e.name===o.name)return i}return null}function dd(e){var t=function(e,t){if(!e.data&&e.parent)return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main;var n=fd(e.data,t);if(n)return n.data.format=$({},e.data.format,n.data.format),n;var r=new ks(e.data);return t.push(r),r}(e,e.component.data.sources),n=e.component.data,r=n.outputNodes,i=n.outputNodeRefCounts,o=e.parent?e.parent.component.data.ancestorParse.clone():new Kf;e.data&&e.data.format&&null===e.data.format.parse&&(o.parseNothing=!0),t=Es.makeExplicit(t,e,o)||t,oc(e)&&(bl(e)||El(e))&&(t=new qf(t));var u,s,l,c,a=e.parent&&El(e.parent);(bl(e)||xl(e))&&a&&(t=Rf.makeFromEncoding(t,e)||t),0<e.transforms.length&&(u=t,l=o,c=0,(s=e).transforms.forEach(function(e){var t,n,r=void 0;if(zo(e))n=u=new _u(u,e),r="derived";else if(No(e))n=u=Es.makeImplicitFromFilterTransform(u,e,l)||u,u=new Lf(u,s,e.filter);else if(Fo(e))n=u=Rf.makeFromTransform(u,e,s),r="number";else if(Ro(e))n=u=As.makeFromTransform(u,e),r="date",void 0===l.getWithExplicit(e.field).value&&(u=new Es(u,((t={})[e.field]=r,t)),l.set(e.field,r,!1));else if(Lo(e))n=u=xs.makeFromTransform(u,e),r="number",oc(s)&&(u=new qf(u));else if(Ao(e))n=u=Jf.make(u,s,e,c++),r="derived";else if(To(e))n=u=new Is(u,e),r="number";else if(jo(e))n=u=Fs.makeFromTransform(u,e),r="derived";else if(Uo(e))n=u=new Uf(u,e),r="derived";else if(Do(e))n=u=new jf(u,e),r="derived";else if(_o(e))u=new Zf(u,e);else{if(!Io(e))return void Je(Be.invalidTransformIgnored(e));n=u=Qf.makeFromTransform(u,e),r="derived"}if(n&&void 0!==r)for(var i=0,o=ce(n.producedFields());i<o.length;i++){var a=o[i];l.set(a,r,!1)}}),t=u),t=Es.makeImplicitFromEncoding(t,e,o)||t,bl(e)&&(t=Pf.parseAll(t,e),t=Mf.parseAll(t,e)),(bl(e)||xl(e))&&(a||(t=Rf.makeFromEncoding(t,e)||t),t=As.makeFromEncoding(t,e)||t,t=_u.parseAllForSortIndex(t,e));var f=e.getName(ms),d=new aa(t,f,ms,i);if(t=r[f]=d,bl(e)){var p=xs.makeFromEncoding(t,e);p&&(t=p,oc(e)&&(t=new qf(t))),t=Qf.makeFromEncoding(t,e)||t,t=Fs.makeFromEncoding(t,e)||t}var h=e.getName(hs),m=new aa(t,h,hs,i);t=r[h]=m;var g=null;if(xl(e)){var v=e.getName("facet");t=function(e,t){var n=t.row,r=t.column;if(n&&r){for(var i=null,o=0,a=[n,r];o<a.length;o++){var u=a[o];if(Jo(u.sort)){var s=u.sort,l=s.field,c=s.op;e=i=new Is(e,{window:[{op:c,field:l,as:ld(u,u.sort,{forAs:!0})}],groupby:[$t(u)],frame:[null,null]})}}return i}return null}(t=_u.parseAllForSortIndex(t,e),e.facet)||t,g=new ws(t,e,v,m.getSource()),t=r[v]=g}return ne({},e.component.data,{outputNodes:r,outputNodeRefCounts:i,raw:d,main:m,facetRoot:g,ancestorParse:o})}var pd=function(a){function e(e,t,n,r,i,o){return a.call(this,e,t,n,r,i,o)||this}return h(e,a),e.prototype.parseData=function(){this.component.data=dd(this),this.children.forEach(function(e){e.parseData()})},e.prototype.parseSelection=function(){var n=this;this.component.selection={};for(var e=function(t){t.parseSelection(),ce(t.component.selection).forEach(function(e){n.component.selection[e]=t.component.selection[e]})},t=0,r=this.children;t<r.length;t++){e(r[t])}},e.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},e.prototype.parseAxisAndHeader=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseAxisAndHeader()}},e.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},e.prototype.assembleSelectionSignals=function(){return this.children.forEach(function(e){return e.assembleSelectionSignals()}),[]},e.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Lu(this))},e.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},e.prototype.assembleMarks=function(){return this.children.map(function(e){var t=e.assembleTitle(),n=e.assembleGroupStyle(),r=e.assembleLayoutSize();return ne({type:"group",name:e.getName("group")},t?{title:t}:{},n?{style:n}:{},r?{encode:{update:r}}:{},e.assembleGroup())})},e}(kl),hd=function(a){function e(e,t,n,r,i){var o=a.call(this,e,t,n,i,r,e.resolve)||this;return o.type="concat",e.resolve&&e.resolve.axis&&("shared"===e.resolve.axis.x||"shared"===e.resolve.axis.y)&&Je(Be.CONCAT_CANNOT_SHARE_AXIS),o.isVConcat=vo(e),o.children=(vo(e)?e.vconcat:e.hconcat).map(function(e,t){return Od(e,o,o.getName("concat_"+t),void 0,r,i,!1)}),o}return h(e,a),e.prototype.parseLayoutSize=function(){!function(e){nd(e);var t=e.component.layoutSize,n=e.isVConcat?"width":"height";t.setWithExplicit(n,rd(e,n))}(this)},e.prototype.parseAxisGroup=function(){return null},e.prototype.assembleDefaultLayout=function(){return ne({},this.isVConcat?{columns:1}:{},{bounds:"full",align:"each"})},e}(pd);var md=function(i){function e(e,t,n){void 0===e&&(e={}),void 0===t&&(t={}),void 0===n&&(n=!1);var r=i.call(this)||this;return r.explicit=e,r.implicit=t,r.mainExtracted=n,r}return h(e,i),e.prototype.clone=function(){return new e(pe(this.explicit),pe(this.implicit),this.mainExtracted)},e.prototype.hasAxisPart=function(e){return"axis"===e||("grid"===e||"title"===e?!!this.get(e):!(!1===(t=this.get(e))||null===t));var t},e}(Vu);function gd(e,t,n,r,i){void 0===r&&(r="");for(var o=0,a=("band"===i?["axisBand"]:[]).concat(["x"===n?"axisX":"axisY","axis"+r.substr(0,1).toUpperCase()+r.substr(1),"axis"]);o<a.length;o++){var u=a[o];if(t[u]&&void 0!==t[u][e])return t[u][e]}}function vd(e){switch(e){case rr:return"bottom";case ir:return"left"}throw new Error(Be.INVALID_CHANNEL_FOR_AXIS)}function yd(n){return jr.reduce(function(e,t){return n.component.scales[t]&&n.axis(t)&&(e[t]=[function(i,o){var a=o.axis(i),u=new md;Ye.forEach(function(e){var t=function(e,t,n,r){var i=r.fieldDef(n),o=function(e,t,n,r){if(void 0!==t.labelAngle)return(t.labelAngle%360+360)%360;var i=gd("labelAngle",e.config,n,vd(n),e.getScaleComponent(n).get("type"));return void 0!==i?(i%360+360)%360:n===rr&&X([Lt,It],r.type)?270:void 0}(r,t,n,i);switch(e){case"scale":return r.scaleName(n);case"gridScale":return function(e,t){var n="x"===t?"y":"x";if(e.getScaleComponent(n))return e.scaleName(n)}(r,n);case"format":return Vc(i,t.format,r.config);case"grid":if(Kr(r.fieldDef(n).bin))return!1;var a=r.getScaleComponent(n).get("type");return ke(t.grid,(y=i,!gi(a)&&!Qr(y.bin)));case"labelAlign":return ke(t.labelAlign,function(e,t){if(void 0!==e)return e=(e%360+360)%360,"top"===t||"bottom"===t?e%180==0?"center":0<e&&e<180?"top"===t?"right":"left":"top"===t?"left":"right":(e+90)%180==0?"center":90<=e&&e<270?"left"===t?"left":"right":"left"===t?"right":"left"}(o,vd(n)));case"labelAngle":return o;case"labelBaseline":return ke(t.labelBaseline,function(e,t){if(void 0!==e)return"top"===t||"bottom"===t?e<=45||315<=e?"top"===t?"bottom":"top":135<=e&&e<=225?"top"===t?"top":"bottom":"middle":e<=45||315<=e||135<=e&&e<=225?"middle":45<=e&&e<=135?"left"===t?"top":"bottom":"left"===t?"bottom":"top"}(o,vd(n)));case"labelFlush":return m=i,g=n,void 0!==(v=t).labelFlush?v.labelFlush:!("x"!==g||!X(["quantitative","temporal"],m.type))||void 0;case"labelOverlap":var a=r.getScaleComponent(n).get("type");return d=i,h=a,void 0!==(p=t).labelOverlap?p.labelOverlap:"nominal"!==d.type?"log"!==h||"greedy":void 0;case"orient":return ke(t.orient,vd(n));case"tickCount":var a=r.getScaleComponent(n).get("type"),u=r.scaleName(n),s="x"===n?"width":"y"===n?"height":void 0,l=s?r.getSizeSignalRef(s):void 0;return ke(t.tickCount,function(e,t,n,r,i,o){if(!gi(n)&&"log"!==n&&!X(["month","hours","day","quarter"],t.timeUnit))return o.tickStep?{signal:"(domain('"+i+"')[1] - domain('"+i+"')[0]) / "+o.tickStep+" + 1"}:Qr(t.bin)?{signal:"ceil("+r.signal+"/20)"}:{signal:"ceil("+r.signal+"/40)"}}(0,i,a,l,u,t));case"title":var c="x"===n?"x2":"y2",f=r.fieldDef(c);return ke(t.title,wd(r,n),$c([Ht(i)],f?[Ht(f)]:[]));case"values":return function(e,t,n,r){var i=e.values;if(i)return kn(n,i);if(n.type===Ft){if(Qr(n.bin)){var o=t.scaleDomain(r);if(o&&"unaggregated"!==o&&!Ei(o))return i;var a=t.getName(Xr(n.bin)+"_"+n.field+"_bins");return{signal:"sequence("+a+".start, "+a+".stop + "+a+".step, "+a+".step)"}}if(e.tickStep){var u=t.scaleName(r),s=e.tickStep;return{signal:"sequence(domain('"+u+"')[0], domain('"+u+"')[1] + "+s+", "+s+")"}}}}(t,r,i,n)}var d,p,h;var m,g,v;var y;return He(e)?t[e]:void 0}(e,a,i,o);if(void 0!==t){var n=function(e,t,n,r,i){switch(t){case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(e===wd(r,i))return!0}return e===n[t]}(t,e,a,o,i),r=gd(e,o.config,i,u.get("orient"),o.getScaleComponent(i).get("type"));n||void 0===r?u.set(e,t,n):"grid"===e&&r&&u.set(e,r,!1)}});var s=a.encoding||{},e=Ue.reduce(function(e,t){if(!u.hasAxisPart(t))return e;var n=rf(s[t]||{},o),r="labels"===t?function(e,t,n,r){var i=e.fieldDef(t)||("x"===t?e.fieldDef("x2"):"y"===t?e.fieldDef("y2"):void 0),o=e.axis(t),a=e.config,u={};if(wn(i)){var s=e.getScaleComponent(t).get("type")===$r.UTC,l=Jc("datum.value",i.timeUnit,o.format,a.axis.shortTimeLabels,null,s);l&&(u.text={signal:l})}return u=ne({},u,n),0===ce(u).length?void 0:u}(o,i,n,u.get("orient")):n;return void 0!==r&&0<ce(r).length&&(e[t]={update:r}),e},{});0<ce(e).length&&u.set("encode",e,!!a.encoding||void 0!==a.labelAngle);return u}(t,n)]),e},{})}var bd={bottom:"top",top:"bottom",left:"right",right:"left"};function xd(e,t){if(!e)return t.map(function(e){return e.clone()});if(e.length===t.length){for(var n=e.length,r=0;r<n;r++){var i=e[r],o=t[r];if(!!i!=!!o)return;if(i&&o){var a=i.getWithExplicit("orient"),u=o.getWithExplicit("orient");if(a.explicit&&u.explicit&&a.value!==u.value)return;e[r]=Sd(i,o)}}return e}}function Sd(t,r){for(var e=function(n){var e=Zu(t.getWithExplicit(n),r.getWithExplicit(n),n,"axis",function(e,t){switch(n){case"title":return tf(e,t);case"gridScale":return{explicit:e.explicit,value:ke(e.value,t.value)}}return Ju(e,t,n,"axis")});t.setWithExplicit(n,e)},n=0,i=Ye;n<i.length;n++){e(i[n])}return t}function wd(e,t){var n="x"===t?"x2":"y2",r=e.fieldDef(t),i=e.fieldDef(n),o=r?r.title:void 0,a=i?i.title:void 0;return o&&a?ef(o,a):o||(a||(void 0!==o?o:void 0!==a?a:void 0))}function Ed(e,t,n){var r,i,o,a=Wn(e)?ne({},e):{type:e},u=a.orient||Bc("orient",a,n);return a.orient=function(e,t,n){switch(e){case Dn:case Un:case Pn:case zn:case Rn:return}var r=t.x,i=t.y,o=t.x2,a=t.y2;switch(e){case _n:if(Yt(r)&&Kr(r.bin))return"vertical";if(Yt(i)&&Kr(i.bin))return"horizontal";if(a||o){if(n)return n;if(!o&&Yt(r)&&r.type===Ft&&!Qr(r.bin))return"horizontal";if(!a&&Yt(i)&&i.type===Ft&&!Qr(i.bin))return"vertical"}case Ln:if(o&&a)return;case An:if(a)return Yt(i)&&Kr(i.bin)?"horizontal":"vertical";if(o)return Yt(r)&&Kr(r.bin)?"vertical":"horizontal";if(e===Ln){if(t.x&&!t.y)return"vertical";if(t.y&&!t.x)return"horizontal"}case Tn:case Fn:var u=Yt(t.x)&&tn(t.x),s=Yt(t.y)&&tn(t.y);if(u&&!s)return"tick"!==e?"horizontal":"vertical";if(!u&&s)return"tick"!==e?"vertical":"horizontal";if(u&&s){var l=t.x,c=t.y,f=l.type===Rt,d=c.type===Rt;return f&&!d?"tick"!==e?"vertical":"horizontal":!f&&d?"tick"!==e?"horizontal":"vertical":!l.aggregate&&c.aggregate?"tick"!==e?"vertical":"horizontal":l.aggregate&&!c.aggregate?"tick"!==e?"horizontal":"vertical":n||"vertical"}return n||void 0}return"vertical"}(a.type,t,u),void 0!==u&&u!==a.orient&&Je(Be.orientOverridden(a.orient,u)),void 0===ke(a.opacity,Bc("opacity",a,n))&&(a.opacity=function(e,t){if(X([Dn,Fn,Un,Pn],e)&&!af(t))return.7;return}(a.type,t)),void 0===a.filled&&(a.filled=(i=Bc("filled",r=a,n),o=r.type,ke(i,o!==Dn&&o!==Tn&&o!==Ln))),void 0===(a.cursor||Bc("cursor",a,n))&&(a.cursor=function(e,t,n){if(t.href||e.href||Bc("href",e,n))return"pointer";return e.cursor}(a,t,n)),a}var kd=function(c){function e(e,t,n,r,i,o,a){void 0===r&&(r={});var u=c.call(this,e,t,n,o,i,void 0)||this;u.fit=a,u.type="unit",u.specifiedScales={},u.specifiedAxes={},u.specifiedLegends={},u.specifiedProjection={},u.selection={},u.children=[],u.initSize(ne({},r,e.width?{width:e.width}:{},e.height?{height:e.height}:{}));var s=Wn(e.mark)?e.mark.type:e.mark,l=u.encoding=sf(sd(e.encoding||{},i),s);return u.markDef=Ed(e.mark,l,o),u.stack=ro(s,l,u.config.stack),u.specifiedScales=u.initScales(s,l),u.specifiedAxes=u.initAxes(l),u.specifiedLegends=u.initLegend(l),u.specifiedProjection=e.projection,u.selection=e.selection,u}return h(e,c),Object.defineProperty(e.prototype,"hasProjection",{get:function(){var t=this.encoding,e=this.mark===jn,n=t&&Nr.some(function(e){return Yt(t[e])});return e||n},enumerable:!0,configurable:!0}),e.prototype.scaleDomain=function(e){var t=this.specifiedScales[e];return t?t.domain:void 0},e.prototype.axis=function(e){return this.specifiedAxes[e]},e.prototype.legend=function(e){return this.specifiedLegends[e]},e.prototype.initScales=function(e,o){return Hr.reduce(function(e,t){var n,r,i=o[t];return Yt(i)?r=(n=i).scale:Bt(i)?(n=i.condition,r=i.condition.scale):"x"===t?n=mn(o.x2):"y"===t&&(n=mn(o.y2)),n&&(e[t]=r||{}),e},{})},e.prototype.initAxes=function(i){return[rr,ir].reduce(function(e,t){var n=i[t];if(Yt(n)||t===rr&&Yt(i.x2)||t===ir&&Yt(i.y2)){var r=Yt(n)?n.axis:null;null!==r&&(e[t]=ne({},r))}return e},{})},e.prototype.initLegend=function(i){return Pr.reduce(function(e,t){var n=i[t];if(n){var r=Yt(n)?n.legend:Bt(n)?n.condition.legend:null;null!==r&&!1!==r&&(e[t]=ne({},r))}return e},{})},e.prototype.parseData=function(){this.component.data=dd(this)},e.prototype.parseLayoutSize=function(){!function(e){var t=e.component.layoutSize;if(!t.explicit.width){var n=id(e,"width");t.set("width",n,!1)}if(!t.explicit.height){var r=id(e,"height");t.set("height",r,!1)}}(this)},e.prototype.parseSelection=function(){this.component.selection=function(o,a){var u={},s=o.config.selection,e=function(e){if(!a.hasOwnProperty(e))return"continue";var t=a[e],n=s[t.type];for(var r in n)"encodings"===r&&t.fields||"fields"===r&&t.encodings||("mark"===r&&(t[r]=ne({},n[r],t[r])),void 0!==t[r]&&!0!==t[r]||(t[r]=n[r]||t[r]));e=me(e);var i=u[e]=ne({},t,{name:e,events:m(t.on)?Ii(t.on,"scope"):t.on});Ql(i,function(e){e.parse&&e.parse(o,t,i)})};for(var t in a)e(t);return u}(this,this.selection)},e.prototype.parseMarkGroup=function(){this.component.mark=Gf(this)},e.prototype.parseAxisAndHeader=function(){this.component.axes=yd(this)},e.prototype.assembleSelectionTopLevelSignals=function(e){return o=e,a=!1,nc(i=this,function(t,e){var n=t.name,r=v(n+Kl);o.filter(function(e){return e.name===n}).length||o.push({name:t.name,update:$l+"("+r+("global"===t.resolve?")":", "+v(t.resolve)+")")}),a=!0,e.topLevelSignals&&(o=e.topLevelSignals(i,t,o)),Ql(t,function(e){e.topLevelSignals&&(o=e.topLevelSignals(i,t,o))})}),a&&(o.filter(function(e){return"unit"===e.name}).length||o.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})),o;var i,o,a},e.prototype.assembleSelectionSignals=function(){return o=[],nc(i=this,function(t,e){var n=t.name,r=e.modifyExpr(i,t);o.push.apply(o,e.signals(i,t)),Ql(t,function(e){e.signals&&(o=e.signals(i,t,o)),e.modifyExpr&&(r=e.modifyExpr(i,t,r))}),o.push({name:n+"_modify",on:[{events:{signal:n+Jl},update:"modify("+v(t.name+Kl)+", "+r+")"}]})}),o;var i,o},e.prototype.assembleSelectionData=function(e){return n=e,nc(this,function(t){n.filter(function(e){return e.name===t.name+Kl}).length||n.push({name:t.name+Kl})}),n;var n},e.prototype.assembleLayout=function(){return null},e.prototype.assembleLayoutSignals=function(){return Lu(this)},e.prototype.assembleMarks=function(){var e=this.component.mark||[];return this.parent&&El(this.parent)||(e=ec(this,e)),e.map(this.correctDataNames)},e.prototype.assembleLayoutSize=function(){return{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")}},e.prototype.getMapping=function(){return this.encoding},e.prototype.toSpec=function(e,t){var n,r=pe(this.encoding);return n={mark:this.markDef,encoding:r},e||(n.config=pe(this.config)),t||(n.data=pe(this.data)),n},Object.defineProperty(e.prototype,"mark",{get:function(){return this.markDef.type},enumerable:!0,configurable:!0}),e.prototype.channelHasField=function(e){return of(this.encoding,e)},e.prototype.fieldDef=function(e){return mn(this.encoding[e])},e}(Cl),Cd=function(l){function c(e,t,n,r,i,o,a){var u=l.call(this,e,t,n,o,i,e.resolve)||this;u.type="layer";var s=ne({},r,e.width?{width:e.width}:{},e.height?{height:e.height}:{});return u.initSize(s),u.children=e.layer.map(function(e,t){if(ho(e))return new c(e,u,u.getName("layer_"+t),s,i,o,a);if(po(e))return new kd(e,u,u.getName("layer_"+t),s,i,o,a);throw new Error(Be.INVALID_SPEC)}),u}return h(c,l),c.prototype.parseData=function(){this.component.data=dd(this);for(var e=0,t=this.children;e<t.length;e++){t[e].parseData()}},c.prototype.parseLayoutSize=function(){ed(this)},c.prototype.parseSelection=function(){var n=this;this.component.selection={};for(var e=function(t){t.parseSelection(),ce(t.component.selection).forEach(function(e){n.component.selection[e]=t.component.selection[e]})},t=0,r=this.children;t<r.length;t++){e(r[t])}},c.prototype.parseMarkGroup=function(){for(var e=0,t=this.children;e<t.length;e++){t[e].parseMarkGroup()}},c.prototype.parseAxisAndHeader=function(){!function(e){for(var t=e.component,n=t.axes,r=t.resolve,i={top:0,bottom:0,right:0,left:0},o=0,a=e.children;o<a.length;o++){(h=a[o]).parseAxisAndHeader();for(var u=0,s=ce(h.component.axes);u<s.length;u++){var l=s[u];r.axis[l]=Yu(e.component.resolve,l),"shared"===r.axis[l]&&(n[l]=xd(n[l],h.component.axes[l]),n[l]||(r.axis[l]="independent",delete n[l]))}}for(var c=0,f=[rr,ir];c<f.length;c++){l=f[c];for(var d=0,p=e.children;d<p.length;d++){var h;if((h=p[d]).component.axes[l]){if("independent"===r.axis[l]){n[l]=(n[l]||[]).concat(h.component.axes[l]);for(var m=0,g=h.component.axes[l];m<g.length;m++){var v=g[m],y=v.getWithExplicit("orient"),b=y.value,x=y.explicit;if(0<i[b]&&!x){var S=bd[b];i[b]>i[S]&&v.set("orient",S,!1)}i[b]++}}delete h.component.axes[l]}}}}(this)},c.prototype.assembleSelectionTopLevelSignals=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionTopLevelSignals(e)},e)},c.prototype.assembleSelectionSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleSelectionSignals())},[])},c.prototype.assembleLayoutSignals=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLayoutSignals())},Lu(this))},c.prototype.assembleSelectionData=function(e){return this.children.reduce(function(e,t){return t.assembleSelectionData(e)},e)},c.prototype.assembleTitle=function(){var e=l.prototype.assembleTitle.call(this);if(e)return e;for(var t=0,n=this.children;t<n.length;t++){if(e=n[t].assembleTitle())return e}},c.prototype.assembleLayout=function(){return null},c.prototype.assembleMarks=function(){return function(e,t){for(var n=0,r=e.children;n<r.length;n++){var i=r[n];bl(i)&&(t=ec(i,t))}return t}(this,Z(this.children.map(function(e){return e.assembleMarks()})))},c.prototype.assembleLegends=function(){return this.children.reduce(function(e,t){return e.concat(t.assembleLegends())},ss(this))},c}(kl),Nd=function(a){function e(e,t,n,r,i){var o=a.call(this,e,t,n,i,r,e.resolve)||this;return o.type="repeat",e.resolve&&e.resolve.axis&&("shared"===e.resolve.axis.x||"shared"===e.resolve.axis.y)&&Je(Be.REPEAT_CANNOT_SHARE_AXIS),o.repeat=e.repeat,o.children=o._initChildren(e,o.repeat,r,i),o}return h(e,a),e.prototype._initChildren=function(e,t,n,r){for(var i=[],o=t.row||[n?n.row:null],a=t.column||[n?n.column:null],u=0,s=o;u<s.length;u++)for(var l=s[u],c=0,f=a;c<f.length;c++){var d=f[c],p=(l?"_"+l:"")+(d?"_"+d:""),h={row:l,column:d};i.push(Od(e.spec,this,this.getName("child"+p),void 0,h,r,!1))}return i},e.prototype.parseLayoutSize=function(){td(this)},e.prototype.assembleDefaultLayout=function(){return{columns:this.repeat&&this.repeat.column?this.repeat.column.length:1,bounds:"full",align:"all"}},e}(pd);function Od(e,t,n,r,i,o,a){if(fo(e))return new cd(e,t,n,i,o);if(ho(e))return new Cd(e,t,n,r,i,o,a);if(po(e))return new kd(e,t,n,r,i,o,a);if(mo(e))return new Nd(e,t,n,i,o);if(go(e))return new hd(e,t,n,i,o);throw new Error(Be.INVALID_SPEC)}function Ad(e,t){if(fo(e)||mo(e))return r=t,i=(n=e).spec,o=re(n,["spec"]),ne({},o,{spec:Ad(i,r)});var n,r,i,o,a,u,s,l,c,f,d,p,h,m,g,v;if(ho(e))return u=t,s=(a=e).layer,l=re(a,["layer"]),ne({},l,{layer:s.map(function(e){return Ad(e,u)})});if(po(e))return function(e,t){{if(e.encoding){var n=e.encoding,r=e.transform,i=re(e,["encoding","transform"]),o=uf(n,t),a=o.bins,u=o.timeUnits,s=o.aggregate,l=o.groupby,c=o.encoding;return ne({transform:(r||[]).concat(a,u,s.length?[{aggregate:s,groupby:l}]:[])},i,{encoding:c})}return e}}(e,t);if(vo(e))return f=t,d=(c=e).vconcat,p=re(c,["vconcat"]),ne({},p,{vconcat:d.map(function(e){return Ad(e,f)})});if(yo(e))return m=t,g=(h=e).hconcat,v=re(h,["hconcat"]),ne({},v,{hconcat:g.map(function(e){return Ad(e,m)})});throw new Error(Be.INVALID_SPEC)}var _d={text:["text"],line:["x","y"],trail:["x","y"],area:["x","y"]},Td={bar:f(["row","column","x","y","size","color","fill","stroke","detail"]),line:f(["row","column","x","y","color","fill","stroke","color","detail"]),trail:f(["row","column","x","y","color","fill","stroke","color","detail","size"]),area:f(["row","column","x","y","color","fill","stroke","detail"]),tick:f(["row","column","x","y","color","fill","stroke","detail"]),circle:f(["row","column","x","y","color","fill","stroke","size","detail"]),square:f(["row","column","x","y","color","fill","stroke","size","detail"]),point:f(["row","column","x","y","color","fill","stroke","size","detail","shape"]),geoshape:f(["row","column","color","fill","stroke","detail","shape"]),text:f(["row","column","size","color","fill","stroke","text"])};var Dd=Object.freeze({DEFAULT_REQUIRED_CHANNEL_MAP:_d,DEFAULT_SUPPORTED_CHANNEL_TYPE:Td,getEncodingMappingError:function(e,t,n){void 0===t&&(t=_d),void 0===n&&(n=Td);var r=Wn(e.mark)?e.mark.type:e.mark,i=e.encoding,o=t[r],a=n[r];for(var u in o)if(!(o[u]in i))return'Missing encoding channel "'+o[u]+'" for mark "'+r+'"';for(var s in i)if(!a[s])return'Encoding channel "'+s+'" is not supported by mark type "'+r+'"';return r!==_n||i.x||i.y?null:"Missing both x and y for bar"}}),zd="3.0.0-rc8";e.aggregate=je,e.axis=Xe,e.bin=ti,e.channel=Vr,e.compositeMark=Ff,e.config=ul,e.data=gs,e.datetime=ot,e.encoding=pf,e.facet=lt,e.fieldDef=On,e.header=Ko,e.legend=Gu,e.mark=nr,e.scale=Fi,e.sort=ia,e.spec=So,e.stack=io,e.timeUnit=Dt,e.transform=Mo,e.type=Pt,e.util=Oe,e.validate=Dd,e.version=zd,e.compile=function(e,t){var n,r,i,o;void 0===t&&(t={}),t.logger&&(n=t.logger,Ke=n),t.fieldTitle&&sn(t.fieldTitle);try{var a=tl($({},t.config,e.config)),u=oo(e,a),s=function(e,t,n){void 0===n&&(n=!0);var r=ne({type:"pad"},Eo(t),Eo(e));return"fit"===r.type&&(n||(Je(Be.FIT_NON_SINGLE),r.type="pad")),r}(e.autosize,a.autosize,ho(u)||po(u)),l=Od(u,null,"",void 0,void 0,a,"fit"===s.type);return l.parse(),function(e){Ss(e.sources);for(var t=0,n=0,r=0;r<Ls&&Ws(e);r++)t++;for(e.sources.map(js),r=0;r<Ls&&Ws(e);r++)n++;Ss(e.sources),Math.max(t,n)===Ls&&Je("Maximum optimization runs("+Ls+") reached.")}(l.component.data),function(e,t,n,r){void 0===n&&(n={});var i=e.config?ol(e.config):void 0,o=[].concat(e.assembleSelectionData([]),function(e,t){var n=[],r=$f(n),i=0;e.sources.forEach(function(e){e.hasName()||(e.dataName="source_"+i++);var t=e.assemble();r(e,t)}),n.forEach(function(e){0===e.transform.length&&delete e.transform});for(var o=0,a=0;a<n.length;a++)0!==((h=n[a]).transform||[]).length||h.source||n.splice(o++,0,n.splice(a,1)[0]);for(var u=0,s=n;u<s.length;u++)for(var l=0,c=(h=s[u]).transform||[];l<c.length;l++){var f=c[l];"lookup"===f.type&&(f.from=e.outputNodes[f.from].getSource())}for(var d=0,p=n;d<p.length;d++){var h;(h=p[d]).name in t&&(h.values=t[h.name])}return n}(e.component.data,n)),a=e.assembleProjections(),u=e.assembleTitle(),s=e.assembleGroupStyle(),l=e.assembleLayoutSignals();return l=l.filter(function(e){return"width"!==e.name&&"height"!==e.name||void 0===e.value||(t[e.name]=+e.value,!1)}),{spec:ne({$schema:"https://vega.github.io/schema/vega/v4.json"},e.description?{description:e.description}:{},t,u?{title:u}:{},s?{style:s}:{},{data:o},0<a.length?{projections:a}:{},e.assembleGroup(l.concat(e.assembleSelectionTopLevelSignals([]))),i?{config:i}:{},r?{usermeta:r}:{})}}(l,(r=e,i=a,ne({autosize:1===ce(o=s).length&&o.type?o.type:o},Co(i),Co(r))),e.datasets,e.usermeta)}finally{t.logger&&(Ke=Qe),t.fieldTitle&&ln()}},e.extractTransforms=Ad,Object.defineProperty(e,"__esModule",{value:!0})});